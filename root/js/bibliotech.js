window.FileReader&&"formNoValidate"in document.createElement("input")?$(document).ready(function(){"use strict";new Date;$.event.props.push("dataTransfer");var a=io({reconnection:!0}),b=new ColorThief,c={i:function(a){if(!a.id)return m();for(var b in a)this[b]=a[b];this.picture&&this.link&&($(".picture").html($("<img>").attr("src",this.picture).css({width:32,height:32,cursor:"pointer",visibility:"visible"})).attr("alt","Google+").on("click",function(){window.open(c.link)}),$(".gSignIn").toggleClass("notdisplayed")),this.first&&$("#profileWindow").trigger("click"),k.i()},ip:function(){$("#formProfil [name=mail]").val(c.id),$("#formProfil [name=name]").val(c.name),c.googleSignIn?($("[name=googleSignIn]").prop("checked",!0),c.googleSync&&$("#formProfil [name=googleSync]").prop("checked",!0)):$("#formProfil [name=pwd]").attr("required",!0)},d:function(){return $("#errPwd").hide(),document.getElementsByName("pwd")[0].reportValidity()?(o.co("warning",$("#delete").attr("confirm")).then(function(){a.emit("deleteUser",$("[name=pwd]").val())}),!1):void 0},u:function(){return $("#errPwd").fadeOut(),a.emit("updateUser",$(this).ftj()),!1},ru:function(a){c.name=a.name,c.googleSync=a.googleSync,o.c()},un:function(){return $("#errPwd").show(),!1},b:function(a){return _.find(this.books,_.matchesProperty("id",a))},bi:function(a){return _.findIndex(this.books,_.matchesProperty("id",a))},ab:function(a){-1===c.bi(a.id)&&(c.books.push(a),c.books=_.sortBy(c.books,"title"));var b=g.o(a.id);b&&(b.book=a),$("#nbBooks").html(c.books.length)},rb:function(a){return _.remove(this.books,_.matchesProperty("id",a)),this.books.length},ub:function(a){var b=this.bookIndex(a.id);a.update&&(a=_.assign(a,a.update)),delete a.update,-1!==b&&(this.books[b]=_.assign(this.books[b],a));var c=g.o(a.id);c&&c.cell&&(a.title||a.authors||a.alternative)&&(a.title&&$("header",c.cell).html(a.title),a.authors&&$("figcaption",c.cell).html(a.authors.join(", ")),a.alternative&&$(".cover",c.cell).attr("src",a.alternative))},ut:function(){this.tags=_.countBy(_.flatten(_.compact(_.pluck(this.books,"tags")),!0).sort()),i.i()},ds:function(){for(var a in this)_.isFunction(this[a])||delete this[a]},c:function(){return o.c(),$("[name=filtre]").val(""),$(".selectedTag").html(""),$("[name=filtre]").data("prec",""),$("#tags").toggle(!_.isEmpty(c.tags)),$(".bookcell").removeClass("tofilter tohide"),$("#nbBooks").html(c.books.length),$("#collection").hasClass("active")?(g.ro(),l.e(c.books.length)):(e.a.call("#collection"),g.s(c.books,!0)),!1}},d={n:~~($(window).innerWidth()/256),g:function(){var a=$("#d").length?$("#d"):$("<section>").prop("id","d").attr("role","main").appendTo($("body")).append($("<section>").addClass("notdisplayed")),b=a.width()/d.n;if($(".col",a).length!==d.n){$(".col",a).remove();for(var c=[],e=0;e<d.n;e++)c.push($("<div>").addClass("col").attr("colid",e).css({width:b,"max-width":b}));a.css("padding-top",$("#nvb").is(":visible")?$("#nvb").height():0).append(c),$(".col").on({dragenter:function(){event.preventDefault()},dragover:function(){event.preventDefault()},drop:function(a){a.preventDefault();var b=g.o(JSON.parse(a.dataTransfer.getData("cell"))).cell;return $(a.target).closest(".bookcell").length?(b.insertBefore($(a.target).closest(".bookcell")),g.lc()):b.appendTo($(this)),!1}})}return a},rm:function(){$("#d").remove()},r:function(){d.n!==~~($(window).innerWidth()/256)&&(o.c(),$(".deroulant").hide(),d.n=~~($(window).innerWidth()/256)),g.ro()}},e={h:function(){var a=$(this).is("img")?$(this):$("img",this);return $(this).hasClass("active")||$(this).hasClass("sortBy")?!1:void a.attr("src",images[a.attr("source")][a.attr("hover")])},b:function(){var a=$(this).is("img")?$(this):$("img",this);return $(this).hasClass("active")||$(this).hasClass("sortBy")?!1:(a.attr("src",images[a.attr("source")][a.attr("blur")]),void(a.is(":visible")||a.css({visibility:"visible"})))},a:function(){$(".active").removeClass("active").each(e.b),$(this).addClass("active"),$("#tags").toggle("collection"===$(this).prop("id")&&!_.isEmpty(c.tags)),$("img",this).attr("src",images[$("img",this).attr("source")][$("img",this).attr("active")])}},f={s:function(){e.h.call($("#sort img").first()),$("#tags, #notifications").hide()},t:function(){$(".nvb").fadeToggle(function(){$("#d").animate({"padding-top":$("#nvb").is(":visible")?$("#nvb").height():0},100)})},tn:function(a){a&&$("#sort").fadeOut(),$("#notifs").css({top:$("#nvb").height()+5,left:$("#notifications").offset().left}),$("#notifs").fadeToggle()},ts:function(a){a&&$("#notifs").fadeOut(),$("#sort").css({top:$("#nvb").height()+5,left:$("#tris").offset().left}),$("#sort").fadeToggle()},l:function(){window.open($(this).attr("url"))},m:function(){document.location.href="mailto:"+$(this).attr("mail")},c:function(a){return!$("#detailWindow").is(":visible")||$("#w").hasClass("over")||_.isEmpty(p.d.book)||$("#contextMenu").css({top:a.clientY+$("#contextMenu").height()>$(window).innerHeight()?a.clientY-$("#contextMenu").height():a.clientY,left:a.clientX+$("#contextMenu").width()>$(window).innerWidth()?a.clientX-$("#contextMenu").width():a.clientX}).fadeIn(),!1},cc:function(a){$("#contextMenu").is(":visible")&&!$(a.target).hasClass("cover")&&$("#contextMenu").fadeOut()},mn:function(){if(!p.d.cell)return!1;var a=p.d.cell,b=a.siblings().toArray(),c=a.index(),e=parseInt(a.parent().attr("colid"),10);switch($(this).attr("nav")){case"top":if(!c)return!1;c--;break;case"right":e++,e===d.n&&(e=0,c++);break;case"left":if(!c&&!e)return!1;e||(e=d.n,c--),e--;break;case"bottom":if(c>=b.length)return!1;c++}return $("[colid="+e+"]").children()[c]&&$(".cover",$("[colid="+e+"]").children()[c]).trigger("click"),!1}},g={b:[],c:[],a:function(a){g.c=_.union(g.c,_.isArray(a)?a:[a])},d:function(){d.rm(),g.b=[],g.c=[]},o:function(a){return _.find(g.c,_.matchesProperty("id",a))},s:function(a,b){b&&g.d();var d=[];l.last&&(g.b.push(a),g.b=_.flattenDeep(g.b));for(var e in a)g.o(a[e].id)||d.push(new h(c.b(a[e].id)||a[e]));g.a(d),g.ro(d,!0),q.t()},r:function(a){g.o(a.id).returned(a)},ro:function(a,b){a=a||_.sortBy(g.c,function(a){return[a.row,a.col]});for(var c=d.g(),e=b?$(".bookcell","[colid]").length:0,f=0,h=0,i=a.length;i>h;h++){var j=$(a[h].cell);a[h].col=(e+h)%d.n,a[h].row=Math.floor((e+h)/d.n),j.hasClass("tohide")||j.hasClass("tofilter")?j.appendTo($(".notdisplayed",c)):(j.appendTo($("[colid="+f%d.n+"]",c)).css("visibility","hidden"),$(j).addClass("torotate"),f++),$("img, .title, .authors",j).not(".bouton").on("click",a[h].detail),$("button",j).on("click",a[h].action),j.on("mouseenter mouseleave",a[h].description)}g.lc()},lc:function(){for(var a in g.c)g.c[a].loadCover();$("#footer").toggle(!!$(window).scrollTop())},bt:function(a){$("#formFilter").trigger("reset"),$(".bookcell").removeClass("tofilter"),$(".selectedTag").html(a);for(var b in g.c)g.c[b].cell.toggleClass("tohide",!_.includes(g.c[b].book.tags,a));g.ro()},so:function(){e.b.call($(".sortBy").removeClass("sortBy")),e.h.call($(this).addClass("sortBy"));var a=$(this).attr("by"),b=$(this).attr("sort"),c=_.sortBy(g.c,function(b){return b.book[a]||null});b&&c.reverse(),g.ro(c)},f:function(){var a=this.value.toLowerCase();if(this.checkValidity()&&a!==$(this).data("prec")){$(this).data("prec",a);for(var b in g.c){var c=g.c[b].book.title.toLowerCase(),d=g.c[b].book.authors?g.c[b].book.authors.join(", ").toLowerCase():"",e=g.c[b].book.description.toLowerCase();g.c[b].cell.toggleClass("tofilter",-1===c.indexOf(a)&&-1===d.indexOf(a)&&-1===e.indexOf(a))}g.ro()}}},h=function(b){var d=this,e=$("#tempCell").clone().removeAttr("id").addClass("bookcell"),f=function(a){d.book=a,d.opened=!0,p.d=d,p.s(),k.sd(a)},g=function(a){if($(a.relatedTarget).hasClass("description")||$(".description").remove(),"mouseenter"===a.type){if(!b.description)return!1;var c=b.description.indexOf(" ",500),d=function(){$(this).remove()},e={"max-height":$(window).height(),left:Math.min($(this).position().left+$(this).innerWidth()/3,$(window).innerWidth()-1.333*$(this).innerWidth())},f=$(this).position().top+$(this).innerHeight()/3,g=$("<div>").hide().width($(this).width()).appendTo($("body")).addClass("description").html(b.description.substr(0,Math.max(c,500))+(-1!==c?"...":"")).prepend($("<span>").html(b.title+"<BR>")).on("click",d).attr("bookid",b.id);f+g.outerHeight()>$(document).innerHeight()?e.bottom=.333*$(this).innerHeight():e.top=f,g.css(e),setTimeout(function(){g.fadeIn().mouseleave(d)},1e3)}},h=function(){return q.t(1,1),-1!==c.bi(b.id)||d.opened?(p.d=d,p.s(-1!==c.bi(b.id))):k.gd(b.id).always(function(c){c?(p.d.book=c,p.s(!1)):a.emit("searchDetail",b.id)}),!1},i=function(){var a=new $.Deferred;if(e.hasClass("torotate")){var c=$(".cover",e);return c.length&&$(window).height()+$(window).scrollTop()>e.offset().top&&(e.removeClass("torotate"),(b.alternative||b.base64)&&c.attr("src",b.alternative||b.base64),e.css("visibility","visible").fadeIn(),e.on({dragstart:j,dragend:l}),$({deg:-90}).animate({deg:0},{duration:250,step:function(a){e.css({transform:"rotateX("+a+"deg)"})},complete:function(){$("footer",e).css("bottom",$("figcaption",e).height()+5),a.resolve()}})),a.promise()}},j=function(a){$(this).addClass("isDrag"),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("cell",JSON.stringify(d.id))},l=function(){$(this).removeClass("isDrag")};return this.id=b.id,this.book=b,this.cell=e,this.loadCover=i,this.opened=!1,this.returned=f,this.detail=h,this.description=g,$("header",e).html(b.title),$("figcaption",e).html(b.authors?b.authors.join(", "):""),$(".previewable",e).toggle(!!b.access&&"NONE"!==b.access),$(".personnal",e).toggle(_.isEqual(b.id.user,c.id)),$(".recommanded",e).toggle(!!b.from),-1!==c.bi(b.id)?$(".add",e).hide():$(".remove",e).hide(),this},i={i:function(){i.cloud=[],$("#tagsList, #cloud").children().not("img").remove();var a=function(){i.s(),g.bt($(this).html()),q.t(!1)};if(c.tags){var b=[];for(var d in c.tags)i.cloud.push({text:d,weight:c.tags[d],html:{"class":"tag",weight:c.tags[d]},handlers:{click:a}}),b.push("<option>"+d+"</option>");$("#tagsList").append(b)}},s:function(){return $("#wa").is(":visible")||!$("#collection").hasClass("active")?!1:void o.c(function(){$("html").toggleClass("overflown",!$("#cloud").is(":visible")),$("#cloud").fadeToggle(function(){$("span",this).length||$(this).jQCloud(i.cloud)})})},c:function(){$("#cloud").is(":visible")&&i.s()},a:function(){event.preventDefault();var a=$(this).ftj().tag.toLowerCase(),b=$("#userTags > div").toArray(),c=_.find(b,function(b){return $(".libelle",b).html()===a});return c||(b.push(i.n(a,!0)),$("#userTags").append(_.sortBy(b,function(a){return $(".libelle",a).html()}))),this.reset(),!1},n:function(a,b){var c=$("#tempTag").clone().removeAttr("id").on("click",function(){$(event.target).hasClass("libelle")?(o.c(),g.bt($(event.target).html())):$(this).fadeOut().promise().then(function(){$(this).remove(),$("[autofocus]","#detailWindow").focus()})});return $(".libelle",c).html(a).toggleClass("new",!!b),c},l:function(){$("[name=tag]").attr("list",this.value?"tagsList":"none")}},j={s:function(a){a&&(j.list=a),$("#notifications, #notifNumber").toggle(!!j.list.length),$("#notifNumber").text(j.list.length);for(var b in j.list){var c=$("#tempNotif").clone().removeAttr("id").attr("notif",JSON.stringify(j.list[b])).appendTo("#notifs").on("click",j.c);$("#notifName",c).html(j.list[b].from),$("#notifTitle",c).html(j.list[b].title)}},c:function(){{var b=this,c=JSON.parse($(b).attr("notif"));c._id.book}_.remove(j.list,c),j.last=c,$("#notifs").toggle(function(){$(b).remove()}),$("#notifications, #notifNumber").toggle(!!j.list.length),$("#notifNumber").text(j.list.length),q.t(1,1),a.emit("readNotif",c)}},k={i:function(){k.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;{var a=new $.Deferred;window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange}if(k.indexedDB){var b=indexedDB.open(c.session,1);b.onerror=function(){a.reject()},b.onsuccess=function(){k.db=this.result,a.resolve()},b.onupgradeneeded=function(){var a=this.result;a.createObjectStore("queries",{keyPath:"query"}).createIndex("by_query","query",{unique:!0}),a.createObjectStore("details",{keyPath:"id"}).createIndex("by_id","id",{unique:!0})}}return a.promise()},gq:function(a){var b=new $.Deferred,c=k.db.transaction(["queries"],"readwrite").objectStore("queries").index("by_query").get(JSON.stringify(a));return c.onsuccess=function(){this.result?b.resolve(this.result.books):b.reject()},c.onerror=b.reject,b.promise()},sq:function(a,b){k.db.transaction(["queries"],"readwrite").objectStore("queries").put({query:JSON.stringify(a),books:b})},dq:function(a){k.db.transaction(["queries"],"readwrite").objectStore("queries")["delete"](a)},gd:function(a){var b=(new $.Deferred,k.db.transaction(["details"],"readwrite").objectStore("details").index("by_id").get(a));return b.onsuccess=function(){this.result?defDe.resolve(this.result):defDe.reject()},b.onerror=function(){defDe.reject()},defDe.promise()},sd:function(a){k.db.transaction(["details"],"readwrite").objectStore("details").put(a)},dd:function(a){k.db.transaction(["details"],"readwrite").objectStore("details")["delete"](a)}},l={b:function(){event.preventDefault(),l.s();var b=$(this).ftj();return l.last={q:b.searchby+b.searchinput,langRestrict:b.langage},$("[name=filtre]").val("").data("prec",""),o.c(function(){q.t(1,1),k.gq(l.last).then(g.s).fail(function(){$("#nvb").addClass("inactive"),q.a(!0),a.emit("searchBooks",l.last)})}),!1},r:function(){l.s(),l.last={recommand:c.id},o.c(function(){q.t(1,1),k.gq(l.last).then(g.s).fail(function(){$("#nvb").addClass("inactive"),q.a(!0),a.emit("recommanded")})})},a:function(b){l.s(),l.last={associated:b},o.c(function(){q.t(1,1),k.gq(l.last).then(g.s).fail(function(){$("#nvb").addClass("inactive"),q.a(!0),a.emit("associated",b)})})},ie:function(){var b=$(this).prop("id");o.co("warning","Cette opération va importer/exporter vos EBooks depuis/vers votre bibliothèque Google.<BR>Etes vous sur de vouloir continuer?").then(function(){return"exportNow"===b?a.emit("exportNow"):(g.d(),e.a.call("#collection"),$("#nvb").addClass("inactive"),q.a(!0),void o.c(function(){q.t(1,1),a.emit("importNow")}))})},s:function(){g.d(),d.rm(),e.a.call("#recherche"),$(".selectedTag").html("")},e:function(a){$("#nvb").removeClass("inactive"),q.a(!1),q.t(),l.last&&k.sq(l.last,g.b)}},m=function(){return c.ds(),g.d(),a.close(),k.indexedDB&&k.indexedDB.deleteDatabase(c.id),window.location.assign("/logout")},n=function(){var a;switch(this.setCustomValidity(""),this.name){case"searchinput":a=this.value.length<3;break;case"filtre":a=!!this.value.length&&this.value.length<3;break;case"name":a=this.value.length<4;break;case"pwd":a=this.value.length<4||this.value.length>12;break;case"newPwd":a=this.value.length<4||this.value.length>12;break;case"confirmPwd":a=this.value!==$("[name=newPwd]").val();break;case"recommand":a=this.value.toLowerCase()===c.id;break;case"title":a=this.value.length<6}a&&this.setCustomValidity($(this).attr("error"))},o={o:function(){var a=$.Deferred(),b=$(this).attr("window")||$(this);return i.c(),$("#wa").is(":visible")&&a.reject(),_.includes(["previewWindow","recommandWindow"],$(b).prop("id"))||$(".window").fadeOut(),"#profileWindow"===b&&(c.ip(),$(".changePwd input").attr("required")&&o.t()),$(".errMsg").hide(),q.t(1).always(function(){$(b).css("top",$(window).scrollTop()+10).fadeIn(),$("[autofocus]",b).focus(),a.resolve()}),a.promise()},c:function(a){if(!$(".window").is(":visible")&&_.isFunction(a))return a.call();var b=$(this).closest(".window").length?$(this).closest(".window"):$(".window");q.o(!1),$(document).unbind("keyup"),$("[note]").each(e.b),b.fadeOut().promise().then(function(){_.isFunction(a)?a.call():q.t(),$("form",b).trigger("reset")})},co:function(a,b){var c=$.Deferred();return q.o(),$("#confirmWindow .windowheader span").text(function(){return $(this).attr(a)}),$("#confirmWindow #confirm").html(b),$("button","#confirmWindow").unbind("click").on("click",o.c),$(".valid","#confirmWindow").on("click",function(){c.resolve()}),$(".cancel","#confirmWindow").toggle("warning"===a).on("click",function(){c.reject()}),q.t(1).always(function(){$("#confirmWindow").css({top:$(window).scrollTop()+10,left:"25%"}).fadeIn(),$(document).keyup(function(){27===event.keyCode&&o.c()})}),c.promise()},t:function(){$(".changePwd").slideToggle(function(){$("[type=password]",this).attr("required",$(this).is(":visible"))})}},p={d:{},a:function(){var b,d=p.d.book.id,e=c.bi(d),f=$(this).attr("actclick");-1!==e&&(b=c.books[e]),this.add=function(){if(d)a.emit("addDetail"),p.nc();else{var b,c=$("#formNew").ftj();$("input, textarea","#formNew").each(function(){this.reportValidity()||(b=!0)}),c.authors=c.authors?c.authors.split(","):[];for(var e in c.authors)c.authors[e]=r(c.authors[e]);if(b)return!1;q.o(),a.emit("newbook",c)}},this.associated=function(){l.a(d)},this.update=function(){var e=!1,f={id:d},g=_.map($("#userTags > div").toArray(),function(a){return $(".libelle",a).html()});if(_.isObject(d)){var h=$("#formNew").ftj();h.authors=h.authors.split(",")||[];for(var i in h.authors)h.authors[i]=r(h.authors[i]);for(var j in h)_.isEqual(b[j],h[j])||(e=!0,f.update||(f.update={}),f.update[j]=h[j])}$("#userNote").val()&&$("#userNote").val()!==b.note&&(e=!0,f.userNote=$("#userNote").val()),$("textarea","#userComment").val()&&$("textarea","#userComment").val()!==b.comment&&(e=!0,f.comment=$("textarea","#userComment").val()),b.tags&&g===b.tags||(e="tags",f.tags=g),$("#detailCover").attr("maincolor")&&b.alternative!==$("#detailCover").prop("src")&&(e=!0,f.alternative=$("#detailCover").prop("src"),f.maincolor=$("#detailCover").attr("maincolor")),e&&(f.userDate=(new Date).toJSON(),a.emit("updateBook",f),c.ub(f),c.ut(),$("#tags").toggle(!_.isEmpty(c.tags)&&$("#collection").hasClass("active"))),o.c()},this.upload=function(){$("[type=file]","#uploadHidden").trigger("click")},this.preview=function(){$("[name=previewid]").val(d),q.o(),o.o.call("#previewWindow").then(function(a){$("#preview").trigger("submit")})},this.google=function(){window.open($(this).attr("link"))},this.recommand=function(){q.o(),o.o.call("#recommandWindow")},this.close=function(){$(this).closest(".window").fadeOut().promise().then(function(){q.o(!1)})},this[f].call(this)},nc:function(){$("[actclick=add], [actclick=update], #upload, .inCollection").toggle();var a=g.o(p.d.book.id);if($("#collection").hasClass("active")&&!a){var b=c.books.length%d.n,e=$(".bookcell","[colid="+c.books.length%d.n+"]").length;a=_.extend({col:b,row:e},new h(p.d.book)),g.a(a),g.ro()}a&&a.cell&&$("button",a.cell).fadeToggle(),c.ab(p.d.book)},on:function(){for(var a=$("[note]").toArray(),b=$("#userNote").val(),c=0;c<a.length;c++)b>c?$(a[c]).prop("src",images[$(a[c]).attr("select")].black):$(a[c]).prop("src",images[$(a[c]).attr("source")].black)},en:function(){var a=$("#userNote").val()||0,b=$(this).attr("note"),c=$("[note]").toArray();if(a!==b)for(var d=0;d<Math.max(a,b);d++)d<Math.min(a,b)?$(c[d]).prop("src",images[$(c[d]).attr("select")].black):a>b?$(c[d]).prop("src",images[$(c[d]).attr("hoverminus")].black):$(c[d]).prop("src",images[$(c[d]).attr("hoverplus")].black)},cn:function(){$("#userNote").val($("#userNote").val()===$(this).attr("note")&&"1"===$("#userNote").val()?"0":$(this).attr("note")),p.on()},ls:function(){$(this).attr("searchby")&&$(this).text()&&($("[type=search]","#formSearch").val($(this).text()),$("[name=searchby]","#formSearch")[$(this).attr("searchby")].checked=!0,$("#formSearch").trigger("submit"))},gmc:function(a){var c=b.getColor(a),d="#"+((1<<24)+(c[0]<<16)+(c[1]<<8)+c[2]).toString(16).substr(1);return{rgb:c,hex:d}},uc:function(){var a=this.files;if(a[0]){if(!a[0].type.match(/image.*/)||a[0].size>5e5)return o.co("error","Veuillez sélectionner un fichier de type 'image' inférieure à 1MB."),!1;var b=new FileReader;b.onload=function(a){return function(b){a.on("load",function(){var a=p.gmc(this);$(this).attr("maincolor",a.hex).addClass("new"),$("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+a.hex+")")}),a.prop("src",b.target.result)}}($("#detailCover")),b.readAsDataURL(this.files[0])}},r:function(){event.preventDefault();var b=$(this).ftj();return b.book=p.d.book.id,b.title=p.d.book.title,p.d.book.alt&&(b.alt=p.d.book.alt),a.emit("sendNotif",b),$("img","#recommandWindow").trigger("click"),!1},m:function(){$(this).hasClass("modify")&&($(this).hasClass("hide")&&$(this).siblings("[name]").each(function(){this.value=$(this).attr("oldvalue")}),$(this).toggleClass("hide"),$(this).siblings("[field]:not(.noValue), [name]").toggle(),$(this).siblings("[name]:first").focus())},n:function(){p.d.book={},p.s(!1),$("[field]:not(.categories)","#formNew").hide().closest(".volumeInfo").show(),$("input, textarea","#formNew").show()},s:function(a){var b=p.d.book;$("input, textarea","#formNew").hide(),$("#formNew button").not(".categories").removeClass("hide").toggleClass("modify",!!b.id&&_.isEqual(b.id.user,c.id)),$("[type=file]","#detailWindow").val(""),$("#comments","#detailWindow").children().remove(),$("#detailContent","#detailWindow").css("background","whitesmoke"),$("#userNote","#detailWindow").val(b.note),$(".new","#detailWindow").removeClass("new"),$("#detailCover","#detailWindow").unbind("load"),$(".inCollection").toggle(!!a),i.l(),b.mainColor?$("#detailContent","#detailWindow").css("background","radial-gradient(whitesmoke 40%, "+b.mainColor+")"):$("#detailCover","#detailWindow").on("load",function(){(b.alternative||b.base64)&&(b.mainColor=p.gmc(this).hex,$("#detailContent","#detailWindow").css("background","radial-gradient(whitesmoke 40%, "+b.mainColor+")"))}),$("#detailCover","#detailWindow").prop("src",b.alternative||b.base64||images["book-4-icon"].black),$(".direct","#detailWindow").text(""),$("#userTags > div","#detailWindow").remove(),$(".windowheader span","#detailWindow").text(b.title||$(".windowheader span","#detailWindow").attr("label")),$("[actclick=add]").toggle(!a),$("[actclick=update]").toggle(!!a),$("[actclick=recommand]").toggle(!!a),$("[actclick=associated]").toggle(!!b.id&&!_.isObject(b.id)),$("[actclick=preview]").toggle(!!b.access&&"NONE"!==b.access),$("[actclick=google]").attr("link",b.link).toggle(!!b.link),$("[actclick=upload]").toggle(!b.base64&&!b.cover&&!!a),$(".comments","#detailWindow").toggle(!!b.comments&&!!b.comments.length),$("[field]","#detailWindow").removeClass("noValue"),p.on(),$("#detailWindow").is(":visible")||o.o.call("#detailWindow");for(var d in b){var e=b[d];if("subtitle"!==d&&$("[field="+d+"]","#detailWindow").closest(".volumeInfo").toggle(!!e||_.isEqual(b.id.user,c.id)),$("[field="+d+"]","#detailWindow").toggle(!!e).toggleClass("noValue",!e),"authors"!==d)if("tags"===d&&e.length){for(var f=e,g=[],h=0,j=f.length;j>h;h++)g.push(i.n(f[h]));$("#userTags","#detailWindow").append(g)}else if("userNote"!==d)if("comments"===d&&e.length){var k=[];for(var l in e){var m=$("#tempComment").clone().removeAttr("id");$("#commentAuthor",m).text(e[l].name),$("#commentDate",m).text(e[l].date.fd()),$("#commentNote",m).text(e[l].note),$("#commentComment",m).toggle(!!e[l].comment).text(e[l].comment),k.push(m)}$("span#comments").append(k)}else $.isArray(e)&&(e=e.join(", ")),$("[name="+d+"]","#detailWindow").val(e).attr("oldvalue",e),$("[field="+d+"]","#detailWindow").hasClass("date")&&($("[field="+d+"]","#detailWindow").attr("datetime",new Date(e)),e=e.fd()),$("[field="+d+"]","#detailWindow").html(e);else p.cn.call($("[note="+e+"]"));else{var n=[];for(var q in e)n.push($("<span>").addClass("link").attr("searchby",3).text(e[q]));$("[name=authors]","#detailWindow").val(e.join(", ")).attr("oldvalue",e.join(", ")),$("[field=authors]","#detailWindow").append(n).siblings("button").toggle(!!n.length)}}$(".link").unbind("click").on("click",p.ls)}},q={t:function(a,b){var c=$.Deferred();return $(".window").is(":visible")?c.reject():($(".description").remove(),a?(b?$("img","#w").show():$("img","#w").hide(),$("html").addClass("overflown"),$("#w").fadeIn().promise().then(function(){c.resolve()})):$("#w").fadeOut().promise().then(function(){$("html").removeClass("overflown"),q.o(!1),c.resolve()})),c.promise()},a:function(a){a?$("#wa").fadeIn():$("#wa").fadeOut()},o:function(a){$("#w").toggleClass("over",a)}},r=function(a){return a.replace(/^\s+/g,"").replace(/\s+$/g,"")},s=function(a){if(a=a||window.event,!a.altKey)if(a.ctrlKey){var b;switch(a.keyCode){case 77:f.t(),b=!0;break;case 76:m(),b=!0;break;case 82:$("#recherche").trigger("click"),b=!0;break;case 80:$("#profil").trigger("click"),b=!0;break;case 66:$("#collection").trigger("click"),b=!0;break;case 69:$("#tags").trigger("click"),b=!0;break;case 73:$("#contact").trigger("click"),b=!0}if(b)return!1}else 27===a.keyCode&&(o.c(),i.c(),$("#contextMenu").fadeOut())};$.fn.ftj=function(){if(!this.is("form"))return!1;var a={};return _.forEach(this.serializeArray(),function(b){a[b.name]=b.value}),a},String.prototype.fd=function(){var a=this.toString().substr(0,10).split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),a},a.on("reconnect",function(){a.io.reconnect()}).on("connect",function(){a.emit("isConnected")}).on("disconnect",function(){c.ds(),o.c(),q.t(1,1),$(".deroulant").hide(),g.d()}).on("error",function(a){}).on("user",function(a){f.s(),c.i(a)}).on("collection",function(a){c.books=a.books,j.s(a.notifs),i.i(),$("#collection").trigger("click")}).on("books",g.s).on("endRequest",l.e).on("returnAdd",c.ab).on("returnDetail",g.r).on("lo",m).on("updateOk",c.ru).on("updateNok",c.un).on("error",function(a){}).on("returnNotif",function(a){p.bookid=a.id,p.d={book:a},p.s(-1!==c.bi(a.id))}).on("newbook",function(a){p.bookid=a.id,p.d={book:a},p.nc(),p.s(!0),q.o(!1)}).on("covers",function(a){for(var b in a)c.books[a[b].index].base64=a[b].base64,$(g.c[a[b].index].cell).hasClass("torotate")||$(".cover",g.c[a[b].index].cell).prop("src",a[b].base64)}),$(document).on("keyup keydown",s).on("scroll",g.lc),$("input").on("input propertychange",n),$("#logout").on("click",m),$("#formSearch").on("submit",l.b),$("#formProfil").on("submit",c.update),$("#formRecommand").on("submit",p.r),$("#formNew").on("submit",function(a){a.preventDefault()}),$("#formNew button").on("click",p.m),$("#formTag").on("submit",i.a),$("#changePwd").on("click",o.t),$("#delete").on("click",c.d),$("#tris").on("click",f.ts),$("#notifications").on("click",f.tn),$("#sort > div").on("click",g.so),$("img[actclick]").on({mouseenter:e.h,mouseleave:e.b}),$("[actclick]").on("click",p.a),$(".closeWindow").on("click",o.c),$("#footer").on("click",function(){$("body, html").animate({scrollTop:0})}),$("[type=file]","#uploadHidden").change(p.uc),$("#userNote > img").on({mouseenter:p.en,mouseleave:p.on,click:p.cn}),$(".nvb > div, img.closeWindow, #footer, [by], .imgAction img, #cloud img, #contactsWindow img, [nav]").not(".picture, [note], .filtre").on({mouseenter:e.h,mouseleave:e.b}),$("[blur]").each(e.b),$("img").attr("draggable",!1),$("#nvb").removeClass("notdisplayed"),$("#collection").on("click",c.c),$("#tags, #cloud > img").on("click",i.s),$("#recherche, #profil, #contact").on("click",o.o),$("#newbook").on("click",p.n),$("[name=filtre]").on("search",g.f),$("#formFilter").on("submit",function(a){a.preventDefault()}),$(".tnv").on("click",f.t),$("[url]").on("click",f.l),$("[mail]").on("click",f.m),$("#recommand4u").on("click",l.r),$("#importNow, #exportNow").on("click",l.ie),$("[name=tag]").on("input propertychange",i.l),$("html").on("click",function(a){_.includes(["notifications","tris"],$(a.target).closest(".action").prop("id"))||$(".deroulant").fadeOut()}),$(window).on("resize",d.r),$(window).on("contextmenu",f.c).on("click",f.cc),$("*").on("selectstart",function(a){return _.includes(["input","textarea"],$(a.target).prop("tagName").toLowerCase())?void 0:!1}),$("[nav]").on("click",f.mn)}):alert($("body").attr("error"));
