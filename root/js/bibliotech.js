Array.prototype.assign=function(a){return this.push.apply(this,Array.isArray(a)?a:[a]),this},Array.prototype.noSpace=function(){for(var a=0,b=this.length;b>a;a++)"string"==typeof this[a]&&(this[a]=this[a].noSpace());return this},HTMLElement.prototype.closest=function(a){for(var b=this;b&&b.tagName&&"body"!==b.tagName.toLowerCase();){if(b.hasClass(a))return b;b=b.parentNode}return null},HTMLElement.prototype.css=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){_.includes(["width","max-width","height","max-height","top","left","bottom","padding-top"],c)&&-1===a.toString().indexOf("%")&&(a+="px"),b.style[c]=a}),b},HTMLElement.prototype.fade=function(a){a="undefined"==typeof a?!this.isVisible():a;var b=this,c=a?"fadein":"fadeout";return new Promise(function(d){a&&b.toggleClass("notdisplayed",!1),b.setEvents({animationend:function e(f){d(b),b.removeEvent("animationend",e).toggleClass(c,!1),a||b.toggleClass("notdisplayed",!0)}}).toggleClass(c,!0)})},HTMLElement.prototype.formToJson=function(){var a={};return this.querySelectorAll("input, textarea").forEach(function(){(_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.checked||!_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.name)&&(a[this.name]=this.value)}),a},HTMLElement.prototype.hasClass=function(a){return this.classList.contains(a)},HTMLElement.prototype.html=function(a){return"undefined"==typeof a?this.innerHTML:(this.innerHTML=a,this)},HTMLElement.prototype.index=function(){for(var a=this.parentNode.childNodes,b=0,c=a.length;c>b;b++)if(a[b]===this)return b;return-1},HTMLElement.prototype.isVisible=function(){return this.offsetWidth>0&&this.offsetHeight>0},HTMLElement.prototype.newElement=function(a,b){var c=document.createElement(a);return _.isPlainObject(b)&&c.setAttributes(b),this.appendChild(c),c},StyleSheetList.prototype.removeAll=HTMLElement.prototype.removeAll=function(){return this.remove?this.remove():this.parentNode.removeChild(this),this},HTMLElement.prototype.removeAttributes=function(a){var b=this;return"string"==typeof a&&(a=[a]),_.isArray(a)&&a.forEach(function(a){b.removeAttribute(a)}),b},HTMLElement.prototype.removeEvent=function(a,b){return this.removeEventListener(a,b),this},HTMLElement.prototype.setAttributes=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){b.setAttribute(c,a)}),b},Window.prototype.setEvents=HTMLDocument.prototype.setEvents=HTMLElement.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(d.addEventListener(a,b,c),d)},HTMLElement.prototype.setValue=function(a){return this.value=a,this},HTMLElement.prototype.siblings=function(a){return this.parentNode.alls(a)},HTMLElement.prototype.text=function(a){return"undefined"==typeof a?this.textContent:(this.textContent=a,this)},HTMLElement.prototype.toLeft=function(a){a="undefined"==typeof a?!this.isVisible():a;var b=this,c=a?"leftin":"leftout";return new Promise(function(d){a&&b.toggleClass("notdisplayed",!1),b.setEvents({animationend:function e(f){d(b),b.removeEvent("animationend",e).toggleClass(c,!1),a||b.toggleClass("notdisplayed",!0)}}).toggleClass(c,!0)})},HTMLElement.prototype.toggle=function(a){return("undefined"==typeof a||null===a)&&(a=!this.isVisible()),this.toggleClass("notdisplayed",!a),this},HTMLElement.prototype.toggleClass=function(a,b){var c=this;a=a.split(" ");var d="toggle";return"undefined"!=typeof b&&(d=b?"add":"remove"),a.forEach(function(a){c.classList[d](a)}),c},HTMLElement.prototype.trigger=function(a){var b;try{b=new Event(a)}catch(c){b=document.createEvent(_.includes(["click","mouseenter","mouseleave","mouseup","mousedown"],a)?"MouseEvents":"HTMLEvents"),b.initEvent(a,!0,!0)}return this.dispatchEvent(b),this},HTMLElement.prototype.xposition=function(){return this.parentNode&&this.parentNode.tagName?this.parentNode.offsetLeft:this.offsetLeft},HTMLDocument.prototype.alls=HTMLCollection.prototype.alls=HTMLElement.prototype.alls=NodeList.prototype.alls=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return[];if(d.multiSelect())a=this.querySelectorAll(b);else switch(c){case"#":a=[document.getElementById(d)];break;case"@":a=document.getElementsByName(d);break;case".":a=this.getElementsByClassName(d);break;default:a=this.getElementsByTagName(b)}return a},HTMLCollection.prototype.css=NodeList.prototype.css=function(a){return this.forEach(function(){this.css(this)}),this},HTMLCollection.prototype.fade=NodeList.prototype.fade=function(a){var b=[];return this.forEach(function(){b.push(this.fade(a))}),Promise.all(b)},HTMLCollection.prototype.forEach=NodeList.prototype.forEach=function(a){return[].forEach.call(this,function(b){a.apply(b)}),this},HTMLCollection.prototype.html=NodeList.prototype.html=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.html(a)}),this)},HTMLDocument.prototype.one=HTMLCollection.prototype.one=HTMLElement.prototype.one=NodeList.prototype.one=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return null;if(d.multiSelect())a=this.querySelector(b);else switch(c){case"#":a=document.getElementById(d);break;case"@":a=document.getElementsByName(d)[0];break;case".":a=this.getElementsByClassName(d)[0];break;default:a=this.getElementsByTagName(b)[0]}return a},HTMLCollection.prototype.removeAll=NodeList.prototype.removeAll=function(){return this.forEach(function(){this.removeAll()}),this},HTMLCollection.prototype.removeAttributes=NodeList.prototype.removeAttributes=function(a){return"string"==typeof attrs&&(a=[a]),this.forEach(function(){this.removeAttributes(a)}),this},HTMLCollection.prototype.removeEvent=NodeList.prototype.removeEvent=function(a,b){return this.forEach(function(){this.removeEvent(a,b)}),this},HTMLCollection.prototype.setAttributes=NodeList.prototype.setAttributes=function(a){return this.forEach(function(){this.setAttributes(a)}),this},HTMLCollection.prototype.setEvents=NodeList.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(a=a.split(" "),d.forEach(function(){var d=this;a.forEach(function(a){d.addEventListener(a,b,c)})}),d)},HTMLCollection.prototype.setValue=NodeList.prototype.setValue=function(a){return this.forEach(function(){this.setValue(a)}),this},HTMLCollection.prototype.text=NodeList.prototype.text=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.text(a)}),this)},HTMLCollection.prototype.toArray=NodeList.prototype.toArray=function(){return[].slice.apply(this)},HTMLCollection.prototype.toggle=NodeList.prototype.toggle=function(a,b){return this.forEach(function(){this.toggle(a,b)}),this},HTMLCollection.prototype.toggleClass=NodeList.prototype.toggleClass=function(a,b){var c=this;return c.forEach(function(){this.toggleClass(a,b)}),c},HTMLCollection.prototype.trigger=NodeList.prototype.trigger=function(a){return this.forEach(function(){this.trigger(a)}),this},String.prototype.fd=function(){var a=this.substr(0,10).split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),a},String.prototype.multiSelect=function(){return-1!==this.indexOf(" ")||-1!==this.indexOf(",")||-1!==this.indexOf(".")||-1!==this.indexOf("#")||-1!==this.indexOf(":")||-1!==this.indexOf("]")},String.prototype.noAccent=function(){for(var a=[/[\300-\306]/g,/[\340-\346]/g,/[\310-\313]/g,/[\350-\353]/g,/[\314-\317]/g,/[\354-\357]/g,/[\322-\330]/g,/[\362-\370]/g,/[\331-\334]/g,/[\371-\374]/g,/[\321]/g,/[\361]/g,/[\307]/g,/[\347]/g],b=["A","a","E","e","I","i","O","o","U","u","N","n","C","c"],c=this,d=0,e=a.length;e>d;d++)c=c.replace(a[d],b[d]);return c},String.prototype.noSpace=function(){return this.replace(/^\s+/g,"").replace(/\s+$/g,"").replace(/\s{2,}/g," ")},window.FileReader&&window.Promise&&"formNoValidate"in document.createElement("input")?document.setEvents("DOMContentLoaded",function(){"use strict";var a=document,b=new Date,c=function(a,b,c){var d=a[b];a.splice(b,1),a.splice(c,0,d)},d=function(b,c){var d=e.cells.length+("undefined"==typeof c?0:c),f=a.one("#collection").hasClass("active")||-1!==s.get().bookindex(b.id);return this.id=b.id,this.book=b,this.cell=a.one("#tempCell").cloneNode(!0).removeAttributes("id").toggleClass("bookcell",!0),this.cell.setAttribute("bookid",JSON.stringify(b.id)),this.cell.one("header").text(b.title),this.cell.one("figcaption").text(b.authors?b.authors.join(", "):""),this.cell.one(".previewable").toggle(!!b.access&&"NONE"!==b.access),this.cell.one(".recommanded").toggle(!!b.from),this.cell.one(".personnal").toggle(_.isEqual(b.id.user,s.get().id)),this.cell.one(".add").toggle(!f),this.cell.one(".remove").toggle(!!f),this.cell.col=d%i.nbcols,this.cell.row=Math.floor(d/i.nbcols),(b.alternative||b.base64)&&(this.cell.one(".cover").src=b.alternative||b.base64),this.active(),this},e={books:[],bytags:function(b){if(a.one("#collection").hasClass("active")){window.scroll(0,0),a.one("#formFilter").reset(),a.alls(".bookcell").toggleClass("tofilter",!1),a.one("#selectedTag").html(b).parentNode.toggle(!0),e.order(b);for(var c=0,d=e.cells.length;d>c;c++){var f=e.cells[c];f.cell.toggleClass("tohide",!_.includes(f.book.tags,b))}e.display(e.cells)}},cells:[],destroy:function(){if(i.remove(),!a.one("#collection").hasClass("active"))for(var b=0,c=e.cells.length;c>b;b++)e.cells[b].destroy();delete e.cells,delete e.books,e.cells=[],e.books=[]},display:function(b,c,d){var f=[c,d];return new Promise(function(g){if(!b&&a.one(".sortBy"))g(e.sort.call(a.one(".sortBy"),f));else{b=b||_.sortBy(e.cells,function(a){return[a.row,a.col]});for(var h=0,j=i.get(),k=0,l=b.length;l>k;k++){var m=(b[k],b[k].cell);d&&m.toggleClass("tohide tofilter",!1),m.hasClass("tohide")||m.hasClass("tofilter")?i.get().one("section.notdisplayed").appendChild(m):(m.toggleClass("toshow",!0),j.one('[colid="'+(c?m.col:h%i.nbcols)+'"]').appendChild(m),h++)}a.one(".window:not(.notdisplayed)")||u.toggle(!1),e.loadcovers(),g(e.cells.length)}})},filter:function(){var b=this.value.toLowerCase().noAccent().noSpace().split(" ").sort(),c=b.length,d=a.one("@last");if(a.one("#saveorder").toggle(!1),this.checkValidity()&&!_.isEqual(b,d.value.split(" ").sort())){d.value=this.value.toLowerCase().noAccent().noSpace();for(var f=0;c>f;f++)b[f]=b[f].replace(/\+/g," ");for(var g=0,h=e.cells.length;h>g;g++){var i,j=e.cells[g];if(j.cell.toggleClass("tofilter",!1),!_.isEqual(b,[""]))for(i=(j.book.title+" "+(j.book.subtitle?j.book.subtitle:"")+" "+(j.book.authors?j.book.authors.join(", "):"")+" "+j.book.description).toLowerCase().noAccent().noSpace(),f=0;c>f;f++)if(-1===i.indexOf(b[f])){j.cell.toggleClass("tofilter",!0);break}}e.display()}},generate:function(b){return new Promise(function(c){for(var f=[],g=0,h=b.length;h>g;g++)e.one(b[g].id)||-1!==_.findIndex(f,_.matchesProperty("id",b[g].id))||f.push(new d(s.get().book(b[g].id)||b[g],g));e.cells.assign(f),!a.one("#collection").hasClass("active")&&o.last&&(e.books.push(b),e.books=_.flatten(e.books)),c(f)})},loadcovers:function(){for(var a=0,b=e.cells.length;b>a;a++)e.cells[a].loadcover();m.toggleFooter()},one:function(a){return _.find(e.cells,_.matchesProperty("id",a))},order:function(b){var d=_.find(s.get().orders,_.matchesProperty("id",b));if(d&&d.order){a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1));for(var f=0,g=d.order.length;g>f;f++){var h=_.findIndex(e.cells,_.matchesProperty("id",d.order[f]));c(e.cells,h,f)}}return!!d},returned:function(a){return a?void e.one(a.id).returned(a):u.toggle(!1)},save:function(){a.one("#saveorder").toggle();var b=a.one("#selectedTag").html(),c=_.map(_.sortBy(a.alls(".col .bookcell"),function(a){return a.index()}),function(a){return JSON.parse(a.getAttribute("bookid"))}),d=_.find(s.get().orders,_.matchesProperty("id",b));b&&(d&&_.isEqual(d.order,c)||(q.emit("orders",{"new":!!d,data:{id:b,order:c}}),d?d.order=c:s.get().orders.push({id:b,order:c})))},show:function(a){for(var b=_.chunk(a,40),c=[],d=function(a){return new Promise(function(b){e.generate(a).then(function(a){e.display(a,!0)}).then(b)})},f=0,g=b.length;g>f;f++)c.push(d(b[f]));return Promise.all(c)},sort:function(){var b=arguments[0]||[];if(window.scroll(0,0),!this.hasClass("active")){var c=this;a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1)),k.hover.call(this).toggleClass("sortBy",!0),e.display(_.sortByOrder(e.cells,["book."+[c.getAttribute("by")]],"desc"!==c.getAttribute("sort")),b[0]||!1,b[1]||!1)}}},f=function(){var b;switch(this.setCustomValidity(""),this.name){case"confirmPwd":b=this.value!==a.one("@newPwd").value;break;case"filtre":b=!!this.value.length&&this.value.length<3;break;case"name":b=this.value.length<4;break;case"newPwd":b=this.value.length<4||this.value.length>12;break;case"pwd":b=this.value.length<4||this.value.length>12;break;case"recommand":b=this.value.toLowerCase()===s.get().id;break;case"searchinput":b=this.value.length<3;break;case"title":b=this.value.length<6}b&&this.setCustomValidity(this.getAttribute("error"))},g=new ColorThief,h={action:function(){var b=h.data.book.id,c=s.get().book(b)||h.data.book,d=this.getAttribute("actclick");this.add=function(){if(b)q.emit("addDetail"),a.alls('[actclick="upload"]').toggle(!h.data.book.cover),h.newCell();else{for(var c,d=a.one("#formNew").formToJson(),e=a.alls("#formNew input, #formNew textarea"),f=0,g=e.length;g>f;f++)if(!e[f].reportValidity()){c=!0;break}if(d.authors=d.authors?d.authors.split(","):[],d.authors.noSpace(),c)return!1;u.over(),q.emit("newbook",d)}},this.associated=function(){a.one("#wa").isVisible()||o.associated(b)},this.update=function(){var d=!1,e={id:b},f=_.map(a.alls("#userTags > div").toArray(),function(a){return a.one(".libelle").text()}),g=a.one("#userNote").value,h=a.one("#userComment").value,i=a.one("#detailCover").getAttribute("mainColor"),j=a.one("#detailCover").getAttribute("src")!==images["book-4-icon"].black?a.one("#detailCover").getAttribute("src"):null;if(_.isObject(b)&&b.user===s.get().id){var k=a.one("#formNew").formToJson();k.authors=k.authors.split(",")||[],_.forEach(k,function(a,b){a=a.noSpace(),_.isEqual(c[b],a)||(d=!0,e.update||(e.update={}),e.update[b]=a)})}(g||c.userNote)&&g!==c.userNote&&(d=!0,e.userNote=g),(h||c.userComment)&&h!==c.userComment&&(d=!0,e.userComment=h),(f.length||c.tags&&c.tags.length)&&!_.isEqual(f,c.tags)&&(d="tags",e.tags=f),i&&c.alternative!==j&&(d=!0,e.alternative=j,e.mainColor=i),d&&(e.userDate=(new Date).toJSON(),q.emit("updateBook",e),s.get().updatebook(e),r.init(),a.one("#tags").toggle(!!r.cloud.length&&a.one("#collection").hasClass("active"))),v.close()},this.upload=function(){a.one("#uploadHidden [type=file]").trigger("click")},this.preview=function(){a.one("@previewid").value=b,u.over(!0),v.open.call("previewWindow").then(function(b){a.one("#preview").submit()})},this.google=function(){window.open(this.getAttribute("link"))},this.recommand=function(){u.over(),v.open.call("recommandWindow")},this.close=function(){u.over(!1),this.closest("window").fade(!1).then(function(a){delete v.on,a&&a.one("iframe")&&window.frames.iPreview&&window.frames.iPreview.document.getElementById("viewer")&&(window.frames.iPreview.document.getElementById("viewer").innerHTML="")})},this[d].call(this)},clickNote:function(){var b=a.one("#userNote"),c=this.getAttribute("note");b.value===c&&"1"===b.value?b.value=0:b.value=c,h.userNote()},data:{},links:function(){if(!a.one("#wa").isVisible()){var b=this.getAttribute("searchby"),c=this.text();b&&c&&(a.one("#formSearch [type=search]","").value=c,a.alls("#formSearch [name=searchby]")[b].checked=!0,o.books.call(a.one("#formSearch")))}},mainColor:function(a){var b=g.getColor(a),c="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:c}},modify:function(){if(this.hasClass("modify")){if(this.hasClass("hide"))for(var a=this.siblings("[name]"),b=0,c=a.length;c>b;b++)a[b].value=a[b].getAttribute("oldvalue");this.toggleClass("hide"),this.siblings("[field]:not(.noValue), [name]").toggle(null);var d=this.siblings("[name]")[0];d.focus(),"textarea"===d.tagName.toLowerCase()&&(d.scrollTop=0)}},mouseNote:function(){var b=a.one("#userNote").value||0,c=this.getAttribute("note"),d=a.alls("[note]").toArray();if(b!==c)for(var e=0;e<Math.max(b,c);e++)e<Math.min(b,c)?d[e].src=images[d[e].getAttribute("select")].black:b>c?d[e].src=images[d[e].getAttribute("hoverminus")].black:d[e].src=images[d[e].getAttribute("hoverplus")].black},"new":function(){h.data.book={},h.show(!1),a.one("#formNew").reset(),a.alls("#formNew input, #formNew textarea, .volumeInfo:not(.nonEditable), .volumeInfo:not(.nonEditable) button").toggle(!0),a.alls("#formNew [field]").toggle(!1)},newCell:function(){a.alls("[actclick=add], [actclick=update], #upload, .inCollection").toggle(),s.get().addbook(h.data.book),a.one("#collection").hasClass("active")&&e.display()},sendNotif:function(){var b=this.formToJson();return b.book=h.data.book.id,b.title=h.data.book.title,h.data.book.alt&&(b.alt=h.data.book.alt),q.emit("sendNotif",b),a.one("#recommandWindow img").trigger("click"),!1},show:function(b){var c=h.data.book,d=a.one("#detailWindow");a.one("#formNew").reset(),a.one("#formRecommand").reset(),d.alls("#formNew input, #formNew textarea").toggle(!1),d.alls("#formNew button:not(.categories)").toggleClass("hide",!1).toggleClass("modify",!!c.id&&_.isEqual(c.id.user,s.get().id)),d.one("#detailWindow [type=file]").value="",a.alls("#comments *").removeAll(),a.one("#userComment").value="",d.css({background:"whitesmoke","max-height":~~(.95*window.innerHeight)});for(var e=0,f=a.alls("[note]").length;f>e;e++)k.blur.call(a.alls("[note]")[e]);a.one("#userNote").value=c.note,d.alls(".inCollection").toggle(!!b),r.list(),c.mainColor?d.css({background:"radial-gradient(whitesmoke 40%, "+c.mainColor+")"}):a.one("#detailCover").onload=function(){(c.alternative||c.base64)&&(c.mainColor=h.mainColor(this).hex,d.css({background:"radial-gradient(whitesmoke 40%, "+c.mainColor+")"}))},a.one("#detailCover").setAttributes("mainColor",null).src=c.alternative||c.base64||images["book-4-icon"].black,d.alls(".direct").text(""),d.alls("#userTags > div").removeAll(),d.one("#detailWindow .windowheader span").text(c.title||a.one("#detailWindow .windowheader span").getAttribute("label")),a.alls("[actclick=add]").toggle(!b),a.alls("[actclick=update], [actclick=recommand]").toggle(!!b),a.alls("[actclick=associated]").toggle(!!c.id&&!_.isObject(c.id)),a.alls("[actclick=preview]").toggle(!!c.access&&"NONE"!==c.access),a.alls("[actclick=google]").setAttributes({link:c.link}).toggle(!!c.link),a.alls("[actclick=upload]").toggle(!c.base64&&!c.cover&&!!b),d.alls(".comments").toggle(!!c.comments&&!!c.comments.length),d.alls("#detailWindow [field]").toggleClass("noValue",!1),d.alls("[field=authors] span").removeAll(),d.alls(".volumeInfo.nonEditable").toggle(!1),d.alls(".volumeInfo:not(.nonEditable)").toggle(!!c.id&&_.isEqual(c.id.user,s.get().id)),d.alls(".new").toggleClass("new",!1),h.userNote(),d.hasClass("notdisplayed")&&v.open.call("detailWindow").then(function(){a.one("#detailContent").css({height:d.clientHeight-d.one("header").clientHeight}),a.one(".detailBook").scrollTop=0}),_.forEach(c,function(b,e){var f=d.one("[field="+e+"]"),g=d.one("input[name="+e+"], textarea[name="+e+"]");switch(f&&"subtitle"!==e&&(f.closest("volumeInfo").toggle(!!b||_.isEqual(c.id.user,s.get().id)),f.toggle(!!b).toggleClass("noValue",!b)),e){case"authors":for(var i=0,j=b.length;j>i;i++)f.newElement("span",{"class":"link",searchby:3}).text(b[i]);g.value=b.join(", "),g.setAttribute("oldvalue",b.join(", ")),f.parentNode.alls("button").toggle(!!b.length);break;case"tags":for(var k=a.one("#userTags"),l=0,m=b.length;m>l;l++)k.appendChild(r["new"](b[l]));break;case"userNote":b&&h.clickNote.call(a.one('[note="'+b+'"]'));break;case"userComment":a.one("#userComment").value=b;break;case"comments":var n,o=0;b.length||d.one(".comments").toggle(!1);for(var p=0,q=b.length;q>p;p++){if(b[p].comment){var t=a.one("#tempComment").cloneNode(!0);t.removeAttribute("id"),t.one(".commentAuthor").text(b[p].name),t.one(".commentDate").text(b[p].date.fd()),t.one(".commentNote").text(b[p].note),t.one(".commentComment").html(b[p].comment),a.one("#comments").appendChild(t)}b[p].note&&(n=(n||0)+parseInt(b[p].note,10),o++)}"undefined"!=typeof n&&o&&(n=(n/o).toFixed(2),a.one(".subtitle").toggle(!0),a.one("#mNote").text(n));break;default:if(!f)break;_.isArray(b)&&(b=b.join(", ")),g&&(g.setAttribute("oldvalue",b),g.value=b,g.scrollTop=0),"time"===f.tagName.toLowerCase()&&(f.setAttribute("datetime",new Date(b)),b=b.fd()),"description"===e?f.html(b):f.text(b)}}),a.alls(".link").setEvents("click",h.links,!1)},uploadCover:function(){var b=this.files;if(b[0]){if(!b[0].type.match(/image.*/)||b[0].size>1e5)return v.confirm("error",'Veuillez sélectionner un fichier de type "image" inférieure à 100KB.'),!1;var c=new FileReader;c.onload=function(b){return function(c){b.onload=function(){var b=h.mainColor(this);this.toggleClass("new",!0).setAttribute("mainColor",b.hex),a.one("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+b.hex+")")},b.src=c.target.result}}(a.one("#detailCover")),c.readAsDataURL(this.files[0])}},userNote:function(){for(var b=a.alls("[note]").toArray(),c=a.one("#userNote").value,d=0;d<b.length;d++)c>d?b[d].src=images[b[d].getAttribute("select")].black:b[d].src=images[b[d].getAttribute("source")].black}},i={dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(b){b.preventDefault();var c=e.one(JSON.parse(b.dataTransfer.getData("text"))).cell,d=b.target.closest("bookcell");return a.one(".description")&&a.one(".description").removeAll(),d?c!==d&&(d.closest("col").insertBefore(c,d),e.loadcovers(),a.one("#collection").hasClass("active")&&a.one("#selectedTag").html()&&!a.one("@filtre").value&&a.one("#saveorder").toggle(!0),a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))):(this.appendChild(c),a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1)),a.one("#collection").hasClass("active")&&!a.one("@filtre").value&&a.one("#saveorder").toggle(!0)),!1},get:function(){var b,c=a.one("#d");if(c||(c=a.body.newElement("section",{id:"d",role:"main"}),c.newElement("section",{"class":"notdisplayed"})),b=(c.clientWidth/i.nbcols).toFixed(0),c.alls(".col").length!==i.nbcols){c.alls(".col").removeAll();for(var d=0;d<i.nbcols;d++)c.newElement("div",{"class":"col",colid:d}).css({width:b,"max-width":b});c.css({"padding-top":a.one("#nvb").isVisible()?a.one("#nvb").clientHeight:0}),a.alls(".col").setEvents({dragenter:i.dragenter,dragover:i.dragover,drop:i.drop})}return c},nbcols:~~(window.innerWidth/256),remove:function(){a.alls(".col")&&a.alls(".col").removeEvent("dragenter",i.dragenter).removeEvent("dragover",i.dragover).removeEvent("drop",i.drop),a.one("#d")&&(a.one("#d").removeAll(),window.scroll(0,0))},resize:function(){i.nbcols!==~~(window.innerWidth/256)?(r.close().then(r.destroy),a.alls(".deroulant").fade(!1),i.nbcols=~~(window.innerWidth/256),i.remove(),e.display()):a.alls(".col").css({width:~~(window.innerWidth/i.nbcols),"max-width":~~(window.innerWidth/i.nbcols)}),a.one("#detailWindow").isVisible()&&a.one("#detailWindow").css({height:~~(.95*window.innerHeight),"max-height":~~(.95*window.innerHeight)})}},j={deleteDetail:function(a){j.db&&j.db.transaction(["details"],"readwrite").objectStore("details")["delete"](a)},deleteQuery:function(a){j.db&&j.db.transaction(["queries"],"readwrite").objectStore("queries")["delete"](a)},getDetail:function(a){return new Promise(function(b){j.db||b();var c=j.db.transaction(["details"],"readwrite").objectStore("details").index("by_id").get(a);c.onsuccess=function(){this.result?b(this.result):b()},c.onerror=function(){b()}})},getQuery:function(a){return new Promise(function(b,c){j.db||c();var d=j.db.transaction(["queries"],"readwrite").objectStore("queries").index("by_query").get(JSON.stringify(a));d.onsuccess=function(){this.result&&this.result.books&&this.result.books.length?b(this.result.books):c()},d.onerror=c})},init:function(){return j.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,new Promise(function(a,b){if(j.indexedDB){var c=indexedDB.open(s.get().session,1);c.onerror=function(){b()},c.onsuccess=function(){j.db=this.result,a()},c.onupgradeneeded=function(){var a=this.result;a.createObjectStore("queries",{keyPath:"query"}).createIndex("by_query","query",{unique:!0}),a.createObjectStore("details",{keyPath:"id"}).createIndex("by_id","id",{unique:!0})}}})},setDetail:function(a){if(j.db){j.db.transaction(["details"],"readwrite").objectStore("details").put(a)}},setQuery:function(a,b){if(j.db){j.db.transaction(["queries"],"readwrite").objectStore("queries").put({query:JSON.stringify(a),books:b})}}},k={active:function(){var b=a.one(".active"),c=this.one("img");return b&&(b.toggleClass("active",!1),k.blur.call(b)),this.toggleClass("active",!0),a.one("#tags").toggle("collection"===this.id&&!!r.cloud&&!!r.cloud.length),c&&(c.src=images[c.getAttribute("source")][c.getAttribute("active")]),this},blur:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("blur")],a.isVisible()||a.hasClass("nsv")||a.css({visibility:"visible"})),this)},hover:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("hover")]),this)}},l=function(){return u.toggle(!0),s.destroy(),j.indexedDB&&j.indexedDB.deleteDatabase(s.get().session),location.assign("/logout"),!1},m={close:function(b){var c=b.target.closest("action");a.one("#contextMenu").isVisible()&&!b.target.getAttribute("nav")&&a.one("#contextMenu").fade(!1),c&&_.includes(["notifications","tris"],c.getAttribute("id"))||a.alls(".deroulant").fade(!1)},context:function(b){b.preventDefault();var c=a.one("#contextMenu");return!a.one("#detailWindow").isVisible()||a.one("#w").hasClass("over")||_.isEmpty(h.data.book)||c.css({top:b.clientY+c.clientHeight>window.innerHeight?b.clientY-c.clientHeight:b.clientY,left:b.clientX+c.clientWidth>window.innerWidth?b.clientX-c.clientWidth:b.clientX}).fade(!0),!1},link:function(){window.open(this.getAttribute("url"))},mail:function(){a.location.href="mailto:"+this.getAttribute("mail")},nav:function(){if(!h.data.cell)return!1;var b=h.data.cell,c=b.index(),d=parseInt(b.parentNode.getAttribute("colid"),10);switch(this.getAttribute("nav")){case"top":if(!c)return!1;c--;break;case"right":d++,d===i.nbcols&&(d=0,c++);break;case"left":d||(d=i.nbcols,c--),d--;break;case"bottom":c++}return a.one('[colid="'+d+'"]').childNodes[c]&&a.one('[colid="'+d+'"]').childNodes[c].one("header").trigger("click"),!1},notif:function(b){var c=a.one("#notifs");b&&a.one("#sort").fade(!1),c.isVisible()?c.fade(!1):c.css({top:a.one("#nvb").clientHeight+5,left:a.one("#notifications").offsetLeft}).fade(!0)},selectstart:function(a){return a.preventDefault(),a.target.tagName&&!_.includes(["input","textarea"],a.target.tagName.toLowerCase())?!1:void 0},show:function(){k.hover.call(a.one("#sort img")),a.alls("#tags, #notifications").toggle(!1)},sort:function(b){var c=a.one("#sort");b&&a.one("#notifs").fade(!1),c.isVisible()?c.fade(!1):c.css({top:a.one("#nvb").clientHeight+5,left:a.one("#tris").offsetLeft}).fade(!0)},toggle:function(){a.alls(".nvb").fade().then(function(){a.one("#d")&&a.one("#d").css({"padding-top":a.one("#nvb").isVisible()?a.one("#nvb").clientHeight:0})})},toggleFooter:function(){a.one("#footer").toggle(!!w().top)},top:function(){var a=setInterval(function(){var b=(w().top/2-.1).toFixed(1);window.scroll(0,b),.1>=b&&(window.scroll(0,0),clearInterval(a))},100)}},n={click:function(){var b=JSON.parse(this.getAttribute("notif"));b._id.book;_.remove(n.list,b),n.last=b,a.one("#notifs").toggle(),this.removeAll(),a.alls("#notifications, #notifNumber").toggle(!!n.list.length),a.one("#notifNumber").text(n.list.length),u.toggle(!0,!0),q.emit("readNotif",b)},show:function(b){b&&(n.list=b),a.alls("#notifications, #notifNumber").toggle(!!n.list.length),a.one("#notifNumber").text(n.list.length);for(var c=0,d=n.list.length;d>c;c++){var e=n.list[c],f=a.one("#tempNotif").cloneNode(!0);f.setAttributes({notif:JSON.stringify(e)}).removeAttribute("id"),f.one(".notifName").html(e.from),f.one(".notifTitle").text(e.title),f.setEvents("click",n.click),a.one("#notifs").appendChild(f)}}},o={associated:function(a){o.clear(),o.last={associated:a},v.close(!0).then(function(){u.toggle(!0,!0),j.getQuery(o.last).then(e.show,function(){u.anim(!0),q.emit("associated",a)})["catch"](function(a){})})},books:function(){var b=this.formToJson();return o.last={q:b.searchby+b.searchinput,langRestrict:b.langage},a.one("@filtre").value=a.one("@last").value="",o.clear(),v.close(!0).then(function(){u.toggle(!0,!0),j.getQuery(o.last).then(e.show)["catch"](function(){u.anim(!0),q.emit("searchBooks",o.last)})}),!1},clear:function(){e.destroy(),i.remove(),k.active.call(a.one("#recherche")),a.one("#formFilter").reset(),a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1)),a.one("#selectedTag").text("").parentNode.toggle(!1),a.one("#saveorder").toggle(!1)},endRequest:function(b){u.anim(!1),b||u.toggle(!1),!a.one("#collection").hasClass("active")&&o.last&&j.setQuery(o.last,e.books)},gtrans:function(){var b=this.id;v.confirm("warning",a.one("#importNow").getAttribute("message")).then(function(c){c&&v.close(!0).then(function(){"exportNow"===b?(q.emit("exportNow"),u.toggle(!1)):(q.emit("importNow"),e.destroy(),k.active.call(a.one("#collection")),u.anim(!0),u.toggle(!0,!0))})})},recommand:function(){o.clear(),o.last={recommand:s.get().id},v.close(!0).then(function(){u.toggle(!0,!0),j.getQuery(o.last).then(e.show)["catch"](function(){u.anim(!0),q.emit("recommanded")})})}},p=function(b){if(b=b||window.event,!b.altKey)if(b.ctrlKey){var c;if(-1!==[77,76,82,80,66,69,73,72].indexOf(b.keyCode)&&a.one("#wa").isVisible())c=!0;else switch(b.keyCode){case 77:m.toggle(),c=!0;break;case 76:l(),c=!0;break;case 82:a.one("#recherche").trigger("click"),c=!0;break;case 80:a.one("#profil").trigger("click"),c=!0;break;case 66:a.one("#collection").trigger("click"),c=!0;break;case 69:a.one("#tags").trigger("click"),c=!0;break;case 73:a.one("#contact").trigger("click"),c=!0;break;case 72:a.one("#help").trigger("click"),c=!0}if(c)return b.preventDefault(),!1}else 27===b.keyCode&&(v.close(),r.close(),a.one("#contextMenu").fade(!1))},q=function(c){var d=function(){var d=c.connect({secure:!0,multiplex:!1});return d.on("error",function(a){l()}).once("connect",function(){b=new Date,this.once("disconnect",function(b){f(this),s.destroy(),v.close().then(function(){u.toggle(!0,!0),u.connection(!0),a.one("#selectedTag").html("").parentNode.toggle(!1),a.alls(".deroulant").toggle(!1),a.one("#picture img")&&a.one("#picture img").removeAll(),a.alls("#notifications, #tags").toggle(!1),a.one(".active")&&k.blur.call(a.one(".active").toggleClass("active",!1));for(var b=a.alls("form"),c=0,d=b.length;d>c;c++)b[c].reset();e.destroy()})}).on("books",e.show).on("initCollect",function(a){s.get().collection.assign(a),s.get().loading.push(t.initCollect(a))}).on("endCollect",function(b){b.books&&(s.get().collection.assign(b.books),s.get().loading.push(t.initCollect(b.books))),Promise.all(s.get().loading).then(function(){s.get().collection=e.cells,a.one("#sort [by]").trigger("click"),r.init(),n.show(b.notifs),o.endRequest(e.cells.length),a.one("#nbBooks").text(s.get().collection.length)})}).on("covers",function(b){var c=new Promise(function(c){for(var d=0,e=b.length;e>d;d++)if(b[d]&&b[d].id&&(b[d].base64||b[d].alternative)){var f=b[d],g=s.get().bookcell(f.id);g&&(g.book?(f.base64&&(g.book.base64=f.base64),f.alternative&&(g.book.alternative=f.alternative),g.cell&&(g.cell.hasClass("toshow")||(g.cell.one(".cover").src=f.base64||f.alternative),
h.data.book&&h.data.book.id===f.id&&(a.one("#detailCover").src=f.base64||f.alternative))):(f.base64&&(g.base64=f.base64),f.alternative&&(g.alternative=f.alternative)))}c()}).then(function(){});return c}).on("endRequest",o.endRequest).on("logout",l).on("newbook",function(a){h.bookid=a.id,h.data={book:a},h.newCell(),h.show(!0),u.over(!1)}).on("returnAdd",t.addbook).on("returnDetail",e.returned).on("returnNotif",function(a){h.bookid=a.id,h.data={book:a},h.show(-1!==s.get().bookindex(a.id))}).on("updateNok",t.nokdated).on("updateOk",t.updated).on("user",function(a){m.show(),s.get().init(a),j.db||j.init(),u.toggle(!1)}).emit("isConnected")}),d},f=function(a){var b=setInterval(function(){a&&a.connected&&"open"===a.io.readyState&&(clearInterval(b),q=d());try{a.connect()}catch(c){}},3e3)};return d()}(io),r={add:function(){var b=this.formToJson().tag.toLowerCase(),c=a.alls("#userTags > div").toArray(),d=_.find(c,function(a){return a.one(".libelle").html()===b});if(!d){c.push(r["new"](b,!0)),c=_.sortBy(c,function(a){return a.one(".libelle").text()});for(var e=0,f=c.length;f>e;e++)a.one("#userTags").appendChild(c[e])}return this.reset(),!1},close:function(){return new Promise(function(b){a.one("#cloud").isVisible()?r.show().then(b):(u.over(!1),b())})},destroy:function(){a.alls("#cloud span").removeAll()},generate:function(){var b=a.one("#cloud"),c=~~(b.clientHeight/2),d=~~(b.clientWidth/2),f=d/c,g=3,h=[],i=function(a,b){for(var c=function(a,b){return Math.abs(2*a.offsetLeft+a.offsetWidth-2*b.offsetLeft-b.offsetWidth)<a.offsetWidth+b.offsetWidth&&Math.abs(2*a.offsetTop+a.offsetHeight-2*b.offsetTop-b.offsetHeight)<a.offsetHeight+b.offsetHeight},d=0,e=b.length;e>d;d++)if(c(a,b[d]))return!0;return!1},j=function(){r.show(),a.one("#saveorder").toggle(!1),e.bytags(this.text()),u.toggle(!1)};r.destroy();for(var k=0,l=r.cloud.length;l>k;k++){var m=r.cloud[k],n=b.newElement("span",{title:m.weight,"class":"tag tag"+Math.min(~~(m.weight/5)+1,10)}).html(m.text),o=c-n.clientHeight/2,p=d-n.clientWidth/2,q=0,s=6.28*Math.random();for(n.css({top:o,left:p});i(n,h);)q+=g,s+=(k%2===0?1:-1)*g,o=c+q*Math.sin(s)-n.clientHeight/2,p=d-n.clientWidth/2+q*Math.cos(s)*f,n.css({top:o,left:p});h.push(n)}b.alls("span").setEvents("click",j)},init:function(){var b=_.countBy(_.flatten(_.compact(_.pluck(s.get().collection,"book.tags")),!0).sort());if(r.cloud=[],r.destroy(),b){var c="";_.forEach(b,function(a,b){r.cloud.push({text:b,weight:a}),c+="<option>"+b+"</option>"}),a.one("#tagsList").html(c),r.cloud=_.sortBy(r.cloud,"weight").reverse(),a.one("#collection").hasClass("active")&&a.one("#tags").toggle(!_.isEmpty(b))}},list:function(){a.one("@tag").setAttributes({list:this.value?"tagsList":"none"})},"new":function(b,c){var d=a.one("#tempTag").cloneNode(!0);return d.removeAttribute("id"),d.setEvents("click",function(b){b.target.hasClass("libelle")?v.close().then(e.bytags(b.target.text())):this.fade(!1).then(function(){d.removeAll(),a.one("#detailWindow [autofocus]").focus()})}),d.one(".libelle").html(b).toggleClass("new",!!c),d},show:function(){var b=a.one("#cloud"),c=b.isVisible();return new Promise(function(d){a.one("#wa").isVisible()||!a.one("#collection").hasClass("active")?d():v.close().then(function(){a.one("html").toggleClass("overflown",!c),b.toggle(!c),d(),c||b.alls("span").length||r.generate()})})}},s=function(){var b,c=function(){};return c.prototype.init=function(c){return _.assign(this,c),this.collection=this.loading=[],this.picture&&this.link&&a.one("#picture").toggle(!0).newElement("img",{src:this.picture,title:"Google+"}).setEvents("click",function(){window.open(b.link)}),a.alls(".gSignIn").toggle(!!this.googleSignIn),a.alls(".noSignIn").toggle(!this.googleSignIn),a.one("#changePwd").css({visibility:this.googleSignIn?"hidden":"visible"}),a.one(".noSignIn input").setAttributes("required",!this.googleSignIn),this.connex||v.help(!0),this},c.prototype.addbook=function(b){var c=new d(b),f=e.one(b.id);return c.cell.one(".add").toggle(!1),c.cell.one(".remove").toggle(!0),this.collection.push(c),a.one("#nbBooks").text(this.collection.length),f&&(f.cell.one(".add").toggle(!1),f.cell.one(".remove").toggle(!0),f.cell.isVisible()&&(f.book=b,b.base64&&(f.cell.one(".cover").src=b.base64))),f},c.prototype.bookcell=function(a){return _.find(this.collection,_.matchesProperty("id",a))},c.prototype.book=function(a){var b=this.bookcell(a);return b&&b.book?b.book:null},c.prototype.bookindex=function(a){return _.findIndex(this.collection,_.matchesProperty("id",a))},c.prototype.removebook=function(b){_.remove(this.collection,_.matchesProperty("id",b)),a.one("#nbBooks").text(this.collection.length)},c.prototype.updatebook=function(a){_.assign(a,a.update),delete a.update;var b=this.bookcell(a.id)||e.one(a.id);_.assign(b.book,a),a.title&&b.cell.one("header").text(a.title),a.authors&&b.cell.one("figcaption").text(a.authors.join(", ")),a.alternative&&(b.cell.one(".cover").src=a.alternative)},{get:function(){return b||(b=new c),b},destroy:function(){b=!1}}}(),t={addbook:function(a){s.get().addbook(a)},initCollect:function(b){return a.one("#collection").hasClass("active")||k.active.call(a.one("#collection").toggleClass("active",!0)),new Promise(function(a){u.anim(!0),b&&b.length?e.show(b).then(a):a()})},collection:function(b){return new Promise(function(b){if(v.close(),a.one("@filtre").value=a.one("@last").value=a.one("#selectedTag").innerHTML="",a.one("#selectedTag").parentNode.toggle(!1),a.one("#saveorder").toggle(!1),a.one("#collection").hasClass("active"))window.scroll(0,0),a.alls(".bookcell").toggleClass("tofilter tohide",!1),a.one("#sort [by]").trigger("click"),b();else{var c=a.one(".sortBy");e.destroy(),e.cells=s.get().collection,c&&0===c.index()?c&&k.blur.call(c.toggleClass("sortBy",!1)):k.hover.call(a.one("[by]").toggleClass("sortBy",!0)),u.anim(!0),u.toggle(!0,!0),k.active.call(a.one("#collection")),e.display(!1,!1,!0).then(function(a){o.endRequest(a),b()})}})},"delete":function(){return a.one("#errPwd").toggle(!1),s.get().googleSignIn||a.one("@pwd").reportValidity()?(v.confirm("warning",a.one("#delete").getAttribute("confirm")).then(function(b){b&&q.emit("deleteUser",a.one("@pwd").value)}),!1):void 0},nokdated:function(){return a.one("#errPwd").toggle(!0),!1},update:function(){return a.one("#errPwd").fade(!1),q.emit("updateUser",this.formToJson()),!1},updated:function(a){s.get().name=a.name,s.get().googleSync=a.googleSync,v.close()}},u={anim:function(b){a.one("#wa").isVisible()!==b&&(a.one("#wa").fade(b),a.one("#nvb").toggleClass("inactive",b))},over:function(b){a.one("#w").toggleClass("over",b)},toggle:function(b,c){var d=a.one("#w");d.one("img").toggle(!!c),u.connection(!1),d.isVisible()!==b&&(a.alls(".description").removeAll(),b?(a.one("html").toggleClass("overflown",!0),d.toggle(!0)):(d.toggle(!1),a.one("html").toggleClass("overflown",!1),u.over(!1)))},connection:function(b){var c=a.one("#noConnect"),d=function(a){c.css({top:c.clientHeight+a.clientY>window.innerHeight?a.clientY-c.clientHeight:a.clientY,left:c.clientWidth+a.clientX>window.innerWidth?a.clientX-c.clientWidth:a.clientX})};b?(a.setEvents({mousemove:d}),setTimeout(function(){c.toggle(b)},2e3)):(a.removeEventListener("mousemove",d),c.toggle(b))}},v={close:function(b){return new Promise(function(c){var d=a.alls(".window:not(.notdisplayed)"),e=a.alls("form:not(#formFilter)");if(u.over(!1),a.one("#h").isVisible()&&v.help(!1),d){d.fade(!1).then(function(){delete v.on,c()}),b!==!0&&u.toggle();for(var f=0,g=e.length;g>f;f++)e[f].reset()}else c()})},confirm:function(b,c){return new Promise(function(d,e){u.over(),a.one("#confirmWindow header span").text(a.one("#confirmWindow header span").getAttribute(b)),a.one("#confirmWindow #confirm").text(c),a.one("#confirmWindow .valid").setEvents("click",function(){u.over(!1),a.one("#confirmWindow").fade(!1),d(!0)}),a.one("#confirmWindow .cancel").toggle("warning"===b).setEvents("click",function(){u.over(!1),a.one("#confirmWindow").fade(!1),d(!1)}),u.toggle(!0),a.one("#confirmWindow").css({top:w().top+10,left:"25%"}).fade(!0),a.setEvents({"keyup keydown":Window.esc})})},esc:function(a){27===a.keyCode&&v.close()},help:function(b){b!==a.one("#h").isVisible()&&("boolean"!=typeof b&&(b=!a.one("#h").isVisible()),b?v.close().then(function(){a.one("html").toggleClass("overflown",!0),a.one("#h").toggle(!0)}):(a.one("html").toggleClass("overflown",!1),a.one("#h").toggle(!1)))},open:function(){var b=this;return new Promise(function(c,d){var e="string"==typeof b?b:b.getAttribute("window"),f=a.one("#"+e);v.on&&v.on===e?v.close().then(c):(a.one("#h").isVisible()&&v.help(!1),r.close().then(function(){_.includes(["previewWindow","recommandWindow"],e)?u.over(!0):a.alls(".window:not(.notdisplayed)").fade(!1),"profileWindow"===e&&(a.one("@mail").value=s.get().id,a.one("@name").value=s.get().name,s.get().googleSignIn?(a.one("@googleSignIn").checked=!0,a.one("@googleSync").checked=!!s.get().googleSync):a.one("@pwd").setAttribute("required",!0),a.one(".changePwd.notdisplayed")||v.togglePwd()),a.alls(".errMsg").toggle(!1),u.toggle(!0),v.on=e,f.css({top:w().top+10}).fade(!0).then(function(){f.one("[autofocus]")&&f.one("[autofocus]").focus(),c()})}))})},togglePwd:function(){a.alls(".changePwd").fade().then(function(a){for(var b=0,c=a.length;c>b;b++)a[b].alls("[type=password]").setAttributes({required:a[b].isVisible()})})}},w=function(){return{top:window.scrollY||a.documentElement.scrollTop,left:window.scrollX||a.documentElement.scrollLeft}};d.prototype.active=function(){if(!this.actived){var b=function(){var b=this.classList;m.cell.alls("button").fade(),_.includes(b,"add")&&q.emit("addBook",m.id),_.includes(b,"remove")&&(a.one("#collection").hasClass("active")&&m.cell.fade().then(function(){m.cell.removeAll(),e.loadcovers()}),q.emit("removeBook",m.id),s.get().removebook(m.id),m.book.tags&&m.book.tags.length&&r.init())},c=function(b){if(b.relatedTarget&&!b.relatedTarget.hasClass("description")&&a.alls(".description").removeAll(),"mouseenter"===b.type&&m.book.description){var c=m.book.description.indexOf(" ",500),d=function(){this.removeAll()},e={"max-height":window.innerHeight,left:Math.min(this.xposition()+this.clientWidth/3,window.innerWidth-1.333*this.clientWidth).toFixed(0)},f=(this.offsetTop+this.clientHeight/3).toFixed(0),g=a.body.newElement("div",{width:this.clientWidth,bookid:m.id,"class":"description notdisplayed"}).css({width:this.clientWidth}).setEvents("click",d).html("<span>"+m.book.title+"</span><BR>"+m.book.description.substr(0,Math.max(c,500))+(-1!==c?"...":""));f+g.clientHeight>a.clientHeight?e.bottom=.333*this.clientHeight:e.top=f,g.css(e),setTimeout(function(){g.setEvents("mouseleave",d).fade(!0)},1e3)}},d=function(){m.cell.alls("button").removeEvent("click",b),m.cell.alls("header, figure").removeEvent("click",f),m.cell.removeEvent("mouseenter mouseleave",c).removeEvent("dragstart",g).removeEvent("dragend",i).removeAll()},f=function(){var a=-1!==s.get().bookindex(m.id);return a||m.opened?(h.data=m,h.show(!!a)):j.getDetail(m.id).then(function(a){a?(h.data.book=a,h.show(!1)):(u.toggle(!0,!0),q.emit("searchDetail",m.id))}),!1},g=function(a){this.toggleClass("isDrag",!0),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("text",JSON.stringify(k))},i=function(){this.toggleClass("isDrag",!1)},k=this.id,l=function(){if(m.cell.hasClass("toshow")){var a=m.cell.one(".cover");a&&window.innerHeight+w().top>m.cell.offsetTop&&(m.cell.toggleClass("toshow",!1),m.cell.setEvents({dragstart:g,dragend:i}),(m.book.alternative||m.book.base64)&&(a.src=m.book.alternative||m.book.base64),m.cell.one("footer").css({bottom:m.cell.one("figcaption").clientHeight+5}))}},m=this;this.cell.one("footer").css({bottom:this.cell.one("figcaption").clientHeight+5}),this.actived=!0,this.destroy=d,this.loadcover=l,this.cell.alls("header, figure").setEvents("click",f),this.cell.alls("button").setEvents("click",b),this.cell.setEvents({mouseenter:c,mouseleave:c,dragstart:g,dragend:i})}},d.prototype.returned=function(a){this.book=a,this.opened=!0,h.data=this,h.show(),j.setDetail(a)},a.setEvents({keypress:p,keydown:p,scroll:e.loadcovers}),a.alls("input").setEvents("input propertychange",f),a.one("#logout").setEvents("click",l),a.alls("#h button, #help").setEvents({click:v.help}),a.one("#formSearch").setEvents("submit",o.books),a.one("#formProfil").setEvents("submit",t.update),a.one("#formRecommand").setEvents("submit",h.sendNotif),a.one("#formTag").setEvents("submit",r.add),a.alls("form").setEvents("submit",function(a){a.preventDefault()}),a.alls("#formNew button").setEvents("click",h.modify),a.one("#changePwd").setEvents("click",v.togglePwd),a.one("#delete").setEvents("click",t["delete"]),a.one("#tris").setEvents("click",m.sort),a.one("#notifications").setEvents("click",m.notif),a.alls("#sort > div").setEvents("click",e.sort),a.alls("img[actclick]").setEvents({mouseenter:k.hover,mouseleave:k.blur}),a.alls("[actclick]").setEvents("click",h.action),a.alls(".closeWindow").setEvents("click",v.close),a.one("#footer").setEvents("click",m.top),a.alls("#uploadHidden [type=file]").setEvents("change",h.uploadCover),a.alls("#userNote > img").setEvents({mouseenter:h.mouseNote,mouseleave:h.userNote,click:h.clickNote}),a.alls(".nvb > div:not(#picture):not(.filtre), img.closeWindow, #footer, [by], .imgAction img, #cloud img, #contactsWindow img, [nav]").setEvents({mouseenter:k.hover,mouseleave:k.blur}),function(a){for(var b=0,c=a.length;c>b;b++)k.blur.call(a[b])}(a.alls("[blur]")),a.alls("img").setAttributes({draggable:!1}),a.one("#nvb").toggleClass("notdisplayed",!1),a.one("#collection").setEvents("click",t.collection),a.alls("#tags, #cloud > img").setEvents("click",r.show),a.alls("#recherche, #profil, #contact").setEvents("click",v.open),a.one("#newbook").setEvents("click",h["new"]),a.alls(".tnv").setEvents("click",m.toggle),a.alls("[url]").setEvents("click",m.link),a.alls("[mail]").setEvents("click",m.mail),a.one("#recommand4u").setEvents("click",o.recommand),a.alls("#importNow, #exportNow").setEvents("click",o.gtrans),a.alls("@tag").setEvents("input propertychange",r.list),a.one("#saveorder").setEvents("click",e.save),window.setEvents({contextmenu:m.context,resize:i.resize,click:m.close,selectstart:m.selectstart}),a.alls("[nav]").setEvents("click",m.nav),function(b){b?a.one("@filtre").setEvents("search",e.filter):a.one("#formFilter").setEvents("submit",function(b){return e.filter.call(a.one("@filtre")),!1})}("onsearch"in a.createElement("input"))}):alert(document.body.getAttribute("error"));
