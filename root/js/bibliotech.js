window.FileReader&&"formNoValidate"in document.createElement("input")?$(document).ready(function(){"use strict";console.debug("start",new Date),$.event.props.push("dataTransfer");var a,b=io(),c=new ColorThief,d="images/",e=function(){switch(this.name){case"searchinput":this.setCustomValidity(this.value.length<3?"La recherche doit contenir au moins 3 caractères!":"");break;case"name":this.setCustomValidity(this.value.length<4?"Le nom doit contenir au moins 4 caractères!":"");break;case"pwd":this.setCustomValidity(this.value.length<4||this.value.length>12?"Le mot de passe doit contenir entre 4 et 12 caractères!":"");break;case"newPwd":this.setCustomValidity(this.value.length<4||this.value.length>12?"Le mot de passe doit contenir entre 4 et 12 caractères!":"");break;case"confirmPwd":this.setCustomValidity(this.value!==$("[name=newPwd]").val()?"Les mots de passe ne sont pas identiques!":"");break;case"recommandinput":this.setCustomValidity(this.value.toLowerCase()===$("#mail").val()?"Vous ne pouvez pas vous notifier!":"")}},f=function(b){if(!b.id)return h();for(var c in b)this[c]=b[c];this.picture&&this.link&&($(".picture").html($("<img>").attr("src",this.picture).css({width:32,height:32,cursor:"pointer"})).attr("alt","Google+").click(function(){window.open(a.link)}),$(".gSignIn").toggleClass("notdisplayed")),this.books=[],this.first&&$("#profileWindow").trigger("click")},g=~~($(window).innerWidth()/256),h=function(){return a={},b.close(),window.location.assign("/logout")},i=function(){$(".navbar > div, .closeWindow, #footer, [by], .imgAction img").not(".picture").hover(p,q),$("[blur]").each(q),p.call($(".sort img").first()),$("img").attr("draggable",!1),$("#navbar").removeClass("notdisplayed"),$("#collection").click(o),$("#recherche, #profil, #contact, #newbook").click(A),$("#filtre").on("search",E),$(".togglenavbar").click(j)},j=function(){$(".sort").is(":visible")&&H(),$(".navbar").slideToggle(function(){$("#dock").animate({"padding-top":$("#navbar").is(":visible")?$("#navbar").height():0})})},k=function(){return{get:function(){var a=$("#dock").length?$("#dock"):$("<section>").prop("id","dock").attr("role","main").appendTo($("body")).append($("<section>").addClass("notdisplayed")),b=a.width()/g;if($(".col",a).length!==g){$(".col",a).remove();for(var c=[],d=0;g>d;d++)c.push($("<div>").addClass("col").attr("colid",d).css({width:b,"max-width":b}));a.css("padding-top",$("#navbar").is(":visible")?$("#navbar").height():0).append(c),$(".col").on({dragenter:function(){event.preventDefault()},dragover:function(){event.preventDefault()},drop:function(a){a.preventDefault();var b=a.dataTransfer.getData("cellId"),c=a.target;return $(c).closest(".bookcell").length?$("#"+b).insertBefore($(c).closest(".bookcell")):$("#"+b).appendTo($(this)),!1}})}return a},remove:function(){return $("#dock").remove()}}}(),l=function(a){a=a||_.sortBy($(".bookcell").appendTo($("<div>")),function(a){return[$(a).attr("row"),$(a).attr("col")]});var b=k.get(),c=0;$(a).each(function(a){var d=a%g,e=a/g;return $(this).attr("col",d).attr("row",e),$(this).hasClass("tohide")?$(this).removeClass("torotate tohide").appendTo($(".notdisplayed",b)):($(this).appendTo($("[colid="+c%g+"]",b)).css("visibility","hidden"),$("img",this).addClass("torotate"),void c++)}),$(".torotate").loadCovers().done(function(){F()})},m=function(a){if($(a.relatedTarget).hasClass("description")||$(".description").remove(),"mouseenter"===a.type&&$(a.relatedTarget).attr("bookid")!==$(this).data("book").id&&$(this).data("book").description){var b=$(this).data("book").description.indexOf(" ",500),c=function(){$(this).remove()},d={"max-height":$(window).height(),left:Math.min($(this).position().left+$(this).innerWidth()/3,$(window).innerWidth()-1.333*$(this).innerWidth())},e=$(this).position().top+$(this).innerHeight()/3,f=$("<div>").hide().width($(this).width()).appendTo($("body")).addClass("description").html($(this).data("book").description.substr(0,Math.max(b,500))+(-1!==b?"...":"")).prepend($("<span>").html($(this).data("book").title+"<BR>")).click(c).attr("bookid",$(this).data("book").id);e+f.outerHeight()>$(document).innerHeight()?d.bottom=.333*$(this).innerHeight():d.top=e,f.css(d),setTimeout(function(){f.show().mouseleave(c)},1e3)}},n=function(b){var c=[];for(var d in b){var e=_.findIndex(a.books,{id:b[d].id}),f=-1!==e?a.books[e]:b[d],g=$("#tempCell").clone().prop("id",f.id).data("book",f).addClass("bookcell").css("visibility","hidden");$("header",g).html(f.title),$("figcaption",g).html(f.authors?f.authors.join(", "):""),$("img",g).data("src",f.alternative||f.cover),$("article",g).attr("description",f.description||""),-1!==e?$(".add",g).hide():$(".remove",g).hide(),c.push(g)}l(c),console.debug("showBooks",new Date,b.length)},o=function(){$("#filtre").val(""),$("#collection").hasClass("active")?(l(),O(a.books.length)):(r.call("#collection"),k.remove(),n(a.books))},p=function(){var a=$(this).is("img")?$(this):$("img",this);return $(this).hasClass("active")||$(this).hasClass("sortBy")?!1:void a.attr("src",d+a.attr("hover"))},q=function(){var a=$(this).is("img")?$(this):$("img",this);return $(this).hasClass("active")||$(this).hasClass("sortBy")?!1:void a.attr("src",d+a.attr("blur"))},r=function(){$(".active").removeClass("active").each(q),$(this).addClass("active"),$("img",this).attr("src",d+$("img",this).attr("active"))},s=function(){t($(this).closest(".bookcell").data("book").id)},t=function(a){$("button","#"+a).toggle("slow"),b.emit("addBook",a)},u=function(){$(this).siblings(".bouton").show("slow"),$("#collection").hasClass("active")?$(this).closest(".bookcell").hide("slow",function(){$(this).remove()}):$(this).hide("slow"),b.emit("removeBook",$(this).closest(".bookcell").data("book").id),_.remove(a.books,{id:$(this).closest(".bookcell").data("book").id}),$("#nbBooks").html(a.books.length)},v=function(){event.preventDefault();var a=$(this).formToJSON();return k.remove(),r.call("#recherche"),b.emit("searchBooks",{q:a.searchby+a.searchinput,langRestrict:a.langage}),B(),$("#navbar").addClass("inactive"),$("#waitingAnim").show(),!1},w=function(){return event.preventDefault(),$("#errPwd").hide("slow"),b.emit("updateUser",$(this).formToJSON()),!1},x=function(b){return b?(a.name=b.name,a.googleSync=b.googleSync,B()):void $("#errPwd").show("slow")},y=function(){$("#formProfil [name=mail]").val(a.id),$("#formProfil [name=name]").val(a.name),a.googleSignIn?($("[name=googleSignIn]").prop("checked",!0),a.googleSync&&$("#formProfil [name=googleSync]").prop("checked",!0)):$("#formProfil [name=pwd]").attr("required",!0)},z=function(){return $("#errPwd").hide("slow"),document.getElementById("pwd").checkValidity()?(confirm("Cette opération est irréversible. Etes-vous de vouloir supprimer votre compte?")&&b.emit("deleteUser",$("#pwd").val()),!1):$("#errPwd").show("slow")},A=function(){var a=$.Deferred(),b=$(this).attr("window")||$(this);return"#profileWindow"===b&&(y(),$(".changePwd input").attr("required")&&G()),$(".errMsg").hide(),$(".sort").is(":visible")&&H(),F(1).then(function(){$(b).css("top",$(window).scrollTop()+10).show(),$(document).keyup(function(){27===event.keyCode&&B()}),$("[autofocus]",b).focus(),a.resolve()}),a.promise()},B=function(){$(document).unbind("keyup"),$(".window").slideUp("fast",function(){F()}),$("form").trigger("reset")},C=function(){var c=$(this).closest(".bookcell").data("book").id,d=_.find(a.books,{id:c});d?D(d,!0):b.emit("searchDetail",c)},D=function(a,b){A.call("#detailWindow").then(function(){$("#upload").toggle(!a.cover&&!!b),$("#detailContent").css("background","white"),$("#detailCover").on("load",function(){(a.alternative||a.cover)&&$("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+(a.mainColor||K(this).hex)+")")}),$("#detailCover").prop("src",a.alternative||a.cover||d+"iconmonstr-book-4-icon-grey.png"),$(".direct").text(""),$("#bookid").val(a.id),$(".windowheader span").text(a.title),$("[actclick=add]").toggle(!b),$("[actclick=update], [actclick=recommand]").toggle(!!b),$("[actclick=preview]").toggle("NONE"!==a.access),$("[actclick=google]").attr("link",a.link).toggle(!!a.link);for(var c in a)$("#"+c,"#detailWindow").html($("#"+c).hasClass("date")?a[c].formatDate():a[c])})},E=function(){var a=this.value.toLowerCase();a.length<3?$(".bookcell").removeClass("tohide"):$(".bookcell").each(function(){var b=$(this).data("book"),c=b.title.toLowerCase(),d=b.authors?b.authors.join(", ").toLowerCase():"",e=b.description.toLowerCase();$(this).toggleClass("tohide",-1===c.indexOf(a)&&-1===d.indexOf(a)&&-1===e.indexOf(a))}),l()},F=function(a,b){var c=$.Deferred();return $(".description").remove(),a?(b?$("img","#waiting").show():$("img","#waiting").hide(),$("html").addClass("overflown"),$("#waiting").slideDown("slow",function(){c.resolve()})):$("#waiting").slideUp("slow",function(){$("html").removeClass("overflown"),c.resolve()}),c.promise()},G=function(){$(".changePwd").slideToggle(function(){$("[type=password]",this).attr("required",$(this).is(":visible"))})},H=function(){$(".sort").css({top:$("#navbar").height()+5,left:$("#tris").offset().left}),$(".sort").slideToggle()},I=function(){H(),$(".sortBy").removeClass("sortBy"),q.call(".sortBy"),$(this).addClass("sortBy"),p.call(".sortBy");var a=$(this).attr("by"),b=$(this).attr("sort"),c=$(".bookcell").appendTo($("<div>"));c=_.sortBy(c,function(b){return $(b).data("book")[a]||null}),b&&c.reverse(),l(c)},J=function(){var a=new $.Deferred,b=$(this),c=b.closest(".bookcell");return!b.length||$(window).height()+$(window).scrollTop()<=c.offset().top?a.reject():(b.removeClass("torotate"),$(".add",c).click(s),$(".remove",c).click(u),$("img, .title, .authors",c).not(".bouton").click(C),b.data("src")&&b.attr("src",b.data("src")),c.css("visibility","visible").show(),$({deg:-90}).animate({deg:0},{duration:250,step:function(a){c.css({transform:"rotateX("+a+"deg)"})},complete:function(){a.resolve()}})),a.promise()},K=function(a){var b=c.getColor(a),d="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:d}},L=function(){var c=this.files;if(c[0]){if(!c[0].type.match(/image.*/)||c[0].size>1e6)return confirmWindow.altAlert("Veuillez sélectionner un fichier de type 'image' inférieure à 1MB."),!1;var d=new FileReader;d.onload=function(c){return function(d){var e=$("#bookid").val(),f=_.findIndex(a.books,{id:e});-1!==f&&(a.books[f].alternative=d.target.result,c.on("load",function(){var c=K(this);a.books[f].mainColor=c.hex,b.emit("altCover",{book:e,cover:d.target.result,mainColor:c.hex})}),c.prop("src",d.target.result),$("img","#"+e).prop("src",d.target.result))}}($("#detailCover")),d.readAsDataURL(this.files[0])}},M=function(){event.preventDefault(),console.debug($(this).formToJSON())},N=function(){var a=$("#bookid","#detailWindow").val(),b=$(this).attr("actclick"),c={add:function(){t(a),$("[actclick=add], [actclick=update], #upload").toggle()},preview:function(){$("[name=previewid]").val(a),A.call("#previewWindow").then(function(){$("#preview").submit()})},google:function(){window.open($(this).attr("link"))},close:function(){$("#previewWindow").slideUp()}};c[b].call(this)},O=function(a){console.debug("endRequest",new Date,a),$("#navbar").removeClass("inactive"),$("#waitingAnim").hide(),$(".bookcell").hover(m).on({dragstart:function(a){$(this).addClass("isDrag"),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("cellId",$(this).prop("id"))},dragend:function(){$(this).removeClass("isDrag"),$(".torotate").loadCovers()}})};$("[type=text], [type=search], [type=password]").on("input propertychange",e),$.fn.loadCovers=function(){return $.when(this.each(function(){J.call(this)}))},$.fn.formToJSON=function(){if(!this.is("form"))return!1;var a={};return _.forEach(this.serializeArray(),function(b){a[b.name]=b.value}),a},String.prototype.formatDate=function(){var a=this.split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),"le "+a},b.on("connect",function(){b.emit("connected")}),b.on("disconnect",function(){a={},$("#waiting").slideDown("slow"),F(1,1),k.remove()}),b.on("user",function(b){i(),a=new f(b),console.debug("user",new Date)}),b.on("collection",function(b){a.books=b.books,console.debug("collection",new Date),$("#nbBooks").html(a.books.length),$("#collection").trigger("click")}),b.on("books",function(a){n(a)}),b.on("endRequest",O),b.on("returnAdd",function(b){a.books.push(b),a.books=_.sortBy(a.books,"title"),$("#nbBooks").html(a.books.length)}),b.on("returnDetail",D),b.on("logout",h),b.on("updateOk",x),b.on("error",function(a){console.warn(a)}),$(document).on("scroll",function(){$(".torotate").loadCovers(),$("#footer").toggle(!!$(window).scrollTop())}),$("#logout").click(h),$("#formSearch").submit(v),$("#formProfil").submit(w),$("#formTag").submit(M),$("#changePwd").click(G),$("#delete").click(z),$("#tris").click(H),$(".sort > div").click(I),$("[actclick]").hover(p,q).click(N),$(".closeWindow").click(B),$("#footer").click(function(){$("body").animate({scrollTop:0})}),$("#upload").click(function(){$("[type=file]","#uploadHidden").trigger("click")}),$("[type=file]","#uploadHidden").change(L),$(window).resize(function(){g!==~~($(window).innerWidth()/256)&&(B(),g=~~($(window).innerWidth()/256),l())})}):alert("Veuillez installer une version plus récente de votre navigateur!!!");
