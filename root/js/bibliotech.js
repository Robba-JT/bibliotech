if(Array.prototype.noSpace=function(){for(var a=0,b=this.length;b>a;a++)"string"==typeof this[a]&&(this[a]=this[a].noSpace());return this},Element.prototype.closest=function(a){for(var b=this;b&&b.tagName&&"body"!==b.tagName.toLowerCase();){if(b.hasClass(a))return b;b=b.parentNode}return null},Element.prototype.css=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){_.includes(["width","max-width","height","max-height","top","left","bottom","padding-top"],c)&&-1===a.toString().indexOf("%")&&(a+="px"),b.style[c]=a}),this},Element.prototype.fade=function(a){var b=this,c="undefined"==typeof a?!b.isVisible():a,d=b.style.opacity;return new Promise(function(a){c&&(b.toggle(!0),d=0);var e=setInterval(function(){c?d>=(c||1)?(clearInterval(e),a(b)):b.style.opacity=(d+=.05).toFixed(2):0>=d?(clearInterval(e),b.toggle(!1),a(b)):b.style.opacity=(d-=.05).toFixed(2)},10)})},Element.prototype.formToJson=function(){var a={};return this.querySelectorAll("input, textarea").forEach(function(){(_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.checked||!_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.name)&&(a[this.name]=this.value)}),a},Element.prototype.hasClass=function(a){return this.classList.contains(a)},Element.prototype.html=function(a){return"undefined"==typeof a?this.innerHTML:(this.innerHTML=a,this)},Element.prototype.index=function(){for(var a=this.parentNode.childNodes,b=0,c=a.length;c>b;b++)if(a[b]===this)return b;return-1},Element.prototype.isVisible=function(){return this.offsetWidth>0&&this.offsetHeight>0},Element.prototype.newElement=function(a,b){var c=document.createElement(a);return _.isPlainObject(b)&&c.setAttributes(b),this.appendChild(c),c},Element.prototype.removeAttributes=function(a){var b=this;return"string"==typeof a&&(a=[a]),_.isArray(a)&&a.forEach(function(a){b.removeAttribute(a)}),this},Element.prototype.setAttributes=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){b.setAttribute(c,a)}),this},Element.prototype.setEvent=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvent(b,a,c)}),d):(this.addEventListener(a,b,c),this)},Element.prototype.siblings=function(a){return this.parentNode.all(a)},Element.prototype.text=function(a){return"undefined"==typeof a?this.textContent:(this.textContent=a,this)},Element.prototype.toggle=function(a){return("undefined"==typeof a||null===a)&&(a=!this.isVisible()),this.toggleClass("notdisplayed",!a),this},Element.prototype.trigger=function(a){var b;try{b=new Event(a)}catch(c){b=document.createEvent(_.includes(["click","mouseenter","mouseleave","mouseup","mousedown"],a)?"MouseEvents":"HTMLEvents"),b.initEvent(a,!0,!0)}return this.dispatchEvent(b),this},Element.prototype.xposition=function(){return this.parentNode&&this.parentNode.tagName?this.parentNode.offsetLeft:this.offsetLeft},Object.prototype.all=function(){var a,b=this&&this!==window?this:document,c=arguments[0],d=c.substr(0,1),e=c.substr(1,c.length);if(!d||!e)return[];if(e.multiSelect())a=b.querySelectorAll(c);else switch(d){case"#":a=[document.getElementById(e)];break;case"@":a=document.getElementsByName(e);break;case".":a=b.getElementsByClassName(e);break;default:a=b.getElementsByTagName(c)}return a},Object.prototype.css=function(a){return this.forEach(function(){this.css(this)}),this},Object.prototype.fade=function(a){var b=[];return this.forEach(function(){b.push(this.fade(a))}),Promise.all(b)},Object.prototype.forEach=function(a){var b=this;return("undefined"==typeof b.length||b===window)&&(b=[b]),[].forEach.call(b,function(b){a.call(b)}),this},Object.prototype.html=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.html(a)}),this)},Object.prototype.one=function(){var a,b=this&&this!==window?this:document,c=arguments[0],d=c.substr(0,1),e=c.substr(1,c.length);if(!d||!e)return null;if(e.multiSelect())a=b.querySelector(c);else switch(d){case"#":a=document.getElementById(e);break;case"@":a=document.getElementsByName(e)[0];break;case".":a=b.getElementsByClassName(e)[0];break;default:a=b.getElementsByTagName(c)[0]}return a},Object.prototype.removeAll=function(){return this.forEach(function(){this.remove?this.remove():this.parentNode.removeChild(this)}),this},Object.prototype.removeAttributes=function(a){return"string"==typeof attrs&&(a=[a]),this.forEach(function(){this.removeAttributes(a)}),this},Object.prototype.setAttributes=function(a){return this.forEach(function(){this.setAttributes(a)}),this},Object.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(a=a.split(" "),d.forEach(function(){var d=this;a.forEach(function(a){d.addEventListener(a,b,c)})}),d)},Object.prototype.text=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.text(a)}),this)},Object.prototype.toArray=function(){return[].slice.call(this)},Object.prototype.toggle=function(a,b){return this.forEach(function(){this.toggle(a,b)}),this},Object.prototype.toggleClass=function(a,b){a=a.split(" ");var c="toggle";return"undefined"!=typeof b&&(c=b?"add":"remove"),this.forEach(function(){var b=this;a.forEach(function(a){b.classList[c](a)})}),this},Object.prototype.trigger=function(a){return this.forEach(function(){this.trigger(a)}),this},String.prototype.fd=function(){var a=this.substr(0,10).split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),a},String.prototype.multiSelect=function(){return-1!==this.indexOf(" ")||-1!==this.indexOf(",")||-1!==this.indexOf(".")||-1!==this.indexOf("#")||-1!==this.indexOf(":")||-1!==this.indexOf("]")},String.prototype.noSpace=function(){return this.replace(/^\s+/g,"").replace(/\s+$/g,"")},window.FileReader&&window.Promise&&"formNoValidate"in document.createElement("input")){var µ=document;µ.setEvents("DOMContentLoaded",function(){"use strict";var a,b=(new Date,function(b,d){var e=c.cells.length+("undefined"==typeof d?1:d);return this.id=b.id,this.book=b,this.cell=one("#tempCell").cloneNode(!0).removeAttributes("id").toggleClass("bookcell",!0),this.cell.one("header").text(b.title),this.cell.one("figcaption").text(b.authors?b.authors.join(", "):""),this.cell.one(".previewable").toggle(!!b.access&&"NONE"!==b.access),this.cell.one(".recommanded").toggle(!!b.from),this.cell.one(".personnal").toggle(_.isEqual(b.id.user,a.id)),this.cell.one(".add").toggle(-1===a.bookindex(b.id)),this.cell.one(".remove").toggle(-1!==a.bookindex(b.id)),this.cell.col=e%g.nbcols,this.cell.row=Math.floor(e/g.nbcols),(b.alternative||b.base64)&&(this.cell.one(".cover").src=b.alternative||b.base64),this.active(),this}),c={add:function(a){c.cells=_.union(c.cells,_.isArray(a)?a:[a])},books:[],bytags:function(a){if(one("#collection").hasClass("active")){window.scroll(0,0),one("#formFilter").reset(),all(".bookcell").toggleClass("tofilter",!1),one("#selectedTag").html(a);for(var b=0,d=c.cells.length;d>b;b++){var e=c.cells[b];e.cell.toggleClass("tohide",!_.includes(e.book.tags,a))}c.display()}},cells:[],destroy:function(){g.remove(),c.cells=[]},display:function(a,b){return new Promise(function(d){if(!a&&one(".sortBy"))return c.sort.call(one(".sortBy"));a=a||_.sortBy(c.cells,function(a){return[a.row,a.col]});for(var e=0,f=g.get(),h=0,i=a.length;i>h;h++){var j=(a[h],a[h].cell);j.hasClass("tohide")||j.hasClass("tofilter")?g.get().one("section.notdisplayed").appendChild(j):(j.toggleClass("toshow",!0),f.one("[colid='"+(b?j.col:e%g.nbcols)+"']").appendChild(j),e++)}s.toggle(!1),c.loadcovers(),d(c.cells.length)})},filter:function(){var a=this.value.toLowerCase(),b=one("@last");if(this.checkValidity()&&a!==b.value){b.value=a;for(var d=0,e=c.cells.length;e>d;d++){var f=c.cells[d],g=f.book.title.toLowerCase(),h=f.book.subtitle?f.book.subtitle.toLowerCase():"",i=f.book.authors?f.book.authors.join(", ").toLowerCase():"",j=f.book.description.toLowerCase();f.cell.toggleClass("tofilter",-1===g.indexOf(a)&&-1===h.indexOf(a)&&-1===i.indexOf(a)&&-1===j.indexOf(a))}c.display()}},generate:function(d){return new Promise(function(e){for(var f=[],g=0,h=d.length;h>g;g++)if(!c.one(d[g].id)&&-1===_.findIndex(f,_.matchesProperty("id",d[g].id))){new b(a.book(d[g].id)||d[g],g);f.push(new b(a.book(d[g].id)||d[g],g))}c.add(f),!one("#collection").hasClass("active")&&m.last&&(c.books=_.flattenDeep(c.books.push(d))),e(f)})},loadcovers:function(){for(var a=0,b=c.cells.length;b>a;a++)c.cells[a].loadcover();k.toggleFooter()},one:function(a){return _.find(c.cells,_.matchesProperty("id",a))},returned:function(a){c.one(a.id).returned(a)},show:function(a){for(var b,d=_.chunk(a,40),e=function(a){return new Promise(function(b){c.generate(a).then(function(a){c.display(a,!0)}).then(b)})},f=0,g=d.length;g>f;f++)b=b?b.then(e(d[f])):b=e(d[f]);return b},sort:function(){if(window.scroll(0,0),!this.hasClass("active")){var a=this;one(".sortBy")&&i.blur.call(one(".sortBy").toggleClass("sortBy",!1)),i.hover.call(this).toggleClass("sortBy",!0),c.display(_.sortByOrder(c.cells,function(b){return b.book[a.getAttribute("by")]||null},"desc"!==a.getAttribute("sort")))}}},d=function(){var b;switch(this.setCustomValidity(""),this.name){case"confirmPwd":b=this.value!==one("@newPwd").value;break;case"filtre":b=!!this.value.length&&this.value.length<3;break;case"name":b=this.value.length<4;break;case"newPwd":b=this.value.length<4||this.value.length>12;break;case"pwd":b=this.value.length<4||this.value.length>12;break;case"recommand":b=this.value.toLowerCase()===a.id;break;case"searchinput":b=this.value.length<3;break;case"title":b=this.value.length<6}b&&this.setCustomValidity(this.getAttribute("error"))},e=new ColorThief,f={action:function(){var b,c=f.data.book.id,d=a.bookindex(c),e=this.getAttribute("actclick");-1!==d&&(b=a.books[d]),this.add=function(){if(c)o.emit("addDetail"),all("[actclick='upload']").toggle(!f.data.book.cover),f.newCell();else{for(var a,b=one("#formNew").formToJson(),d=all("#formNew input, #formNew textarea"),e=0,g=d.length;g>e;e++)if(!d[e].reportValidity()){a=!0;break}for(b.authors=b.authors?b.authors.split(","):[],e=0,g=b.authors.length;g>e;e++)b.authors[e]=b.authors[e].noSpace();if(a)return!1;s.over(),o.emit("newbook",b)}},this.associated=function(){m.associated(c)},this.update=function(){var d=!1,e={id:c},f=_.map(all("#userTags > div").toArray(),function(a){return a.one(".libelle").text()}),g=one("#userNote").value,h=one("#userComment").value,i=one("#detailCover").getAttribute("mainColor"),j=one("#detailCover").getAttribute("src")!==images["book-4-icon"].black?one("#detailCover").getAttribute("src"):null;if(_.isObject(c)&&c.user===a.id){var k=one("#formNew").formToJson();k.authors=k.authors.split(",")||[],_.forEach(k,function(a,c){a=a.noSpace(),_.isEqual(b[c],a)||(d=!0,e.update||(e.update={}),e.update[c]=a)})}(g||b.userNote)&&g!==b.userNote&&(d=!0,e.userNote=g),(h||b.userComment)&&h!==b.userComment&&(d=!0,e.userComment=h),(f.length||b.tags&&b.tags.length)&&!_.isEqual(f,b.tags)&&(d="tags",e.tags=f),i&&b.alternative!==j&&(d=!0,e.alternative=j,e.mainColor=i),d&&(e.userDate=(new Date).toJSON(),o.emit("updateBook",e),a.updatebook(e),p.init(),one("#tags").toggle(!!p.cloud.length&&one("#collection").hasClass("active"))),t.close()},this.upload=function(){one("#uploadHidden [type=file]").trigger("click")},this.preview=function(){one("@previewid").value=c,s.over(),t.open.call("previewWindow").then(function(a){one("#preview").submit()})},this.google=function(){window.open(this.getAttribute("link"))},this.recommand=function(){s.over(),t.open.call("recommandWindow")},this.close=function(){this.closest("window").fade(!1).then(function(){s.over(!1)})},this[e].call(this)},clickNote:function(){var a=one("#userNote"),b=this.getAttribute("note");a.value===b&&"1"===a.value?a.value=0:a.value=b,f.userNote()},data:{},links:function(){var a=this.getAttribute("searchby"),b=this.text();a&&b&&(one("#formSearch [type=search]","").value=b,all("#formSearch [name=searchby]")[a].checked=!0,one("#formSearch").trigger("submit"))},mainColor:function(a){var b=e.getColor(a),c="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:c}},modify:function(){if(this.hasClass("modify")){if(this.hasClass("hide"))for(var a=this.siblings("[name]"),b=0,c=a.length;c>b;b++)a[b].value=a[b].getAttribute("oldvalue");this.toggleClass("hide"),this.siblings("[field]:not(.noValue), [name]").toggle(null);var d=this.siblings("[name]")[0];d.focus(),"textarea"===d.tagName.toLowerCase()&&(d.scrollTop=0)}},mouseNote:function(){var a=one("#userNote").value||0,b=this.getAttribute("note"),c=all("[note]").toArray();if(a!==b)for(var d=0;d<Math.max(a,b);d++)d<Math.min(a,b)?c[d].src=images[c[d].getAttribute("select")].black:a>b?c[d].src=images[c[d].getAttribute("hoverminus")].black:c[d].src=images[c[d].getAttribute("hoverplus")].black},"new":function(){f.data.book={},f.show(!1),one("#formNew").reset(),all("#formNew input, #formNew textarea, .volumeInfo:not(.nonEditable), .volumeInfo:not(.nonEditable) button").toggle(!0),all("#formNew [field]").toggle(!1)},newCell:function(){all("[actclick=add], [actclick=update], #upload, .inCollection").toggle();var d=c.one(f.data.book.id);if(one("#collection").hasClass("active")&&!d){a.books.length%g.nbcols,all("[colid='"+a.books.length%g.nbcols+"'] .bookcell").length;d=new b(f.data.book),c.add(d),c.display()}d&&d.cell&&d.cell.all("button").fade(),a.addbook(f.data.book)},sendNotif:function(a){a.preventDefault();var b=this.formToJson();return b.book=f.data.book.id,b.title=f.data.book.title,f.data.book.alt&&(b.alt=f.data.book.alt),o.emit("sendNotif",b),one("#recommandWindow img").trigger("click"),!1},show:function(b){var c=f.data.book,d=one("#detailWindow");one("#formNew").reset(),one("#formRecommand").reset(),d.all("#formNew input, #formNew textarea").toggle(!1),d.all("#formNew button:not(.categories)").toggleClass("hide",!1).toggleClass("modify",!!c.id&&_.isEqual(c.id.user,a.id)),d.one("#detailWindow [type=file]").value="",one("#comments").children.removeAll(),one("#userComment").value="",d.css({background:"whitesmoke","max-height":~~(.95*window.innerHeight)});for(var e=0,g=all("[note]").length;g>e;e++)i.blur.call(all("[note]")[e]);one("#userNote").value=c.note,d.all(".new").toggleClass("new",!1),d.all(".inCollection").toggle(!!b),p.list(),c.mainColor?d.css({background:"radial-gradient(whitesmoke 40%, "+c.mainColor+")"}):one("#detailCover").onload=function(){(c.alternative||c.base64)&&(c.mainColor=f.mainColor(this).hex,d.css({background:"radial-gradient(whitesmoke 40%, "+c.mainColor+")"}))},one("#detailCover").setAttributes("mainColor",null).src=c.alternative||c.base64||images["book-4-icon"].black,d.all(".direct").text(""),d.all("#userTags > div").removeAll(),d.one("#detailWindow .windowheader span").text(c.title||one("#detailWindow .windowheader span").getAttribute("label")),all("[actclick=add]").toggle(!b),all("[actclick=update], [actclick=recommand]").toggle(!!b),all("[actclick=associated]").toggle(!!c.id&&!_.isObject(c.id)),all("[actclick=preview]").toggle(!!c.access&&"NONE"!==c.access),all("[actclick=google]").setAttributes({link:c.link}).toggle(!!c.link),all("[actclick=upload]").toggle(!c.base64&&!c.cover&&!!b),d.all(".comments").toggle(!!c.comments&&!!c.comments.length),d.all("#detailWindow [field]").toggleClass("noValue",!1),d.all("[field=authors] span").removeAll(),d.all(".volumeInfo.nonEditable").toggle(!1),d.all(".volumeInfo:not(.nonEditable)").toggle(!!c.id&&_.isEqual(c.id.user,a.id)),f.userNote(),d.hasClass("notdisplayed")&&t.open.call("detailWindow"),_.forEach(c,function(b,e){var g=d.one("[field="+e+"]"),h=d.one("input[name="+e+"], textarea[name="+e+"]");switch(g&&"subtitle"!==e&&(g.closest("volumeInfo").toggle(!!b||_.isEqual(c.id.user,a.id)),g.toggle(!!b).toggleClass("noValue",!b)),e){case"authors":for(var i=0,j=b.length;j>i;i++)g.newElement("span",{"class":"link",searchby:3}).text(b[i]);h.value=b.join(", "),h.setAttribute("oldvalue",b.join(", ")),g.parentNode.all("button").toggle(!!b.length);break;case"tags":for(var k=one("#userTags"),l=0,m=b.length;m>l;l++)k.appendChild(p["new"](b[l]));break;case"userNote":b&&f.clickNote.call(one("[note='"+b+"']"));break;case"userComment":one("#userComment").value=b;break;case"comments":var n,o=0;b.length||d.one(".comments").toggle(!1);for(var q=0,r=b.length;r>q;q++){if(b[q].comment){var s=one("#tempComment").cloneNode(!0);s.removeAttribute("id"),s.one(".commentAuthor").text(b[q].name),s.one(".commentDate").text(b[q].date.fd()),s.one(".commentNote").text(b[q].note),s.one(".commentComment").html(b[q].comment),one("#comments").appendChild(s)}b[q].note&&(n=(n||0)+parseInt(b[q].note,10),o++)}"undefined"!=typeof n&&o&&(n=(n/o).toFixed(2),one(".subtitle").toggle(!0),one("#mNote").text(n));break;default:if(!g)break;_.isArray(b)&&(b=b.join(", ")),h&&(h.setAttribute("oldvalue",b),h.value=b,h.scrollTop=0),"time"===g.tagName.toLowerCase()&&(g.setAttribute("datetime",new Date(b)),b=b.fd()),"description"===e?g.html(b):g.text(b)}}),all(".link").setEvents("click",f.links,!1)},uploadCover:function(){var a=this.files;if(a[0]){if(!a[0].type.match(/image.*/)||a[0].size>5e5)return t.confirm("error","Veuillez sélectionner un fichier de type 'image' inférieure à 500KB."),!1;var b=new FileReader;b.onload=function(a){return function(b){a.onload=function(){var a=f.mainColor(this);this.toggleClass("new",!0).setAttribute("mainColor",a.hex),one("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+a.hex+")")},a.src=b.target.result}}(one("#detailCover")),b.readAsDataURL(this.files[0])}},userNote:function(){for(var a=all("[note]").toArray(),b=one("#userNote").value,c=0;c<a.length;c++)b>c?a[c].src=images[a[c].getAttribute("select")].black:a[c].src=images[a[c].getAttribute("source")].black}},g={get:function(){var a,b=one("#d");if(b||(b=µ.body.newElement("section",{id:"d",role:"main"}),b.newElement("section",{"class":"notdisplayed"})),a=(b.clientWidth/g.nbcols).toFixed(0),b.all(".col").length!==g.nbcols){b.all(".col").removeAll();for(var d=0;d<g.nbcols;d++)b.newElement("div",{"class":"col",colid:d}).css({width:a,"max-width":a});b.css({"padding-top":one("#nvb").isVisible()?one("#nvb").clientHeight:0}),all(".col").setEvents({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(a){a.preventDefault();var b=c.one(JSON.parse(a.dataTransfer.getData("text"))).cell,d=a.target.closest("bookcell");return d?b!==d&&(d.closest("col").insertBefore(b,d),c.loadcovers(),one(".sortBy")&&i.blur.call(one(".sortBy").toggleClass("sortBy",!1))):(this.appendChild(b),one(".sortBy")&&i.blur.call(one(".sortBy").toggleClass("sortBy",!1))),!1}})}return b},nbcols:~~(window.innerWidth/256),remove:function(){one("#d")&&(one("#d").removeAll(),window.scroll(0,0))},resize:function(){g.nbcols!==~~(window.innerWidth/256)?(p.close().then(p.destroy),all(".deroulant").fade(!1),g.nbcols=~~(window.innerWidth/256),g.remove(),c.display()):all(".col").css({width:~~(window.innerWidth/g.nbcols),"max-width":~~(window.innerWidth/g.nbcols)}),one("#detailWindow").isVisible()&&one("#detailWindow").css({height:~~(.95*window.innerHeight),"max-height":~~(.95*window.innerHeight)})}},h={deleteDetail:function(a){h.db&&h.db.transaction(["details"],"readwrite").objectStore("details")["delete"](a)},deleteQuery:function(a){h.db&&h.db.transaction(["queries"],"readwrite").objectStore("queries")["delete"](a)},getDetail:function(a){return new Promise(function(b){h.db||b();var c=h.db.transaction(["details"],"readwrite").objectStore("details").index("by_id").get(a);c.onsuccess=function(){this.result?b(this.result):b()},c.onerror=function(){b()}})},getQuery:function(a){return new Promise(function(b,c){h.db||c();var d=h.db.transaction(["queries"],"readwrite").objectStore("queries").index("by_query").get(JSON.stringify(a));d.onsuccess=function(){this.result&&this.result.books?b(this.result.books):c()},d.onerror=c})},init:function(){return h.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,new Promise(function(b,c){if(h.indexedDB){var d=indexedDB.open(a.session,1);d.onerror=function(){c()},d.onsuccess=function(){h.db=this.result,b()},d.onupgradeneeded=function(){var a=this.result;a.createObjectStore("queries",{keyPath:"query"}).createIndex("by_query","query",{unique:!0}),a.createObjectStore("details",{keyPath:"id"}).createIndex("by_id","id",{unique:!0})}}})},setDetail:function(a){if(h.db){h.db.transaction(["details"],"readwrite").objectStore("details").put(a)}},setQuery:function(a,b){if(h.db){h.db.transaction(["queries"],"readwrite").objectStore("queries").put({query:JSON.stringify(a),books:b})}}},i={active:function(){var a=one(".active"),b=this.one("img");return a&&(a.toggleClass("active",!1),i.blur.call(a)),this.toggleClass("active",!0),one("#tags").toggle("collection"===this.id&&!!p.cloud.length),b&&(b.src=images[b.getAttribute("source")][b.getAttribute("active")]),this},blur:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("blur")],a.isVisible()||a.hasClass("nsv")||a.css({visibility:"visible"})),this)},hover:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("hover")]),this)}},j=function(){return s.toggle(!0),q.destroy(),h.indexedDB&&h.indexedDB.deleteDatabase(a.session),o.destroy(),location.assign("/logout"),!1},k={close:function(a){var b=a.target.closest("action");one("#contextMenu").isVisible()&&!a.target.getAttribute("nav")&&one("#contextMenu").fade(!1),b&&_.includes(["notifications","tris"],b.getAttribute("id"))||all(".deroulant").fade(!1)},context:function(a){a.preventDefault();var b=one("#contextMenu");return!one("#detailWindow").isVisible()||one("#w").hasClass("over")||_.isEmpty(f.data.book)||b.css({top:a.clientY+b.clientHeight>window.innerHeight?a.clientY-b.clientHeight:a.clientY,left:a.clientX+b.clientWidth>window.innerWidth?a.clientX-b.clientWidth:a.clientX}).fade(!0),!1},link:function(){window.open(this.getAttribute("url"))},mail:function(){µ.location.href="mailto:"+this.getAttribute("mail")},nav:function(){if(!f.data.cell)return!1;var a=f.data.cell,b=a.index(),c=parseInt(a.parentNode.getAttribute("colid"),10);switch(this.getAttribute("nav")){case"top":if(!b)return!1;b--;break;case"right":c++,c===g.nbcols&&(c=0,b++);break;case"left":c||(c=g.nbcols,b--),c--;break;case"bottom":b++}return one("[colid='"+c+"']").childNodes[b]&&one("[colid='"+c+"']").childNodes[b].one("header").trigger("click"),!1},notif:function(a){var b=one("#notifs");a&&one("#sort").fade(!1),b.isVisible()?b.fade(!1):b.css({top:one("#nvb").clientHeight+5,left:one("#notifications").offsetLeft}).fade(.95)},selectstart:function(a){return a.preventDefault(),a.target.tagName&&!_.includes(["input","textarea"],a.target.tagName.toLowerCase())?!1:void 0},show:function(){i.hover.call(one("#sort img")),all("#tags, #notifications").toggle(!1)},sort:function(a){var b=one("#sort");a&&one("#notifs").fade(!1),b.isVisible()?b.fade(!1):b.css({top:one("#nvb").clientHeight+5,left:one("#tris").offsetLeft}).fade(.95)},toggle:function(){all(".nvb").fade().then(function(){one("#d")&&one("#d").css({"padding-top":one("#nvb").isVisible()?one("#nvb").clientHeight:0})})},toggleFooter:function(){one("#footer").toggle(!!u().top)},top:function(){var a=setInterval(function(){var b=(u().top/2-.1).toFixed(1);window.scroll(0,b),.1>=b&&(window.scroll(0,0),clearInterval(a))},100)}},l={click:function(){var a=JSON.parse(this.getAttribute("notif"));a._id.book;_.remove(l.list,a),l.last=a,one("#notifs").toggle(),this.removeAll(),all("#notifications, #notifNumber").toggle(!!l.list.length),one("#notifNumber").text(l.list.length),s.toggle(!0,!0),o.emit("readNotif",a)},show:function(a){a&&(l.list=a),all("#notifications, #notifNumber").toggle(!!l.list.length),one("#notifNumber").text(l.list.length);for(var b=0,c=l.list.length;c>b;b++){var d=l.list[b],e=one("#tempNotif").cloneNode(!0);e.setAttributes({notif:JSON.stringify(d)}).removeAttribute("id"),e.one(".notifName").html(d.from),e.one(".notifTitle").text(d.title),e.setEvents("click",l.click),one("#notifs").appendChild(e)}}},m={associated:function(a){m.clear(),m.last={associated:a},t.close(!0).then(function(){s.toggle(!0,!0).then(function(){h.getQuery(m.last).then(c.show,function(){one("#nvb").toggleClass("inactive",!0),s.anim(!0),o.emit("associated",a)})})})},books:function(a){a.preventDefault();var b=this.formToJson();return m.last={q:b.searchby+b.searchinput,langRestrict:b.langage},one("@filtre").value=one("@last").value="",m.clear(),t.close(!0).then(function(){s.toggle(!0,!0).then(function(){h.getQuery(m.last).then(c.show)["catch"](function(){one("#nvb").toggleClass("inactive",!0),s.anim(!0),o.emit("searchBooks",m.last)})})}),!1},clear:function(){c.destroy(),g.remove(),i.active.call(one("#recherche")),one("#formFilter").reset(),one(".sortBy")&&i.blur.call(one(".sortBy").toggleClass("sortBy",!1)),one("#selectedTag").text("")},endRequest:function(a){one("#nvb").toggleClass("inactive",!1),s.anim(!1),a||s.toggle(!1),!one("#collection").hasClass("active")&&m.last&&h.setQuery(m.last,c.books)},gtrans:function(){var a=this.id;t.confirm("warning","Cette opération va importer/exporter vos EBooks depuis/vers votre bibliothèque Google.<BR>Etes vous sur de vouloir continuer?").then(function(){return"exportNow"===a?o.emit("exportNow"):(c.destroy(),i.active.call(one("#collection")),one("#nvb").toggleClass("inactive",!0),s.anim(!0),void t.close(!0).then(function(){s.toggle(!0,!0),o.emit("importNow")}))})},recommand:function(){m.clear(),m.last={recommand:a.id},t.close(!0).then(function(){s.toggle(!0,!0).then(function(){h.getQuery(m.last).then(c.show)["catch"](function(){one("#nvb").toggleClass("inactive",!0),s.anim(!0),o.emit("recommanded")})})})}},n=function(a){if(a=a||window.event,!a.altKey)if(a.ctrlKey){var b;switch(a.keyCode){case 77:k.toggle(),b=!0;break;case 76:j(),b=!0;break;case 82:one("#recherche").trigger("click"),b=!0;break;case 80:one("#profil").trigger("click"),b=!0;break;case 66:one("#collection").trigger("click"),b=!0;break;case 69:one("#tags").trigger("click"),b=!0;break;case 73:one("#contact").trigger("click"),b=!0;break;case 72:one("#help").trigger("click"),b=!0}if(b)return a.preventDefault(),!1}else 27===a.keyCode&&(t.close(),p.close(),one("#contextMenu").fade(!1))},o=function(b){var d=function(){var d=b.connect("localhost:5678",{secure:!0,multiplex:!1});return d.once("connect",function(){this.once("disconnect",function(a){e(this),q.destroy(),t.close().then(function(){s.toggle(!0,!0),s.connection(!0),all(".deroulant").toggle(!1),one("#picture img")&&one("#picture img").removeAll(),all("#notifications, #tags").toggle(!1),i.blur.call(one(".active").toggleClass("active",!1));for(var a=all("form"),b=0,d=a.length;d>b;b++)a[b].reset();c.destroy()})}).on("books",c.show).on("collection",function(b){a.books=b.books,p.init(),one("#collection").trigger("click"),one("#nbBooks").text(a.books.length),l.show(b.notifs)}).on("covers",function(b){for(var d=0,e=b.length;e>d;d++)if(b[d]&&b[d].index&&b[d].base64){var g=b[d],h=a.books[g.index],i=c.cells[g.index];if(h.base64=g.base64,i&&i.cell){var j=i.cell;j.hasClass("toshow")||(j.one(".cover").src=g.base64),f.data.book&&f.data.book.id===h.id&&(one("#detailCover").src=g.base64)}}}).on("endRequest",m.endRequest).on("error",function(a){}).on("logout",j).on("newbook",function(a){f.bookid=a.id,f.data={book:a},f.newCell(),f.show(!0),s.over(!1)}).on("returnAdd",r.addbook).on("returnDetail",c.returned).on("returnNotif",function(b){f.bookid=b.id,f.data={book:b},f.show(-1!==a.bookindex(b.id))}).on("updateNok",r.nokdated).on("updateOk",r.updated).on("user",function(b){k.show(),a=q.get().init(b),h.db||h.init()}).emit("isConnected")}),d},e=function(a){a.destroy();var b=setInterval(function(){a&&a.connected&&"open"===a.io.readyState&&(clearInterval(b),o=d());try{a.connect()}catch(c){}},3e3)};return d()}(io),p={add:function(a){a.preventDefault();var b=this.formToJson().tag.toLowerCase(),c=all("#userTags > div").toArray(),d=_.find(c,function(a){return a.one(".libelle").html()===b});if(!d){c.push(p["new"](b,!0)),c=_.sortBy(c,function(a){return a.one(".libelle").text()});for(var e=0,f=c.length;f>e;e++)one("#userTags").appendChild(c[e])}return this.reset(),!1},close:function(){return new Promise(function(a){one("#cloud").isVisible()?p.show().then(a):(s.over(!1),a())})},destroy:function(){all("#cloud span").removeAll()},generate:function(){var a=one("#cloud"),b=function(){p.show(),c.bytags(this.text()),s.toggle(!1)},d=~~(a.clientHeight/2),e=~~(a.clientWidth/2),f=e/d,g=3,h=[],i=function(a,b){for(var c=function(a,b){return Math.abs(2*a.offsetLeft+a.offsetWidth-2*b.offsetLeft-b.offsetWidth)<a.offsetWidth+b.offsetWidth&&Math.abs(2*a.offsetTop+a.offsetHeight-2*b.offsetTop-b.offsetHeight)<a.offsetHeight+b.offsetHeight},d=0,e=b.length;e>d;d++)if(c(a,b[d]))return!0;return!1};p.destroy();for(var j=0,k=p.cloud.length;k>j;j++){var l=p.cloud[j],m=a.newElement("span",{title:l.weight,"class":"tag tag"+Math.min(~~(l.weight/5)+1,10)}).html(l.text),n=d-m.clientHeight/2,o=e-m.clientWidth/2,q=0,r=6.28*Math.random();for(m.css({top:n,left:o});i(m,h);)q+=g,r+=(j%2===0?1:-1)*g,n=d+q*Math.sin(r)-m.clientHeight/2,o=e-m.clientWidth/2+q*Math.cos(r)*f,m.css({top:n,left:o});h.push(m)}a.all("span").setEvents("click",b)},init:function(){var b=_.countBy(_.flatten(_.compact(_.pluck(a.books,"tags")),!0).sort());if(p.cloud=[],p.destroy(),b){var c="";_.forEach(b,function(a,b){p.cloud.push({text:b,weight:a}),c+="<option>"+b+"</option>"}),one("#tagsList").html(c),p.cloud=_.sortBy(p.cloud,"weight").reverse()}},list:function(){one("@tag").setAttributes({list:this.value?"tagsList":"none"})},"new":function(a,b){var d=one("#tempTag").cloneNode(!0);return d.removeAttribute("id"),d.setEvent("click",function(a){a.target.hasClass("libelle")?t.close().then(c.bytags(a.target.text())):this.fade(!1).then(function(){d.removeAll(),one("#detailWindow [autofocus]").focus()})}),d.one(".libelle").html(a).toggleClass("new",!!b),d},show:function(){var a=one("#cloud"),b=a.isVisible();return new Promise(function(c){one("#wa").isVisible()||!one("#collection").hasClass("active")?c():t.close().then(function(){one("html").toggleClass("overflown",!b),b?a.fade(!1).then(c):a.fade(.9).then(function(){a.all("span").length||p.generate(),c()})})})}},q=function(){var b,d=function(){};return d.prototype.init=function(b){return _.assign(this,b),this.picture&&this.link&&one("#picture").toggle(!0).newElement("img",{src:this.picture,title:"Google+"}).setEvents("click",function(){window.open(a.link)}),all(".gSignIn").toggle(!!this.googleSignIn),all(".noSignIn").toggle(!this.googleSignIn),one(".noSignIn input").setAttributes("required",!this.googleSignIn),this.first&&t.help(!0),this},d.prototype.addbook=function(a){-1===this.bookindex(a.id)&&(this.books.push(a),this.books=_.sortBy(this.books,"title"));var b=c.one(a.id);b&&(b.book=a),one("#nbBooks").text(this.books.length)},d.prototype.book=function(a){return _.find(this.books,_.matchesProperty("id",a))},d.prototype.bookindex=function(a){return _.findIndex(this.books,_.matchesProperty("id",a))},d.prototype.removebook=function(a){return _.remove(this.books,_.matchesProperty("id",a)),this.books.length},d.prototype.updated=function(a){this.name=a.name,this.googleSync=a.googleSync,t.close()},d.prototype.updatebook=function(a){var b=this.bookindex(a.id);_.assign(a,a.update),delete a.update,-1!==b&&_.assign(this.books[b],a);var d=c.one(a.id);d&&(a.title||a.authors||a.alternative)&&(a.title&&d.cell.one("header").text(a.title),a.authors&&d.cell.one("figcaption").text(a.authors.join(", ")),a.alternative&&(d.cell.one(".cover").src=a.alternative))},{get:function(){return b||(b=new d),b},destroy:function(){b=!1}}}(),r={addbook:function(b){return a.addbook(b)},collection:function(){return t.close(),one("@filtre").value=one("@last").value=one("#selectedTag").innerHTML="",
one("#collection").hasClass("active")?(window.scroll(0,0),all(".bookcell").toggleClass("tofilter tohide",!1),one("#sort [by]").trigger("click")):(c.destroy(),s.anim(!0),s.toggle(!0,!0).then(function(){one("#nvb").toggleClass("inactive",!0),i.active.call(one("#collection")),a.books.length?c.show(a.books).then(m.endRequest):m.endRequest()})),!1},"delete":function(){return one("#errPwd").toggle(!1),one("@pwd").reportValidity()?(t.confirm("warning",one("#delete").getAttribute("confirm")).then(function(){o.emit("deleteUser",one("@pwd").value)}),!1):void 0},nokdated:function(){return one("#errPwd").toggle(!0),!1},update:function(){return one("#errPwd").fade(!1),o.emit("updateUser",this.serialize()),!1}},s={anim:function(a){one("#wa").fade(a)},over:function(a){one("#w").toggleClass("over",a)},toggle:function(a,b){return s.p=new Promise(function(c){var d=one("#w");d.one("img").toggle(!!b),d.isVisible()===a||t.on||s.on?c():(s.on=!0,all(".description").removeAll(),a?(one("html").toggleClass("overflown",!0),d.fade(.5).then(c)):d.fade(!1).then(function(){one("html").toggleClass("overflown",!1),s.over(!1),s.connection(!1),c()}))}),s.p.then(function(){delete s.on}),s.p},connection:function(a){var b=one("#noConnect"),c=function(a){b.css({top:b.clientHeight+a.clientY>window.innerHeight?a.clientY-b.clientHeight:a.clientY,left:b.clientWidth+a.clientX>window.innerWidth?a.clientX-b.clientWidth:a.clientX})};a?µ.setEvents({mousemove:c}):µ.removeEventListener("mousemove",c),b.toggle(a)}},t={close:function(a){return new Promise(function(b){var c=all(".window:not(.notdisplayed)"),d=all("form:not(#formFilter)");if(s.over(!1),one("#h").isVisible()&&t.help(!1),µ.removeEventListener("keyup",n),c.length){for(var e=0,f=d.length;f>e;e++)d[e].reset();c.fade(!1).then(function(){delete t.on,a===!0?b():s.toggle().then(b)})}else b()})},confirm:function(a,b){return new Promise(function(c,d){s.over(),one("#confirmWindow header span").text(one("#confirmWindow header span").getAttribute(a)),one("#confirmWindow #confirm").text(b),all("#confirmWindow button").setEvents("click",t.close),one("#confirmWindow .valid").setEvents("click",function(){c()}),one("#confirmWindow .cancel").toggle("warning"===a).setEvents("click",function(){d()}),s.toggle(!0).then(function(){one("#confirmWindow").css({top:u().top+10,left:"25%"}).fade(!0),µ.setEvents({"keyup keydown":Window.esc})})})},esc:function(a){27===a.keyCode&&t.close()},help:function(a){a!==one("#h").isVisible()&&("boolean"!=typeof a&&(a=!one("#h").isVisible()),a?t.close().then(function(){one("html").toggleClass("overflown",!0),one("#h").toggle(!0)}):(one("html").toggleClass("overflown",!1),one("#h").toggle(!1)))},open:function(){var b=this;return new Promise(function(c,d){var e="string"==typeof b?b:b.getAttribute("window"),f=one("#"+e);t.on&&t.on===e?t.close().then(c):(one("#h").isVisible()&&t.help(!1),p.close().then(function(){one("#wa").isVisible()&&c(),_.includes(["previewWindow","recommandWindow"],e)||all(".window:not(.notdisplayed)").fade(!1),"profileWindow"===e&&(one("@mail").value=a.id,one("@name").value=a.name,a.googleSignIn?(one("@googleSignIn").setAttribute("checked",!0),a.googleSync&&one("@googleSync").setAttribute("checked",!0)):one("@pwd").setAttribute("required",!0),one(".changePwd.notdisplayed")||t.togglePwd()),s.toggle(!0).then(function(){t.on=e,f.css({top:u().top+10}).fade(!0),f.one("[autofocus]")&&f.one("[autofocus]").focus(),c()}),all(".errMsg").toggle(!1)}))})},togglePwd:function(){all(".changePwd").fade().then(function(a){for(var b=0,c=a.length;c>b;b++)a[b].all("[type=password]").setAttributes({required:a[b].isVisible()})})}},u=function(){return{top:window.scrollY||µ.documentElement.scrollTop,left:window.scrollX||µ.documentElement.scrollLeft}};b.prototype.active=function(){if(!this.actived){var b=function(){var b=this.classList;l.cell.all("button").fade(),_.includes(b,"add")&&o.emit("addBook",l.id),_.includes(b,"remove")&&(one("#collection").hasClass("active")&&l.cell.fade().then(function(){l.cell.removeAll(),c.loadcovers()}),o.emit("removeBook",l.id),one("#nbBooks").text(a.removebook(l.id)),l.book.tags.length&&p.init())},d=function(a){if(a.relatedTarget&&!a.relatedTarget.hasClass("description")&&all(".description").removeAll(),"mouseenter"===a.type&&l.book.description){var b=l.book.description.indexOf(" ",500),c=function(){this.removeAll()},d={"max-height":window.innerHeight,left:Math.min(this.xposition()+this.clientWidth/3,window.innerWidth-1.333*this.clientWidth).toFixed(0)},e=(this.offsetTop+this.clientHeight/3).toFixed(0),f=µ.body.newElement("div",{width:this.clientWidth,bookid:l.id,"class":"description notdisplayed"}).css({width:this.clientWidth}).setEvents("click",c).html("<span>"+l.book.title+"</span><BR>"+l.book.description.substr(0,Math.max(b,500))+(-1!==b?"...":""));e+f.clientHeight>µ.clientHeight?d.bottom=.333*this.clientHeight:d.top=e,f.css(d),setTimeout(function(){f.setEvents("mouseleave",c).fade(.9)},1e3)}},e=function(){return-1!==a.bookindex(l.id)||l.opened?(f.data=l,f.show(-1!==a.bookindex(l.id))):h.getDetail(l.id).then(function(a){a?(f.data.book=a,f.show(!1)):(s.toggle(!0,!0),o.emit("searchDetail",l.id))}),!1},g=function(a){this.toggleClass("isDrag",!0),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("text",JSON.stringify(j))},i=function(){this.toggleClass("isDrag",!1)},j=this.id,k=function(){if(l.cell.hasClass("toshow")){var a=l.cell.one(".cover");a&&window.innerHeight+u().top>l.cell.offsetTop&&(l.cell.toggleClass("toshow",!1),l.cell.setEvents({dragstart:g,dragend:i}),(l.book.alternative||l.book.base64)&&(a.src=l.book.alternative||l.book.base64),l.cell.one("footer").css({bottom:l.cell.one("figcaption").clientHeight+5}))}},l=this;this.cell.all("header, figure").setEvents("click",e),this.cell.all("button").setEvents("click",b),this.cell.setEvents({"mouseenter mouseleave":d,dragstart:g,dragend:i}),this.cell.one("footer").css({bottom:this.cell.one("figcaption").clientHeight+5}),this.actived=!0,this.loadcover=k}},b.prototype.returned=function(a){this.book=a,this.opened=!0,f.data=this,f.show(),h.setDetail(a)},µ.setEvents({"keyup keydown":n,scroll:c.loadcovers}),all("input").setEvents("input propertychange",d),one("#logout").setEvent("click",j),all("#h button, #help").setEvents({click:t.help}),one("#formSearch").setEvent("submit",m.books),one("#formProfil").setEvent("submit",r.update),one("#formRecommand").setEvent("submit",f.sendNotif),one("#formTag").setEvent("submit",p.add),all("#formNew, #formFilter").setEvents("submit",function(a){a.preventDefault()}),all("#formNew button").setEvents("click",f.modify),one("#changePwd").setEvent("click",t.togglePwd),one("#delete").setEvent("click",r["delete"]),one("#tris").setEvent("click",k.sort),one("#notifications").setEvent("click",k.notif),all("#sort > div").setEvents("click",c.sort),all("img[actclick]").setEvents({mouseenter:i.hover,mouseleave:i.blur}),all("[actclick]").setEvents("click",f.action),all(".closeWindow").setEvents("click",t.close),one("#footer").setEvent("click",k.top),all("#uploadHidden [type=file]").setEvents("change",f.uploadCover),all("#userNote > img").setEvents({mouseenter:f.mouseNote,mouseleave:f.userNote,click:f.clickNote}),all(".nvb > div:not(#picture):not(.filtre), img.closeWindow, #footer, [by], .imgAction img, #cloud img, #contactsWindow img, [nav]").setEvents({mouseenter:i.hover,mouseleave:i.blur}),function(a){for(var b=0,c=a.length;c>b;b++)i.blur.call(a[b])}(all("[blur]")),all("img").setAttributes({draggable:!1}),one("#nvb").toggleClass("notdisplayed",!1),one("#collection").setEvent("click",r.collection),all("#tags, #cloud > img").setEvents("click",p.show),all("#recherche, #profil, #contact").setEvents("click",t.open),one("#newbook").setEvent("click",f["new"]),all(".tnv").setEvents("click",k.toggle),all("[url]").setEvents("click",k.link),all("[mail]").setEvents("click",k.mail),one("#recommand4u").setEvent("click",m.recommand),all("#importNow, #exportNow").setEvents("click",m.gtrans),all("@tag").setEvents("input propertychange",p.list),window.setEvents({contextmenu:k.context,resize:g.resize,click:k.close,selectstart:k.selectstart}),all("[nav]").setEvents("click",k.nav),function(a){a?one("@filtre").setEvent("search",c.filter):one("#formFilter").setEvent("submit",function(a){return c.filter.call(one("@filtre")),!1})}("onsearch"in µ.createElement("input"))})}else alert(document.body.getAttribute("error"));
