$(document).ready(function(){"use strict";console.debug("start",new Date),$.event.props.push("dataTransfer");var a,b,c=io(),d="images/",e=function(a){for(var b in a)this[b]=a[b]},f=function(){return a={},c.close(),window.location.assign("/logout")},g=function(){return a.picture&&a.link?void $(".picture").html($("<img>").prop("id","plusLink").attr("src",a.picture).css({width:32,height:32,cursor:"pointer"})).attr("alt","Google+").click(function(){window.open(a.link)}).removeClass("notdisplayed"):!1},h=function(){var a,c=$("#dock").length?$("#dock"):$("<div>").prop("id","dock").appendTo($("body"));if(b=Math.round(c.width()/256),a=Math.round(c.width()/b)+"px",$(".col",c).length!==b){$(".col",c).remove();for(var d=[],e=0;b>e;e++)d.push($("<div>").addClass("col").attr("colid",e).css({width:a,"max-width":a}));c.css("padding-top",$("#navbar").is(":visible")?$("#navbar").height():0).append(d),$(".col").on({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(a){a.preventDefault();var b=a.dataTransfer.getData("cellId"),c=a.target;return $(c).closest(".bookcell").length?$("#"+b).insertBefore($(c).closest(".bookcell")):$("#"+b).appendTo($(this)),!1}})}return c},i=function(c){var e=(h(),$("#collection").hasClass("active"));for(var f in c){var g=$("#tempCell").clone().attr("id",c[f].id).data("book",c[f]).addClass("bookcell").appendTo($("[colid="+$(".bookcell").length%b+"]")).css("visibility","hidden"),i=new Image,j=_.findIndex(a.books,{id:c[f].id});$(".title",g).html(c[f].title),$(".authors",g).html(c[f].authors?c[f].authors.join(", "):""),$(".cover",g).append($(i)),$(i).addClass("torotate").data("src",c[f].alternative||c[f].cover),$(".infos",g).attr("description",c[f].description||""),e||-1!==j?$(".ajouter",g).hide():$(".supprimer",g).hide(),i.src=d+"iconmonstr-book-4-icon-white.png"}$(".torotate").each(function(){$(this).loadCover()}),$(".bookcell").on({dragstart:function(a){$(this).addClass("isDrag"),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("cellId",$(this).prop("id"))},dragend:function(a){$(this).removeClass("isDrag")}}),$("#waiting").slideUp("slow"),console.debug("showBooks",new Date,c.length)},j=function(){$("#dock").remove(),i(a.books)},k=function(){console.debug("profil",a)},l=function(){return $(this).hasClass("active")?!1:void $("img",this).attr("src",d+$("img",this).attr("hover"))},m=function(){return $(this).hasClass("active")?!1:void $("img",this).attr("src",d+$("img",this).attr("blur"))},n=function(){$(".active").removeClass("active").each(m),$(this).addClass("active"),$("img",this).attr("src",d+$("img",this).attr("active"))},o=function(){$(this).siblings(".bouton").show("slow"),$(this).hide("slow"),c.emit("addBook",$(this).closest(".bookcell").data("book").id)},p=function(){$(this).siblings(".bouton").show("slow"),$("#collection").hasClass("active")?$(this).closest(".bookcell").hide("slow",function(){$(this).remove()}):$(this).hide("slow"),c.emit("removeBook",$(this).closest(".bookcell").data("book").id),_.remove(a.books,{id:$(this).closest(".bookcell").data("book").id})},q=function(){$("#dock").remove(),$("#waiting").slideDown("slow"),c.emit("searchBooks",{q:"joe+abercrombie"})},r=function(){var b=$(this).closest(".bookcell").data("book").id,d=_.find(a.books,{id:b});d?console.debug("book",d):c.emit("searchDetail",b)},s=function(){var a=this.value.toLowerCase(),b=$(".bookcell");return a.length<3?$(b).show():($(".bookcell").each(function(){var b=$(this).data("book"),c=b.title.toLowerCase(),d=b.authors?b.authors.join(", ").toLowerCase():"",e=b.description.toLowerCase();-1!==c.indexOf(a)||-1!==d.indexOf(a)||-1!==e.indexOf(a)?$(this).show():$(this).hide()}),void $(".torotate").each(function(){$(this).loadCover()}))};$.fn.loadCover=function(){var a=new $.Deferred,b=this,c=this.closest(".bookcell");return $(window).height()+$(window).scrollTop()<=c.offset().top?a.reject():(b.removeClass("torotate"),$(".ajouter",c).click(o),$(".supprimer",c).click(p),$("img, .title, .authors",c).not(".bouton").click(r),b.data("src")&&b.attr("src",b.data("src")).data("src",""),c.css("visibility","visible").show(),$({deg:-90}).animate({deg:0},{duration:250,step:function(a){c.css({transform:"rotateX("+a+"deg)"})},complete:function(){a.resolve()}})),a.promise()},c.on("user",function(b){a=new e(b),console.debug("user",new Date),g(),$("#navbar > div").not(".picture").hover(l,m),$("[blur]").closest("div").each(m),$("#recherche, #collection").click(n),$("img").attr("draggable",!1),$("#waitingAnim").addClass("notdisplayed"),$("#navbar").removeClass("notdisplayed"),$("#collection").click(j),$("#profil").click(k),$("#recherche").click(q),$("#filtre").on("keyup search",s)}),c.on("collection",function(b){a.books=b.books,console.debug("collection",new Date),$("#collection").click()}),c.on("books",function(a){i(a)}),c.on("endRequest",function(a){console.debug("endRequest",new Date,a)}),c.on("returnAdd",function(b){a.books.push(b),a.books=_.sortBy(a.books,"title")}),c.on("returnDetail",function(a){console.debug("returnDetail",a)}),c.on("logout",f),c.on("error",function(a){console.debug(a)}),$(document).on("scroll",function(){$(".torotate").each(function(){$(this).loadCover()})}),$("#logout").click(f)});
