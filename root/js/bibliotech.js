var checkValid=function(a){"use strict";switch(a.name){case"searchinput":a.setCustomValidity(a.value.length<3?"La recherche doit contenir au moins 3 caractères!":"");break;case"name":a.setCustomValidity(a.value.length<4?"Le nom doit contenir au moins 4 caractères!":"");break;case"pwd":a.setCustomValidity(a.value.length<4||a.value.length>12?"Le mot de passe doit contenir entre 4 et 12 caractères!":"");break;case"newPwd":a.setCustomValidity(a.value.length<4||a.value.length>12?"Le mot de passe doit contenir entre 4 et 12 caractères!":"");break;case"confirmPwd":a.setCustomValidity(a.value!==$("[name=newPwd]").val()?"Les mots de passe ne sont pas identiques!":"");break;case"recommandinput":a.setCustomValidity(a.value.toLowerCase()===$("#mail").val()?"Vous ne pouvez pas vous notifier!":"")}};$(document).ready(function(){"use strict";if(console.debug("start",new Date),!window.FileReader)return alert("Veuillez installer une version plus récente de votre navigateur!!!"),!1;$.event.props.push("dataTransfer");var a,b=io(),c="images/",d=function(b){if(!b.id)return f();for(var c in b)this[c]=b[c];this.picture&&this.link&&($(".picture").html($("<img>").attr("src",this.picture).css({width:32,height:32,cursor:"pointer"})).attr("alt","Google+").click(function(){window.open(a.link)}),$(".gSignIn").toggleClass("notdisplayed")),this.first&&$("#profileWindow").click()},e=~~($(window).innerWidth()/256),f=function(){return a={},b.close(),window.location.assign("/logout")},g=function(){$(".navbar > div, #footer, [by]").not(".picture").hover(n,o),$("[blur]").each(o),$("img").attr("draggable",!1),$("#waitingAnim").addClass("notdisplayed"),$("#navbar").removeClass("notdisplayed"),$("#collection").click(m),$("#recherche, #profil, #contact, #newbook").click(y),$("#filtre").on("keyup search",B),$(".togglenavbar").click(h)},h=function(){$(".sort").is(":visible")&&E(),$(".navbar").slideToggle(function(){$("#dock").animate({"padding-top":$("#navbar").is(":visible")?$("#navbar").height():0})})},i=function(){var a=$("#dock").length?$("#dock"):$("<div>").prop("id","dock").appendTo($("body")),b=99/e+"%";if($(".col",a).length!==e){$(".col",a).remove();for(var c=[],d=0;e>d;d++)c.push($("<div>").addClass("col").attr("colid",d).css({width:b,"max-width":b}));a.css("padding-top",$("#navbar").is(":visible")?$("#navbar").height():0).append(c),$(".col").on({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(a){a.preventDefault();var b=a.dataTransfer.getData("cellId"),c=a.target;return $(c).closest(".bookcell").length?$("#"+b).insertBefore($(c).closest(".bookcell")):$("#"+b).appendTo($(this)),!1}})}return a},j=function(a){i();for(var b in a)$(a[b]).appendTo($("[colid="+b%e+"]")).addClass("torotate").css("visibility","hidden");$(".torotate").each(function(){$(this).loadCover()})},k=function(a){if($(a.relatedTarget).hasClass("description")||$(".description").remove(),"mouseenter"===a.type&&$(a.relatedTarget).attr("bookid")!==$(this).data("book").id&&$(this).data("book").description){var b=$(this).data("book").description.indexOf(" ",500),c=function(){$(this).remove()},d={"max-height":$(window).height(),left:Math.min($(this).position().left+$(this).innerWidth()/3,$(window).innerWidth()-1.333*$(this).innerWidth())},e=$(this).position().top+$(this).innerHeight()/3,f=$("<div>").hide().width($(this).width()).appendTo($("body")).addClass("description").html($(this).data("book").description.substr(0,Math.max(b,500))+(-1!==b?"...":"")).prepend($("<span>").html($(this).data("book").title+"<BR>")).click(c).attr("bookid",$(this).data("book").id);e+f.outerHeight()>$(document).innerHeight()?d.bottom=.333*$(this).innerHeight():d.top=e,f.css(d),setTimeout(function(){f.show().mouseleave(c)},1e3)}},l=function(b){i();var c=$("#collection").hasClass("active");for(var d in b){var f=_.findIndex(a.books,{id:b[d].id}),g=-1!==f?a.books[f]:b[d],h=$("#tempCell").clone().attr("id",g.id).data("book",g).addClass("bookcell").appendTo($("[colid="+d%e+"]")).css("visibility","hidden");$(".title",h).html(g.title),$(".authors",h).html(g.authors?g.authors.join(", "):""),$("img",h).addClass("torotate").data("src",g.alternative||g.cover),$(".infos",h).attr("description",g.description||""),c||-1!==f?$(".ajouter",h).hide():$(".supprimer",h).hide()}$(".torotate").each(function(){$(this).loadCover()}),$(".bookcell").hover(k).on({dragstart:function(a){$(this).addClass("isDrag"),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("cellId",$(this).prop("id"))},dragend:function(a){$(this).removeClass("isDrag")}}),C(),console.debug("showBooks",new Date,b.length)},m=function(){p("#collection"),$("#dock").remove(),l(a.books)},n=function(){var a="img"===$(this).prop("tagName").toLowerCase()?$(this):$("img",this);return $(this).hasClass("active")||$(this).hasClass("sortBy")?!1:void a.attr("src",c+a.attr("hover"))},o=function(){var a="img"===$(this).prop("tagName").toLowerCase()?$(this):$("img",this);return $(this).hasClass("active")||$(this).hasClass("sortBy")?!1:void a.attr("src",c+a.attr("blur"))},p=function(a){var b=a.target||a;$(".active").removeClass("active").each(o),$(b).addClass("active"),$("img",b).attr("src",c+$("img",b).attr("active"))},q=function(){$(this).siblings(".bouton").show("slow"),$(this).hide("slow"),b.emit("addBook",$(this).closest(".bookcell").data("book").id)},r=function(){$(this).siblings(".bouton").show("slow"),$("#collection").hasClass("active")?$(this).closest(".bookcell").hide("slow",function(){$(this).remove()}):$(this).hide("slow"),b.emit("removeBook",$(this).closest(".bookcell").data("book").id),_.remove(a.books,{id:$(this).closest(".bookcell").data("book").id}),$("#nbBooks").html(a.books.length)},s=function(a){var b={};return _.forEach(a.serializeArray(),function(a){b[a.name]=a.value}),b},t=function(){event.preventDefault();var a=s($(this));return $("#dock").remove(),p("#recherche"),b.emit("searchBooks",{q:a.searchby+a.searchinput,langRestrict:a.langage}),z(),!1},u=function(){return event.preventDefault(),$("#errPwd").hide("slow"),b.emit("updateUser",s($(this))),!1},v=function(b){return b?(a.name=b.name,a.googleSync=b.googleSync,z()):void $("#errPwd").show("slow")},w=function(){$("#formProfil [name=mail]").val(a.id),$("#formProfil [name=name]").val(a.name),a.googleSignIn?($("[name=googleSignIn]").prop("checked",!0),a.googleSync&&$("#formProfil [name=googleSync]").prop("checked",!0)):$("#formProfil [name=pwd]").attr("required",!0)},x=function(){return $("#errPwd").hide("slow"),document.getElementById("pwd").checkValidity()?(confirm("Cette opération est irréversible. Etes-vous de vouloir supprimer votre compte?")&&b.emit("deleteUser",$("#pwd").val()),!1):$("#errPwd").show("slow")},y=function(){var a=$(this).attr("window");"#profileWindow"===a&&(w(),$(".changePwd input").attr("required")&&D()),$(".errMsg").hide(),C(1).then(function(){$(a).css("top",$(window).scrollTop()+10).show(),$(document).keyup(function(a){27===a.keyCode&&z()})})},z=function(){$(document).unbind("keyup"),$(".window").slideUp(C),$("form").trigger("reset")},A=function(){var c=$(this).closest(".bookcell").data("book").id,d=_.find(a.books,{id:c});d?console.debug("book",d):b.emit("searchDetail",c)},B=function(){var a=this.value.toLowerCase(),b=$(".bookcell");return a.length<3?$(b).show():($(".bookcell").each(function(){var b=$(this).data("book"),c=b.title.toLowerCase(),d=b.authors?b.authors.join(", ").toLowerCase():"",e=b.description.toLowerCase();-1!==c.indexOf(a)||-1!==d.indexOf(a)||-1!==e.indexOf(a)?$(this).show():$(this).hide()}),void $(".torotate").each(function(){$(this).loadCover()}))},C=function(a,b){var c=$.Deferred();return $(".description").remove(),a?(b?$("img","#waiting").show():$("img","#waiting").hide(),$("html").addClass("overflown"),$("#waiting").slideDown("slow",function(){c.resolve()})):($("html").removeClass("overflown"),$("#waiting").slideUp("slow",function(){c.resolve()})),c.promise()},D=function(){$(".changePwd").slideToggle(function(){$("[type=password]",this).attr("required",$(this).is(":visible"))})},E=function(){$(".sort").css({top:$("#navbar").height()+5,left:$("#tris").offset().left}),$(".sort").slideToggle()},F=function(){E(),$(".sortBy").removeClass("sortBy"),$(this).addClass("sortBy");var a=$(this).attr("by"),b=$(this).attr("sort"),c=$(".bookcell").toArray();c=_.sortBy(c,function(b){return $(b).data("book")[a]||null}),b&&c.reverse(),j(c)};$.fn.loadCover=function(){var a=new $.Deferred,b=this,c=this.closest(".bookcell");return $(window).height()+$(window).scrollTop()<=c.offset().top?a.reject():(b.removeClass("torotate"),$(".ajouter",c).click(q),$(".supprimer",c).click(r),$("img, .title, .authors",c).not(".bouton").click(A),b.data("src")&&b.attr("src",b.data("src")).data("src",""),c.css("visibility","visible").show(),$({deg:-90}).animate({deg:0},{duration:250,step:function(a){c.css({transform:"rotateX("+a+"deg)"})},complete:function(){a.resolve()}})),a.promise()},b.on("user",function(b){g(),a=new d(b),console.debug("user",new Date)}),b.on("collection",function(b){a.books=b.books,console.debug("collection",new Date),$("#nbBooks").html(a.books.length),$("#collection").click()}),b.on("books",function(a){l(a)}),b.on("endRequest",function(a){console.debug("endRequest",new Date,a)}),b.on("returnAdd",function(b){a.books.push(b),a.books=_.sortBy(a.books,"title"),$("#nbBooks").html(a.books.length)}),b.on("returnDetail",function(a){console.debug("returnDetail",a)}),b.on("logout",f),b.on("updateOk",v),b.on("error",function(a){console.debug(a)}),$(document).on("scroll",function(){$(".torotate").each(function(){$(this).loadCover()}),$(window).scrollTop()?$("#footer").show():$("#footer").hide()}),$("#logout").click(f),$("#formSearch").submit(t),$("#formProfil").submit(u),$("#changePwd").click(D),$("#delete").click(x),$("#tris").click(E),$(".sort > div").click(F),$(".windowheader > img").click(z).hover(n,o),$("#footer").click(function(){$("body").animate({scrollTop:0})})});
