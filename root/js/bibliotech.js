var checkValid=function(a){"use strict";switch(a.id){case"searchinput":a.setCustomValidity(a.value.length<3?"La recherche doit contenir au moins 3 caractères!":"");break;case"name":a.setCustomValidity(a.value.length<4?"Le nom doit contenir au moins 4 caractères!":"");break;case"pwd":a.setCustomValidity(a.value.length<4||a.value.length>12?"Le mot de passe doit contenir entre 4 et 12 caractères!":"");break;case"newPwd":a.setCustomValidity(a.value.length<4||a.value.length>12?"Le mot de passe doit contenir entre 4 et 12 caractères!":"");break;case"confirmPwd":var b=document.getElementById("newPwd").value;a.setCustomValidity(a.value!==b?"Les mots de passe ne sont pas identiques!":"");break;case"recommandinput":var c=$("#mail").val();a.setCustomValidity(a.value.toLowerCase()===c?"Vous ne pouvez pas vous notifier!":"")}};$(document).ready(function(){"use strict";if(console.debug("start",new Date),!window.FileReader)return alert("Veuillez installer une version plus récente de votre navigateur!!!"),!1;$.event.props.push("dataTransfer");var a,b=io(),c="images/",d=function(a){for(var b in a)this[b]=a[b]},e=~~($(window).innerWidth()/256),f=function(){return a={},b.close(),window.location.assign("/logout")},g=function(){return a.picture&&a.link?void $(".picture").html($("<img>").prop("id","plusLink").attr("src",a.picture).css({width:32,height:32,cursor:"pointer"})).attr("alt","Google+").click(function(){window.open(a.link)}).removeClass("notdisplayed"):!1},h=function(){var a=$("#dock").length?$("#dock"):$("<div>").prop("id","dock").appendTo($("body")),b=99/e+"%";if($(".col",a).length!==e){$(".col",a).remove();for(var c=[],d=0;e>d;d++)c.push($("<div>").addClass("col").attr("colid",d).css({width:b,"max-width":b}));a.css("padding-top",$("#navbar").is(":visible")?$("#navbar").height():0).append(c),$(".col").on({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(a){a.preventDefault();var b=a.dataTransfer.getData("cellId"),c=a.target;return $(c).closest(".bookcell").length?$("#"+b).insertBefore($(c).closest(".bookcell")):$("#"+b).appendTo($(this)),!1}})}return a},i=function(a){if($(a.relatedTarget).hasClass("description")||$(".description").remove(),"mouseenter"===a.type&&$(a.relatedTarget).attr("bookid")!==$(this).data("book").id&&$(this).data("book").description){var b=$(this).data("book").description.indexOf(" ",500),c={"max-height":$(window).height(),left:Math.min($(this).position().left+$(this).innerWidth()/3,$(window).innerWidth()-1.333*$(this).innerWidth())},d=$(this).position().top+$(this).innerHeight()/3,e=$("<div>").hide().width($(this).width()).appendTo($("body")).addClass("description").html($(this).data("book").description.substr(0,Math.max(b,500))+(-1!==b?"...":"")).prepend($("<span>").html($(this).data("book").title+"<BR>")).click(j).attr("bookid",$(this).data("book").id);d+e.outerHeight()>$(document).innerHeight()?c.bottom=.333*$(this).innerHeight():c.top=d,e.css(c),setTimeout(function(){e.show().mouseleave(j)},1e3)}},j=function(){$(this).remove()},k=function(b){h();var c=$("#collection").hasClass("active");for(var d in b){var f=_.findIndex(a.books,{id:b[d].id}),g=-1!==f?a.books[f]:b[d],j=$("#tempCell").clone().attr("id",g.id).data("book",g).addClass("bookcell").appendTo($("[colid="+d%e+"]")).css("visibility","hidden");$(".title",j).html(g.title),$(".authors",j).html(g.authors?g.authors.join(", "):""),$("img",j).addClass("torotate").data("src",g.alternative||g.cover),$(".infos",j).attr("description",g.description||""),c||-1!==f?$(".ajouter",j).hide():$(".supprimer",j).hide()}$(".torotate").each(function(){$(this).loadCover()}),$(".bookcell").hover(i).on({dragstart:function(a){$(this).addClass("isDrag"),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("cellId",$(this).prop("id"))},dragend:function(a){$(this).removeClass("isDrag")}}),x(),console.debug("showBooks",new Date,b.length)},l=function(){p("#collection"),$("#dock").remove(),k(a.books)},m=function(){console.debug("profil",a)},n=function(){var a="img"===$(this).prop("tagName").toLowerCase()?$(this):$("img",this);return $(this).hasClass("active")?!1:void a.attr("src",c+a.attr("hover"))},o=function(){var a="img"===$(this).prop("tagName").toLowerCase()?$(this):$("img",this);return $(this).hasClass("active")?!1:void a.attr("src",c+a.attr("blur"))},p=function(a){var b=a.target||a;$(".active").removeClass("active").each(o),$(b).addClass("active"),$("img",b).attr("src",c+$("img",b).attr("active"))},q=function(){$(this).siblings(".bouton").show("slow"),$(this).hide("slow"),b.emit("addBook",$(this).closest(".bookcell").data("book").id)},r=function(){$(this).siblings(".bouton").show("slow"),$("#collection").hasClass("active")?$(this).closest(".bookcell").hide("slow",function(){$(this).remove()}):$(this).hide("slow"),b.emit("removeBook",$(this).closest(".bookcell").data("book").id),_.remove(a.books,{id:$(this).closest(".bookcell").data("book").id})},s=function(a){a.preventDefault(),$("#dock").remove(),p("#recherche"),x(1,1);var c={};return _.forEach($(this).serializeArray(),function(a){c[a.name]=a.value}),b.emit("searchBooks",{q:c.searchby+c.searchinput,langRestrict:c.langage}),u(),!1},t=function(){x(1).then(function(){formSearch.reset(),$("#searchWindow").css("top",$(window).scrollTop()+10).show()})},u=function(){$(".window").slideUp(),x()},v=function(){var c=$(this).closest(".bookcell").data("book").id,d=_.find(a.books,{id:c});d?console.debug("book",d):b.emit("searchDetail",c)},w=function(){var a=this.value.toLowerCase(),b=$(".bookcell");return a.length<3?$(b).show():($(".bookcell").each(function(){var b=$(this).data("book"),c=b.title.toLowerCase(),d=b.authors?b.authors.join(", ").toLowerCase():"",e=b.description.toLowerCase();-1!==c.indexOf(a)||-1!==d.indexOf(a)||-1!==e.indexOf(a)?$(this).show():$(this).hide()}),void $(".torotate").each(function(){$(this).loadCover()}))},x=function(a,b){var c=$.Deferred();return $(".description").remove(),a?(b?$("img","#waiting").show():$("img","#waiting").hide(),$("body").addClass("overflown"),$("#waiting").slideDown("slow",function(){c.resolve()})):($("body").removeClass("overflown"),$("#waiting").slideUp("slow",function(){c.resolve()})),c.promise()};$.fn.loadCover=function(){var a=new $.Deferred,b=this,c=this.closest(".bookcell");return $(window).height()+$(window).scrollTop()<=c.offset().top?a.reject():(b.removeClass("torotate"),$(".ajouter",c).click(q),$(".supprimer",c).click(r),$("img, .title, .authors",c).not(".bouton").click(v),b.data("src")&&b.attr("src",b.data("src")).data("src",""),c.css("visibility","visible").show(),$({deg:-90}).animate({deg:0},{duration:250,step:function(a){c.css({transform:"rotateX("+a+"deg)"})},complete:function(){a.resolve()}})),a.promise()},b.on("user",function(b){a=new d(b),console.debug("user",new Date),g(),$("#navbar > div, #footer").not(".picture").hover(n,o),$("[blur]").closest("div").each(o),$("img").attr("draggable",!1),$("#waitingAnim").addClass("notdisplayed"),$("#navbar").removeClass("notdisplayed"),$("#collection").click(l),$("#profil").click(m),$("#recherche").click(t),$("#filtre").on("keyup search",w)}),b.on("collection",function(b){a.books=b.books,console.debug("collection",new Date),$("#collection").click()}),b.on("books",function(a){k(a)}),b.on("endRequest",function(a){console.debug("endRequest",new Date,a)}),b.on("returnAdd",function(b){a.books.push(b),a.books=_.sortBy(a.books,"title")}),b.on("returnDetail",function(a){console.debug("returnDetail",a)}),b.on("logout",f),b.on("error",function(a){console.debug(a)}),$(document).on("scroll",function(){$(".torotate").each(function(){$(this).loadCover()}),$(window).scrollTop()?$("#footer").show():$("#footer").hide()}),$("#logout").click(f),$("#formSearch").submit(s),$(".windowheader > img").click(u).hover(n,o),$("#footer").click(function(){$("body").animate({scrollTop:0})})});
