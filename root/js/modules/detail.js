!function(){var a=angular.module("detail",["search"]);a.directive("detail",function(){return{restrict:"A",templateUrl:"./html/directives/detail.html",controller:["$scope","$socket","$idb","$thief",function(a,b,c,d){var e=a.detail={},f=a.preview={},g=function(a){var b=d.getColor(a),c="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:c}};e.editToggle=function(a){this.edit[a]=this.edit.able?!this.edit[a]:!1},e.addBook=function(){return this.edit["new"]?(b.emit("newbook",this.book),void(this.edit["new"]=!1)):a.bookcells.addBook(this.book)},e.updateBook=function(){if(a.windows.close("detail"),angular.equals(new Date(this.book.publishedDate),this.XDate)||(this.book.publishedDate=this.XDate),!angular.equals(this.ref,this.book)){var c={},d=_.find(a.bookcells.cells,_.matchesProperty("id",this.ref.id));_.forEach(this.book,function(a,b){_.isEqual(a,e.ref[b])||(c[b]=a)}),_.assign(this.ref,this.book),d&&_.assign(d,this.book),c.userComment&&(this.book.userDate=c.userDate=new Date),b.emit("updateBook",_.merge(c,{id:this.book.id})),c.tags&&a.tags.init()}},e.searchBy=function(b){a.search.result={by:b.target.getAttribute("searchby"),search:b.target.html(),lang:"fr"},a.search.send()},e.uploadCover=function(){µ.one("[type=file]").trigger("click")},e.prepare=function(d){var f=a.bookcells.cells[d],g=_.find(a.bookcells.collection,_.matchesProperty("id",f.id));_.assign(a.waiting,{screen:!0,icon:!0}),g||f.updated?e.show(g||f):c.getDetail(f.id).then(function(c){c?(_.assign(f,c),e.show(c),a.$apply()):b.emit("searchDetail",f.id)})},e.setBack=function(){if(e.book.alternative||e.book.base64){var a=g(µ.one("#detailCover")).hex;µ.one("[detail]").css({background:"radial-gradient(circle at 50%, whitesmoke 0%, "+a+" 100%)"})}},e.show=function(b){e.reset(),b.alternative||b.base64||µ.one("[detail]").css({background:"radial-gradient(circle at 50%, whitesmoke 0%, #909090 100%)"}),a.windows.open("detail").then(function(){e.height=µ.one("[detail]").clientHeight-µ.one("[detail] header").clientHeight,µ.one(".detailBook").scrollTop=0}),a.waiting.icon=!1,e.ref=b,e.book=angular.copy(b),e.XDate=e.book.publishedDate?new Date(e.book.publishedDate):null,e.edit.able=_.isPlainObject(e.book.id)&&e.book.id.user===a.profile.user.id,_.isEmpty(e.book)&&_.assign(e.edit,{able:!0,"new":!0})},e.reset=function(){delete this.ref,delete this.book,this.edit={able:!1,"new":!1},this.tag=null,µ.alls(".new")&&µ.alls(".new").toggleClass("new",!1)},e.parseAuthors=function(){this.book.authors=_.uniq(this.book.authors.noSpace().split(","))},e.addTag=function(){this.book.tags||(this.book.tags=[]),-1===this.book.tags.indexOf(this.tag)&&(this.book.tags.push(this.tag),this.book.tags.sort()),this.tag=null},e.byTag=function(b){a.tags.search(e.book.tags[b]),a.waiting.screen=a.waiting.over=!1},e.removeTag=function(a){_.pullAt(this.book.tags,a)},e.recommand=function(){a.windows.close("recommand"),b.emit("sendNotif",{recommand:this.recommandTo,id:a.detail.book.id}),this.recommandTo=null},e.noSpace=function(a){this.book[a]=this.book[a].noSpace()},f.open=function(){µ.one("[target]").submit(),a.windows.open("preview")},b.on("returnDetail",function(b){var d=_.find(a.bookcells.cells,_.matchesProperty("id",b.id));d&&(d.updated=!0,_.assign(d,b)),c.setDetail(b),a.detail.show(b)}),b.on("returnNotif",function(b){var d=_.find(a.bookcells.cells,_.matchesProperty("id",b.id));d&&(d.updated=!0,_.assign(d,b)),a.detail.show(b),c.setDetail(b)}),b.on("newbook",function(b){_.assign(e.book,b),e.book["new"]=!0,a.bookcells.addBook(e.book)}),angular.element(µ.alls("#uploadHidden [type=file]")).on("change",function(){var b=this.files[0];if(b){if(!b.type.match(/image.*/)||b.size>1e5)return confirm("error",'Veuillez sélectionner un fichier de type "image" inférieure à 100KB.'),!1;var c=new FileReader;c.onload=function(b){e.book.alternative=b.target.result,a.$apply()},c.readAsDataURL(b)}}),angular.element(µ.one("#detailCover")).on("load",e.setBack),angular.element(µ.alls(".link")).on("click",e.searchBy),angular.element(µ.alls(".note")).on("click",function(b){"1"===e.book.userNote&&"1"===b.target.getAttribute("note")?e.book.userNote="0":e.book.userNote=b.target.getAttribute("note"),a.$apply()}).on("mousehover, mouseenter",function(a){for(var b=a.target.getAttribute("note"),c=µ.alls(".note"),d=Math.min(e.book.userNote,b);d<Math.max(e.book.userNote,b);d++)c[d].hasClass("select")?c[d].toggleClass("minus",!0):c[d].toggleClass("plus",!0)}).on("mouseleave",function(){µ.alls(".note").toggleClass("plus",!1).toggleClass("minus",!1)})}]}})}();
