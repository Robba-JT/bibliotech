!function(){var a=angular.module("navbar",[]);a.directive("navbar",function(){return{restrict:"A",templateUrl:"./html/directives/navbar.html",controller:["$socket","$scope","$window","$idb","$http",function(a,b,c,d,e){var f=b.navbar={},g=b.tags={cloud:!1},h=b.windows={opened:{},top:0},i=(b.modal={sort:!1,notifs:!1},b.notifs={}),j=function(){if(!this.hasClass("sortBy")){var a=this.getAttribute("by"),c=this.getAttribute("sort");b.bookcells.cells=_.sortByOrder(b.bookcells.cells,[a],"desc"!==c),b.$apply(),µ.one(".sortBy")&&µ.one(".sortBy").toggleClass("sortBy",!1),this.toggleClass("sortBy",!0)}};b.trads={},b.waiting={screen:!0,over:!1,icon:!0,anim:!0},b.onFocus=function(a){return!0},b.windows.close=function(a){"*"===a?this.opened={}:delete this.opened[a],_.assign(b.waiting,{screen:!_.isEmpty(this.opened),over:!1})},b.windows.open=function(a,c){return new Promise(function(d){c&&h.close("*"),h.top=h.xcroll().top+10,h.opened[a]=!0,"sort"!==a&&"notifs"!==a&&_.assign(b.waiting,{screen:!0,over:_.keys(h.opened).length>1}),d()})},b.windows.xcroll=function(){return{top:c.scrollY||µ.documentElement.scrollTop,left:c.scrollX||µ.documentElement.scrollLeft}},b.logout=function(){return b.waiting.screen=!0,d.indexedDB&&d.indexedDB.deleteDatabase(b.profile.user.session),b.profile.user={},location.assign("/logout"),a.close(),!1},e.get("/trad").then(function(a){b.trads=a.data}),f.visible=!0,f.height=µ.one("#navbar").clientHeight,f.newbook=function(){b.waiting.screen=!0,b.detail.show({})},f.openUrl=function(a){c.open(a)},f.mailTo=function(){µ.location.href="mailto:admin@biblio.tech?subject=Bibliotech"},f.collection=function(){_.assign(b.waiting,{screen:!0,icon:!0}),f.isCollect||(b.bookcells.reset(),b.bookcells.cells=b.bookcells.collection,f.isCollect=!0),f.saveorder=!1,f.filtre=f.last=b.search.last=b.tags.last=null,µ.one(".sortBy")&&!µ.one("#sort > div").hasClass("sortBy")&&µ.one(".sortBy").toggleClass("sortBy",!1),µ.one("#sort > div").toggleClass("sortBy",!0),b.bookcells.cells=_.sortByOrder(b.bookcells.cells,"title"),_.forEach(b.bookcells.cells,function(a){_.assign(a,{toHide:!1,toFilter:!1})}),c.scroll(0,0),_.assign(b.waiting,{screen:!1,icon:!1,anim:!1})},f.filter=function(){var a=this.filtre.toLowerCase().noAccent().noSpace().split(" ").sort(),c=a.length;_.isEqual(a,this.last)||(this.last=a,_.forEach(b.bookcells.cells,function(b){if(_.isEqual(a,[""]))return void(b.toFilter=!1);for(var d=(b.title+" "+(b.subtitle?b.subtitle:"")+" "+(b.authors?b.authors.join(", "):"")+" "+b.description).toLowerCase().noAccent().noSpace(),e=0;c>e;e++)if(-1===d.indexOf(a[e]))return void(b.toFilter=!0);b.toFilter=!1}))},f.toggleMenu=function(){this.visible=!this.visible,µ.one("[bookcells]").css({top:this.visible?this.height:0})},f.saveOrder=function(){var c={id:b.tags.last,order:_.pluck(_.filter(b.bookcells.cells,function(a){return a.toHide===!1}),"id")},d=_.findIndex(b.profile.user.orders,_.matchesProperty("id",c.id));-1!==d?_.assign(b.profile.user.orders[d],{order:c.order}):(c["new"]=!0,b.profile.user.orders.push({id:c.id,order:c.order})),a.emit("orders",c),f.saveorder=!1},g.generate=function(){for(var a=µ.one("#cloud"),c=~~(a.clientHeight/2),d=~~(a.clientWidth/2),e=d/c,f=3,g=[],h=function(a,b){for(var c=function(a,b){return Math.abs(2*a.offsetLeft+a.offsetWidth-2*b.offsetLeft-b.offsetWidth)<a.offsetWidth+b.offsetWidth&&Math.abs(2*a.offsetTop+a.offsetHeight-2*b.offsetTop-b.offsetHeight)<a.offsetHeight+b.offsetHeight},d=0,e=b.length;e>d;d++)if(c(a,b[d]))return!0;return!1},i=0,j=b.tags.tags.length;j>i;i++){var k=b.tags.tags[i],l=a.newElement("span",{title:k.weight,"class":"tag tag"+Math.min(~~(k.weight/5)+1,10)}).html(k.text),m=c-l.clientHeight/2,n=d-l.clientWidth/2,o=0,p=6.28*Math.random();for(l.css({top:m,left:n});h(l,g);)o+=f,p+=(i%2===0?1:-1)*f,m=c+o*Math.sin(p)-l.clientHeight/2,n=d-l.clientWidth/2+o*Math.cos(p)*e,l.css({top:m,left:n});g.push(l)}a.alls("span").setEvents("click",b.tags.click)},g.show=function(){new Promise(function(a){a(h.open("cloud",!0))}).then(function(){µ.alls("#cloud span").length||b.tags.generate()})},g.click=function(){h.close("*"),g.search(this.html()),b.$apply()},g.search=function(a){b.tags.last=a,h.close("*"),f.saveorder=!1,c.scroll(0,0),f.filtre=f.last="";for(var d=_.find(b.profile.user.orders,_.matchesProperty("id",a)),e=0,g=b.bookcells.cells.length;g>e;e++)_.assign(b.bookcells.cells[e],{toHide:!_.includes(b.bookcells.cells[e].tags,a),toFilter:!1});if(d&&d.order)for(d.order.reverse(),e=0,g=d.order.length;g>e;e++){var i=_.remove(b.bookcells.cells,_.matchesProperty("id",d.order[e]));i.length&&b.bookcells.cells.splice(0,0,i[0])}},g.init=function(){var a=_.countBy(_.flatten(_.compact(_.pluck(b.bookcells.collection,"tags")),!0).sort()),c=[];if(a){var d="";_.forEach(a,function(a,b){c.push({text:b,weight:a}),d+="<option>"+b+"</option>"}),µ.one("#tagsList").html(d),this.tags=_.sortBy(c,"weight").reverse()}µ.alls("#cloud span").removeAll()},g.reset=function(){µ.alls("#cloud span").removeAll()},µ.one("[bookcells]").css({top:µ.one("#navbar").clientHeight}),a.on("notifs",function(a){b.notifs.notifs=a}),i.show=function(b){a.emit("readNotif",_.pullAt(this.notifs,b)[0])},angular.element(c).on("resize",function(){b.bookcells.style={width:~~(µ.one("[bookcells]").clientWidth/~~(µ.one("[bookcells]").clientWidth/256))-10+"px"},h.close("*"),b.tags.reset(),b.$apply()}).on("scroll",function(){b.footer=!!b.windows.xcroll().top,b.$apply()}).on("click",function(a){b.modal.navBottom=µ.one("#navbar").clientHeight+5,b.modal.sortLeft=µ.one("#tris").offsetLeft,b.modal.notifsLeft=µ.one("#notifications").offsetLeft,"tris"!==a.target.id&&(b.modal.sort=!1),"notifications"!==a.target.id&&(b.modal.notifs=!1),b.$apply()}).on("keypress, keydown",function(a){a=a||c.event;var d;if(!a.altKey){if(a.ctrlKey)if(-1!==[77,76,82,80,66,69,73,72].indexOf(a.keyCode)&&b.waiting.anim)d=!0;else switch(a.keyCode){case 77:f.toggleMenu(),d=!0;break;case 76:b.logout(),d=!0;break;case 82:h.open("search",!0),d=!0;break;case 80:h.open("profile",!0),d=!0;break;case 66:f.collection(),d=!0;break;case 69:b.tags.show(),d=!0;break;case 73:h.open("contacts",!0),d=!0;break;case 72:h.open("help",!0),d=!0}else 27===a.keyCode&&(b.windows.close("*"),d=!0);if(d)return a.preventDefault(),b.$apply(),!1}}),angular.element(µ.one("#footer")).on("click",function(){var a=setInterval(function(){var d=(b.windows.xcroll().top/2-.1).toFixed(1);c.scroll(0,d),.1>=d&&(c.scroll(0,0),clearInterval(a))},100)}),angular.element(µ.alls("#sort > div")).on("click",j)}]}})}();
