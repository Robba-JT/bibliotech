!function(){var a=angular.module("bookcells",[]);a.directive("bookcells",function(){return{restrict:"A",templateUrl:"./html/directives/bookcells.html",controller:["$scope","$socket","$idb",function(a,b,c){var d=a.bookcells={},e=d.description={},f=function(a,b){d.cells||(d.cells=[]),d.collection||(d.collection=[]),_.forEach(a,function(a){var c=_.findIndex(d.collection,_.matchesProperty("id",a.id)),e=-1===_.findIndex(d.cells,_.matchesProperty("id",a.id));e&&d.cells.push(_.assign(d.collection[c]||a,{index:d.cells.length,inCollection:b||-1!==c})),b&&-1===c&&d.collection.push(a)})};d.style={width:~~(µ.one("[bookcells]").clientWidth/~~(µ.one("[bookcells]").clientWidth/256))-10+"px"},e.show=function(a,b){a!==this.index&&(this.titre=d.cells[a].title,this.description=d.cells[a].description.length>500?d.cells[a].description.substr(0,497)+"...":d.cells[a].description,this.style={width:b.target.clientWidth+"px",top:b.target.clientHeight/3+"px",left:Math.min(b.target.xposition()+b.target.clientWidth/3,window.innerWidth-1.333*b.target.clientWidth).toFixed(0)+"px"},this.index=a,this.visible=!0)},e.hide=function(a,b){("click"===b.type||a!==this.index)&&(this.visible=!1)},d.addBook=function(c){-1===_.findIndex(d.collection,_.matchesProperty("id",c.id))&&(_.assign(c,{inCollection:!0}),this.cell||_.assign(_.find(d.cells,_.matchesProperty("id",c.id)),{inCollection:!0}),d.collection.push(c),d.collection=_.sortByOrder(d.collection,"title"),c["new"]?a.navbar.isCollect&&(d.cells.push(c),µ.one("#sort > div").hasClass("sortBy")||(µ.one(".sortBy").toggleClass("sortBy",!1),µ.one("#sort > div").toggleClass("sortBy",!0),d.cells=_.sortByOrder(d.cells,"title"))):b.emit("addBook",c.id))},d.removeBook=function(c){_.remove(this.collection,_.matchesProperty("id",c.id)),b.emit("removeBook",c.id),a.navbar.isCollect?_.pull(this.cells,c):_.assign(c,{inCollection:!1})},d.reset=function(){_.assign(a.waiting,{screen:!0,icon:!0,anim:!0}),this.cells=[],this.filtre=this.last=this.tag=null,µ.one("[bookcells]").css({top:µ.one("#navbar").clientHeight})},b.on("initCollect",function(b){_.assign(a.waiting,{screen:!1,icon:!1,anim:!0}),f(b,!0)}),b.on("endCollect",function(b){a.navbar.isCollect=!0,a.tags.init(),f(b,!0),_.assign(a.waiting,{screen:!1,icon:!1,anim:!1})}),b.on("covers",function(b){return new Promise(function(c){for(var e=0,f=b.length;f>e;e++){var g=_.find(d.cells,_.matchesProperty("id",b[e].id))||{},h=_.find(d.collection,_.matchesProperty("id",b[e].id))||{};g.base64=h.base64=b[e].base64,g.alternative=h.alternative=b[e].alternative,a.detail.book&&a.detail.book.id===b[e].id&&(a.detail.book.base64=b[e].base64,a.detail.book.alternative=b[e].alternative)}c()})}),b.on("books",function(b){f(b),_.assign(a.waiting,{screen:!1,icon:!1,anim:!0})}),b.on("returnAdd",function(a){var b=_.findIndex(d.cells,_.matchesProperty("id",a.id));-1!==b?_.assign(d[b],a):d.cells.push(a)}),b.on("endRequest",function(b){!a.navbar.isCollect&&d.lastSearch&&c.setQuery(d.lastSearch,d.cells),_.assign(a.waiting,{screen:!1,icon:!1,anim:!1})}),a.$on("dropEvent",function(b,c,e){if(_.isEqual(c,e))return!1;var f=_.findIndex(d.cells,_.matchesProperty("id",c.id)),g=_.remove(d.cells,c)[0],h=_.findIndex(d.cells,_.matchesProperty("id",e.id));a.navbar.saveorder=!0,h>=f&&h++,d.cells.splice(h,0,g),a.$apply()})}],controllerAs:"bookcells"}})}();
