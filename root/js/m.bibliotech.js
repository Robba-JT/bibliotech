if(Array.prototype.assign=function(a){return this.push.apply(this,Array.isArray(a)?a:[a]),this},Array.prototype.noSpace=function(){for(var a=0,b=this.length;b>a;a++)"string"==typeof this[a]&&(this[a]=this[a].noSpace());return this},HTMLElement.prototype.closest=function(a){for(var b=this;b&&b.tagName&&"body"!==b.tagName.toLowerCase();){if(b.hasClass(a))return b;b=b.parentNode}return null},HTMLElement.prototype.css=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){_.includes(["width","max-width","height","max-height","top","left","bottom","padding-top"],c)&&-1===a.toString().indexOf("%")&&(a+="px"),b.style[c]=a}),this},HTMLElement.prototype.fade=function(a){var b=this,c="undefined"==typeof a?!b.isVisible():a,d=b.style.opacity;return new Promise(function(a){c&&(b.toggle(!0),d=0);var e=setInterval(function(){c?d>=(c||1)?(clearInterval(e),a(b)):b.style.opacity=(d+=.05).toFixed(2):0>=d?(clearInterval(e),b.toggle(!1),a(b)):b.style.opacity=(d-=.05).toFixed(2)},5)})},HTMLElement.prototype.formToJson=function(){var a={};return this.querySelectorAll("input, textarea").forEach(function(){(_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.checked||!_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.name)&&(a[this.name]=this.value)}),a},HTMLElement.prototype.hasClass=function(a){return this.classList.contains(a)},HTMLElement.prototype.html=function(a){return"undefined"==typeof a?this.innerHTML:(this.innerHTML=a,this)},HTMLElement.prototype.index=function(){for(var a=this.parentNode.childNodes,b=0,c=a.length;c>b;b++)if(a[b]===this)return b;return-1},HTMLElement.prototype.isVisible=function(){return this.offsetWidth>0&&this.offsetHeight>0},HTMLElement.prototype.newElement=function(a,b){var c=document.createElement(a);return _.isPlainObject(b)&&c.setAttributes(b),this.appendChild(c),c},StyleSheetList.prototype.removeAll=HTMLElement.prototype.removeAll=function(){return this.remove?this.remove():this.parentNode.removeChild(this),this},HTMLElement.prototype.removeAttributes=function(a){var b=this;return"string"==typeof a&&(a=[a]),_.isArray(a)&&a.forEach(function(a){b.removeAttribute(a)}),this},HTMLElement.prototype.setAttributes=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){b.setAttribute(c,a)}),this},Window.prototype.setEvents=HTMLDocument.prototype.setEvents=HTMLElement.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(d.addEventListener(a,b,c),d)},HTMLElement.prototype.setValue=function(a){return this.value=a,this},HTMLElement.prototype.siblings=function(a){return this.parentNode.alls(a)},HTMLElement.prototype.text=function(a){return"undefined"==typeof a?this.textContent:(this.textContent=a,this)},HTMLElement.prototype.toLeft=function(a){var b=this,c="undefined"==typeof a?b.offsetLeft<0:a,d=b.clientWidth,e=~~(d/20);return b.scrollTop=0,new Promise(function(a){var f=setInterval(function(){c?b.offsetLeft>=0?(clearInterval(f),a(b)):b.css({left:b.offsetLeft+e}):b.offsetLeft<=-d?(clearInterval(f),a(b)):b.css({left:b.offsetLeft-e})},5)})},HTMLElement.prototype.toggle=function(a){return("undefined"==typeof a||null===a)&&(a=!this.isVisible()),this.toggleClass("notdisplayed",!a),this},HTMLElement.prototype.toggleClass=function(a,b){var c=this;a=a.split(" ");var d="toggle";return"undefined"!=typeof b&&(d=b?"add":"remove"),a.forEach(function(a){c.classList[d](a)}),this},HTMLElement.prototype.trigger=function(a){var b;try{b=new Event(a)}catch(c){b=document.createEvent(_.includes(["click","mouseenter","mouseleave","mouseup","mousedown"],a)?"MouseEvents":"HTMLEvents"),b.initEvent(a,!0,!0)}return this.dispatchEvent(b),this},HTMLElement.prototype.xposition=function(){return this.parentNode&&this.parentNode.tagName?this.parentNode.offsetLeft:this.offsetLeft},HTMLDocument.prototype.alls=HTMLCollection.prototype.alls=HTMLElement.prototype.alls=NodeList.prototype.alls=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return[];if(d.multiSelect())a=this.querySelectorAll(b);else switch(c){case"#":a=[document.getElementById(d)];break;case"@":a=document.getElementsByName(d);break;case".":a=this.getElementsByClassName(d);break;default:a=this.getElementsByTagName(b)}return a},HTMLCollection.prototype.css=NodeList.prototype.css=function(a){return this.forEach(function(){this.css(this)}),this},HTMLCollection.prototype.fade=NodeList.prototype.fade=function(a){var b=[];return this.forEach(function(){b.push(this.fade(a))}),Promise.all(b)},HTMLCollection.prototype.forEach=NodeList.prototype.forEach=function(a){return[].forEach.call(this,function(b){a.call(b)}),this},HTMLCollection.prototype.html=NodeList.prototype.html=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.html(a)}),this)},HTMLDocument.prototype.one=HTMLCollection.prototype.one=HTMLElement.prototype.one=NodeList.prototype.one=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return null;if(d.multiSelect())a=this.querySelector(b);else switch(c){case"#":a=document.getElementById(d);break;case"@":a=document.getElementsByName(d)[0];break;case".":a=this.getElementsByClassName(d)[0];break;default:a=this.getElementsByTagName(b)[0]}return a},HTMLCollection.prototype.removeAll=NodeList.prototype.removeAll=function(){return this.forEach(function(){this.removeAll()}),this},HTMLCollection.prototype.removeAttributes=NodeList.prototype.removeAttributes=function(a){return"string"==typeof attrs&&(a=[a]),this.forEach(function(){this.removeAttributes(a)}),this},HTMLCollection.prototype.setAttributes=NodeList.prototype.setAttributes=function(a){return this.forEach(function(){this.setAttributes(a)}),this},HTMLCollection.prototype.setEvents=NodeList.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(a=a.split(" "),d.forEach(function(){var d=this;a.forEach(function(a){d.addEventListener(a,b,c)})}),d)},HTMLCollection.prototype.setValue=NodeList.prototype.setValue=function(a){return this.forEach(function(){this.setValue(a)}),this},HTMLCollection.prototype.text=NodeList.prototype.text=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.text(a)}),this)},HTMLCollection.prototype.toArray=NodeList.prototype.toArray=function(){return[].slice.call(this)},HTMLCollection.prototype.toggle=NodeList.prototype.toggle=function(a,b){return this.forEach(function(){this.toggle(a,b)}),this},HTMLCollection.prototype.toggleClass=NodeList.prototype.toggleClass=function(a,b){return this.forEach(function(){this.toggleClass(a,b)}),this},HTMLCollection.prototype.trigger=NodeList.prototype.trigger=function(a){return this.forEach(function(){this.trigger(a)}),this},String.prototype.fd=function(){var a=this.substr(0,10).split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),a},String.prototype.multiSelect=function(){return-1!==this.indexOf(" ")||-1!==this.indexOf(",")||-1!==this.indexOf(".")||-1!==this.indexOf("#")||-1!==this.indexOf(":")||-1!==this.indexOf("]")},String.prototype.noSpace=function(){return this.replace(/^\s+/g,"").replace(/\s+$/g,"").replace(/\s{2,}/g," ")},window.FileReader&&window.Promise&&"formNoValidate"in document.createElement("input")){var µ=document,current;µ.setEvents("DOMContentLoaded",function(){"use strict";var a=(new Date,function(a,c){var d=b.cells.length+("undefined"==typeof c?1:c),e=µ.one("#collection").hasClass("active")||-1!==o.get().bookindex(a.id);return this.id=a.id,this.book=a,this.cell=µ.one("#tempCell").cloneNode(!0).removeAttributes("id").toggleClass("bookcell",!0),this.cell.one("header").text(a.title),this.cell.one("figcaption").text(a.authors?a.authors.join(", "):""),this.cell.one(".previewable").toggle(!!a.access&&"NONE"!==a.access),this.cell.one(".recommanded").toggle(!!a.from),this.cell.one(".personnal").toggle(_.isEqual(a.id.user,o.get().id)),this.cell.one(".add").toggle(!e),this.cell.one(".remove").toggle(!!e),this.cell.col=d%f.nbcols,this.cell.row=Math.floor(d/f.nbcols),(a.alternative||a.base64)&&(this.cell.one(".cover").src=a.alternative||a.base64),this.active(),this}),b={books:[],bytags:function(a){if(µ.one("#collection").hasClass("active")){window.scroll(0,0),µ.one("#formFilter").reset(),µ.alls(".bookcell").toggleClass("tofilter",!1);for(var c=0,d=b.cells.length;d>c;c++){var e=b.cells[c];e.cell.toggleClass("tohide",!_.includes(e.book.tags,a))}b.display()}},cells:[],destroy:function(){f.remove(),b.books=[],b.cells=[]},display:function(a,c,d){var e=[c,d];return new Promise(function(g){if(!a&&µ.one(".sortBy"))g(b.sort.call(µ.one(".sortBy"),e));else{a=a||_.sortBy(b.cells,function(a){return[a.row,a.col]});for(var h=0,i=f.get(),j=0,k=a.length;k>j;j++){var l=(a[j],a[j].cell);d&&l.toggleClass("tohide tofilter",!1),l.hasClass("tohide")||l.hasClass("tofilter")?f.get().one("section.notdisplayed").appendChild(l):(l.toggleClass("toshow",!0),i.one('[colid="'+(c?l.col:h%f.nbcols)+'"]').appendChild(l),h++)}q.toggle(!1),b.loadcovers(),g(b.cells.length)}})},filter:function(){var a=this.value.toLowerCase(),c=µ.one("@last");if(µ.one(".tnv").trigger("click"),this.checkValidity()&&a!==c.value){c.value=a;for(var d=0,e=b.cells.length;e>d;d++){var f=b.cells[d],g=f.book.title.toLowerCase(),h=f.book.subtitle?f.book.subtitle.toLowerCase():"",i=f.book.authors?f.book.authors.join(", ").toLowerCase():"",j=f.book.description.toLowerCase();f.cell.toggleClass("tofilter",-1===g.indexOf(a)&&-1===h.indexOf(a)&&-1===i.indexOf(a)&&-1===j.indexOf(a))}b.display()}},generate:function(c){return new Promise(function(d){for(var e=[],f=0,g=c.length;g>f;f++)b.one(c[f].id)||-1!==_.findIndex(e,_.matchesProperty("id",c[f].id))||e.push(new a(o.get().book(c[f].id)||c[f],f));b.cells.assign(e),!µ.one("#collection").hasClass("active")&&l.last&&(b.books.push(c),b.books=_.flatten(b.books)),d(e)})},loadcovers:function(){for(var a=0,c=b.cells.length;c>a;a++)b.cells[a].loadcover();j.toggleFooter()},one:function(a){return _.find(b.cells,_.matchesProperty("id",a))},returned:function(a){b.one(a.id).returned(a)},show:function(a){for(var c,d=_.chunk(a,40),e=function(a){return new Promise(function(c){b.generate(a).then(function(a){b.display(a,!0)}).then(c)})},f=0,g=d.length;g>f;f++)c=c?c.then(e(d[f])):c=e(d[f]);return c},sort:function(){var a=arguments[0]||[];if(window.scroll(0,0),!this.hasClass("active")){var c=this;µ.one(".sortBy")&&h.blur.call(µ.one(".sortBy").toggleClass("sortBy",!1)),h.hover.call(this).toggleClass("sortBy",!0),b.display(_.sortByOrder(b.cells,["book."+[c.getAttribute("by")]],"desc"!==c.getAttribute("sort")),a[0]||!1,a[1]||!1)}}},c=function(){var a;switch(this.setCustomValidity(""),this.name){case"confirmPwd":a=this.value!==µ.one("@newPwd").value;break;case"filtre":a=!!this.value.length&&this.value.length<3;break;case"name":a=this.value.length<4;break;case"newPwd":a=this.value.length<4||this.value.length>12;break;case"pwd":a=this.value.length<4||this.value.length>12;break;case"recommand":a=this.value.toLowerCase()===o.get().id;break;case"searchinput":a=this.value.length<3;break;case"title":a=this.value.length<6}a&&this.setCustomValidity(this.getAttribute("error"))},d=new ColorThief,e={action:function(){var a=e.data.book.id,b=o.get().book(a),c=this.getAttribute("actclick");this.add=function(){if(a)m.emit("addDetail"),µ.alls('[actclick="upload"]').toggle(!e.data.book.cover),e.newCell();else{for(var b,c=µ.one("#formNew").formToJson(),d=µ.alls("#formNew input, #formNew textarea"),f=0,g=d.length;g>f;f++)if(!d[f].reportValidity()){b=!0;break}if(c.authors=c.authors?c.authors.split(","):[],c.authors.noSpace(),b)return!1;q.over(),m.emit("newbook",c)}},this.associated=function(){l.associated(a)},this.update=function(){var c=!1,d={id:a},e=_.map(µ.alls("#userTags > div").toArray(),function(a){return a.one(".libelle").text()}),f=µ.one("#userNote").value,g=µ.one("#userComment").value;if(_.isObject(a)&&a.user===o.get().id){var h=µ.one("#formNew").formToJson();h.authors=h.authors.split(",")||[],_.forEach(h,function(a,e){a=a.noSpace(),_.isEqual(b[e],a)||(c=!0,d.update||(d.update={}),d.update[e]=a)})}(f||b.userNote)&&f!==b.userNote&&(c=!0,d.userNote=f),(g||b.userComment)&&g!==b.userComment&&(c=!0,d.userComment=g),(e.length||b.tags&&b.tags.length)&&!_.isEqual(e,b.tags)&&(c="tags",d.tags=e),c&&(d.userDate=(new Date).toJSON(),m.emit("updateBook",d),o.get().updatebook(d),n.init(),µ.one("#tags").toggle(!!n.cloud.length&&µ.one("#collection").hasClass("active"))),r.close()},this.upload=function(){µ.one("#uploadHidden [type=file]").trigger("click")},this.preview=function(){µ.one("@previewid").value=a,q.over(),r.open.call("previewWindow").then(function(a){µ.one("#preview").submit()})},this.google=function(){window.open(this.getAttribute("link"))},this.recommand=function(){q.over(),r.open.call("recommandWindow")},this.close=function(){this.closest("window").fade(!1).then(function(){delete r.on,q.over(!1)})},this[c].call(this)},clickNote:function(){var a=µ.one("#userNote"),b=this.getAttribute("note");a.value===b&&"1"===a.value?a.value=0:a.value=b,e.userNote()},data:{},links:function(){var a=this.getAttribute("searchby"),b=this.text();a&&b&&(µ.one("#formSearch [type=search]","").value=b,µ.alls("#formSearch [name=searchby]")[a].checked=!0,µ.one("#formSearch").trigger("submit"))},mainColor:function(a){var b=d.getColor(a),c="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:c}},modify:function(){if(this.hasClass("modify")){if(this.hasClass("hide"))for(var a=this.siblings("[name]"),b=0,c=a.length;c>b;b++)a[b].value=a[b].getAttribute("oldvalue");this.toggleClass("hide"),this.siblings("[field]:not(.noValue), [name]").toggle(null);var d=this.siblings("[name]")[0];d.focus(),"textarea"===d.tagName.toLowerCase()&&(d.scrollTop=0)}},mouseNote:function(){var a=µ.one("#userNote").value||0,b=this.getAttribute("note"),c=µ.alls("[note]").toArray();if(a!==b)for(var d=0;d<Math.max(a,b);d++)d<Math.min(a,b)?c[d].src=images[c[d].getAttribute("select")].black:a>b?c[d].src=images[c[d].getAttribute("hoverminus")].black:c[d].src=images[c[d].getAttribute("hoverplus")].black},"new":function(){e.data.book={},e.show(!1),µ.one("#formNew").reset(),µ.alls("#formNew input, #formNew textarea, .volumeInfo:not(.nonEditable), .volumeInfo:not(.nonEditable) button").toggle(!0),µ.alls("#formNew [field]").toggle(!1)},newCell:function(){µ.alls("[actclick=add], [actclick=update], #upload, .inCollection").toggle();var a=b.one(e.data.book.id),c=o.get().addbook(e.data.book);µ.one("#collection").hasClass("active")&&!a&&(b.cells.push(c),b.display()),a&&a.cell&&a.cell.alls("button").fade()},sendNotif:function(){var a=this.formToJson();return a.book=e.data.book.id,a.title=e.data.book.title,e.data.book.alt&&(a.alt=e.data.book.alt),m.emit("sendNotif",a),µ.one("#recommandWindow .closeWindow").trigger("click"),!1},show:function(a){var b=e.data.book,c=µ.one("#detailWindow");µ.one("#formNew").reset(),µ.one("#formRecommand").reset(),c.alls("#formNew input, #formNew textarea").toggle(!1),c.alls("#formNew button:not(.categories)").toggleClass("hide",!1).toggleClass("modify",!!b.id&&_.isEqual(b.id.user,o.get().id)),µ.alls("#comments *").removeAll(),µ.one("#userComment").value="";for(var d=0,f=µ.alls("[note]").length;f>d;d++)h.blur.call(µ.alls("[note]")[d]);µ.one("#userNote").value=b.note,c.alls(".inCollection").toggle(!!a).css({background:"whitesmoke"}),n.list(),µ.one("#background").toggle(!!b.alternative||!!b.base64),(b.alternative||b.base64)&&µ.one("#background").css({"background-image":"url("+(b.alternative||b.base64).toString()+")"}),c.alls(".direct").text(""),c.alls("#userTags > div").removeAll(),µ.alls("[actclick=add]").toggle(!a),µ.alls("[actclick=update], [actclick=recommand]").toggle(!!a),µ.alls("[actclick=associated]").toggle(!!b.id&&!_.isObject(b.id)),µ.alls("[actclick=preview]").toggle(!!b.access&&"NONE"!==b.access),µ.alls("[actclick=google]").setAttributes({link:b.link}).toggle(!!b.link),µ.alls("[actclick=upload]").toggle(!b.base64&&!b.cover&&!!a),c.alls(".comments").toggle(!!b.comments&&!!b.comments.length),c.alls("#detailWindow [field]").toggleClass("noValue",!1),c.alls("[field=authors] span").removeAll(),c.alls(".volumeInfo.nonEditable").toggle(!1),c.alls(".volumeInfo:not(.nonEditable)").toggle(!!b.id&&_.isEqual(b.id.user,o.get().id)),e.userNote(),c.hasClass("notdisplayed")&&r.open.call("detailWindow").then(function(){µ.one("#detailContent").css({height:c.clientHeight-c.one("header").clientHeight}),µ.one(".detailBook").scrollTop=0,µ.alls(".new").toggleClass("new",!1)}),_.forEach(b,function(a,d){var f=c.one("[field="+d+"]"),g=c.one("input[name="+d+"], textarea[name="+d+"]");switch(f&&"subtitle"!==d&&(f.closest("volumeInfo").toggle(!!a||_.isEqual(b.id.user,o.get().id)),f.toggle(!!a).toggleClass("noValue",!a)),d){case"authors":for(var h=0,i=a.length;i>h;h++)f.newElement("span",{"class":"link",searchby:3}).text(a[h]);g.value=a.join(", "),g.setAttribute("oldvalue",a.join(", ")),f.parentNode.alls("button").toggle(!!a.length);break;case"tags":for(var j=µ.one("#userTags"),k=0,l=a.length;l>k;k++)j.appendChild(n["new"](a[k]));break;case"userNote":a&&e.clickNote.call(µ.one('[note="'+a+'"]'));break;case"userComment":µ.one("#userComment").value=a;break;case"comments":var m,p=0;a.length||c.one(".comments").toggle(!1);for(var q=0,r=a.length;r>q;q++){if(a[q].comment){var s=µ.one("#tempComment").cloneNode(!0);s.removeAttribute("id"),s.one(".commentAuthor").text(a[q].name),s.one(".commentDate").text(a[q].date.fd()),s.one(".commentNote").text(a[q].note),s.one(".commentComment").html(a[q].comment),µ.one("#comments").appendChild(s)}a[q].note&&(m=(m||0)+parseInt(a[q].note,10),p++)}"undefined"!=typeof m&&p&&(m=(m/p).toFixed(2),µ.one(".subtitle").toggle(!0),µ.one("#mNote").text(m));break;default:if(!f)break;_.isArray(a)&&(a=a.join(", ")),g&&(g.setAttribute("oldvalue",a),g.value=a,g.scrollTop=0),"time"===f.tagName.toLowerCase()&&(f.setAttribute("datetime",new Date(a)),a=a.fd()),"description"===d?f.html(a):f.text(a)}}),µ.alls(".link").setEvents("click",e.links,!1)},uploadCover:function(){var a=this.files;if(a[0]){if(!a[0].type.match(/image.*/)||a[0].size>5e5)return r.confirm("error",'Veuillez sélectionner un fichier de type "image" inférieure à 500KB.'),!1;var b=new FileReader;b.onload=function(a){return function(b){a.onload=function(){var a=e.mainColor(this);this.toggleClass("new",!0).setAttribute("mainColor",a.hex),µ.one("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+a.hex+")")},a.src=b.target.result}}(µ.one("#detailCover")),b.readAsDataURL(this.files[0])}},userNote:function(){for(var a=µ.alls("[note]").toArray(),b=µ.one("#userNote").value,c=0;c<a.length;c++)b>c?a[c].src=images[a[c].getAttribute("select")].black:a[c].src=images[a[c].getAttribute("source")].black}},f={get:function(){var a,c=µ.one("#d");if(c||(c=µ.body.newElement("section",{id:"d",role:"main"}),c.newElement("section",{"class":"notdisplayed"})),a=(c.clientWidth/f.nbcols).toFixed(0),c.alls(".col").length!==f.nbcols){c.alls(".col").removeAll();for(var d=0;d<f.nbcols;d++)c.newElement("div",{"class":"col",colid:d}).css({width:a,"max-width":a});µ.alls(".col").setEvents({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(a){a.preventDefault();var c=b.one(JSON.parse(a.dataTransfer.getData("text"))).cell,d=a.target.closest("bookcell");return d?c!==d&&(d.closest("col").insertBefore(c,d),b.loadcovers(),µ.one(".sortBy")&&h.blur.call(µ.one(".sortBy").toggleClass("sortBy",!1))):(this.appendChild(c),µ.one(".sortBy")&&h.blur.call(µ.one(".sortBy").toggleClass("sortBy",!1))),!1}})}return c},nbcols:~~(window.innerWidth/192),remove:function(){µ.one("#d")&&(µ.one("#d").removeAll(),window.scroll(0,0))},resize:function(){f.nbcols!==~~(window.innerWidth/192)?(n.close().then(n.destroy),µ.alls(".deroulant").fade(!1),f.nbcols=~~(window.innerWidth/192),f.remove(),b.display()):µ.alls(".col").css({width:~~(window.innerWidth/f.nbcols),"max-width":~~(window.innerWidth/f.nbcols)}),µ.one("#detailWindow").isVisible()&&(µ.one("#detailWindow").css({height:window.innerHeight,top:0}),µ.one("#detailContent").css({height:window.innerHeight-µ.one("#detailWindow header").clientHeight}))}},g={deleteDetail:function(a){g.db&&g.db.transaction(["details"],"readwrite").objectStore("details")["delete"](a)},deleteQuery:function(a){g.db&&g.db.transaction(["queries"],"readwrite").objectStore("queries")["delete"](a)},getDetail:function(a){return new Promise(function(b){g.db||b();var c=g.db.transaction(["details"],"readwrite").objectStore("details").index("by_id").get(a);c.onsuccess=function(){this.result?b(this.result):b()},c.onerror=function(){b()}})},getQuery:function(a){return new Promise(function(b,c){g.db||c();var d=g.db.transaction(["queries"],"readwrite").objectStore("queries").index("by_query").get(JSON.stringify(a));d.onsuccess=function(){this.result&&this.result.books&&this.result.books.length?b(this.result.books):c()},d.onerror=c})},init:function(){return g.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,new Promise(function(a,b){if(g.indexedDB){var c=indexedDB.open(o.get().session,1);c.onerror=function(){b()},c.onsuccess=function(){g.db=this.result,a()},c.onupgradeneeded=function(){var a=this.result;a.createObjectStore("queries",{keyPath:"query"}).createIndex("by_query","query",{unique:!0}),a.createObjectStore("details",{keyPath:"id"}).createIndex("by_id","id",{unique:!0})}}})},setDetail:function(a){if(g.db){g.db.transaction(["details"],"readwrite").objectStore("details").put(a)}},setQuery:function(a,b){if(g.db){g.db.transaction(["queries"],"readwrite").objectStore("queries").put({query:JSON.stringify(a),books:b})}}},h={active:function(){var a=µ.one(".active"),b=this.one("img");return a&&(a.toggleClass("active",!1),h.blur.call(a)),this.toggleClass("active",!0),µ.one("#tags").toggle("collection"===this.id&&!!n.cloud&&!!n.cloud.length),b&&(b.src=images[b.getAttribute("source")][b.getAttribute("active")]),this},blur:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("blur")],a.isVisible()||a.hasClass("nsv")||a.css({visibility:"visible"})),this)},hover:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("hover")]),this)}},i=function(){return q.toggle(!0),o.destroy(),g.indexedDB&&g.indexedDB.deleteDatabase(o.get().session),m.destroy(),location.assign("/logout"),!1},j={close:function(a){var b=a.target.closest("action");(b||a.target&&a.target.getAttribute("by"))&&(!b||_.includes(["notifications","tris"],b.getAttribute("id")))||µ.alls(".deroulant").fade(!1)},link:function(){window.open(this.getAttribute("url"))},mail:function(){µ.location.href="mailto:"+this.getAttribute("mail")},notif:function(a){var b=µ.one("#notifs");b.isVisible()?b.fade(!1):b.fade(.95)},selectstart:function(a){return a.preventDefault(),a.target.tagName&&!_.includes(["input","textarea"],a.target.tagName.toLowerCase())?!1:void 0},show:function(){h.hover.call(µ.one("#sort img")),µ.alls("#tags, #notifications").toggle(!1)},sort:function(a){var b=µ.one("#sort");b.isVisible()?b.fade(!1):b.fade(.95)},toggle:function(){µ.one("#nvb").toLeft(µ.one(".nvb:not(#nvb)").isVisible()),µ.one(".nvb:not(#nvb)").fade()},toggleFooter:function(){µ.one("#footer").toggle(!!s().top)},top:function(){var a=setInterval(function(){var b=(s().top/2-.1).toFixed(1);window.scroll(0,b),.1>=b&&(window.scroll(0,0),clearInterval(a))},100)}},k={click:function(){var a=JSON.parse(this.getAttribute("notif"));a._id.book;_.remove(k.list,a),k.last=a,µ.one("#notifs").toggle(),this.removeAll(),µ.alls("#notifications, #notifNumber").toggle(!!k.list.length),µ.one("#notifNumber").text(k.list.length),q.toggle(!0,!0),m.emit("readNotif",a)},show:function(a){a&&(k.list=a),µ.alls("#notifications, #notifNumber").toggle(!!k.list.length),µ.one("#notifNumber").text(k.list.length);for(var b=0,c=k.list.length;c>b;b++){var d=k.list[b],e=µ.one("#tempNotif").cloneNode(!0);e.setAttributes({notif:JSON.stringify(d)}).removeAttribute("id"),e.one(".notifName").html(d.from),e.one(".notifTitle").text(d.title),e.setEvents("click",k.click),µ.one("#notifs").appendChild(e)}}},l={associated:function(a){l.clear(),l.last={associated:a},r.close(!0).then(function(){q.toggle(!0,!0).then(function(){g.getQuery(l.last).then(b.show,function(){µ.one("#nvb").toggleClass("inactive",!0),q.anim(!0),m.emit("associated",a)})["catch"](function(a){})})})},books:function(){var a=this.formToJson();return l.last={q:a.searchby+a.searchinput,langRestrict:a.langage},µ.one("@filtre").value=µ.one("@last").value="",l.clear(),r.close(!0).then(function(){q.toggle(!0,!0).then(function(){g.getQuery(l.last).then(b.show)["catch"](function(){µ.one("#nvb").toggleClass("inactive",!0),q.anim(!0),m.emit("searchBooks",l.last)})})}),!1},clear:function(){b.destroy(),f.remove(),h.active.call(µ.one("#recherche")),µ.one("#formFilter").reset(),µ.one(".sortBy")&&h.blur.call(µ.one(".sortBy").toggleClass("sortBy",!1))},endRequest:function(a){µ.one("#nvb").toggleClass("inactive",!1),q.anim(!1),a||q.toggle(!1),!µ.one("#collection").hasClass("active")&&l.last&&g.setQuery(l.last,b.books)},gtrans:function(){var a=this.id;r.confirm("warning","Cette opération va importer/exporter vos EBooks depuis/vers votre bibliothèque Google.<BR>Etes vous sur de vouloir continuer?").then(function(){return"exportNow"===a?m.emit("exportNow"):(b.destroy(),h.active.call(µ.one("#collection")),µ.one("#nvb").toggleClass("inactive",!0),q.anim(!0),void r.close(!0).then(function(){q.toggle(!0,!0),m.emit("importNow")}))})},recommand:function(){l.clear(),l.last={recommand:o.get().id},r.close(!0).then(function(){q.toggle(!0,!0).then(function(){g.getQuery(l.last).then(b.show)["catch"](function(){µ.one("#nvb").toggleClass("inactive",!0),q.anim(!0),m.emit("recommanded")})})})}},m=function(a){var c=function(){var c=a.connect("https://192.168.9.27",{secure:!0,multiplex:!1});return c.once("connect",function(){this.once("disconnect",function(a){d(this),o.destroy(),r.close().then(function(){q.toggle(!0,!0),q.connection(!0),µ.alls(".deroulant").toggle(!1),µ.one("#picture *")&&µ.alls("#picture *").removeAll(),µ.alls("#notifications, #tags").toggle(!1),h.blur.call(µ.one(".active").toggleClass("active",!1));for(var a=µ.alls("form"),c=0,d=a.length;d>c;c++)a[c].reset();b.destroy()})}).on("books",b.show).on("collection",function(a){p.collection(a.books).then(n.init),k.show(a.notifs)}).on("covers",function(a){for(var b=0,c=a.length;c>b;b++)if(a[b]&&a[b].id&&a[b].base64){var d=a[b],f=o.get().bookcell(d.id),g=f.book;if(g.base64=d.base64,f&&f.cell){var h=f.cell;h.hasClass("toshow")||(h.one(".cover").src=d.base64),e.data.book&&e.data.book.id===g.id&&(µ.one("#detailCover").src=d.base64)}}}).on("endRequest",l.endRequest).on("error",function(a){}).on("logout",i).on("newbook",function(a){e.bookid=a.id,e.data={book:a},e.newCell(),e.show(!0),q.over(!1)}).on("returnAdd",p.addbook).on("returnDetail",b.returned).on("returnNotif",function(a){e.bookid=a.id,e.data={book:a},e.show(-1!==o.get().bookindex(a.id))}).on("updateNok",p.nokdated).on("updateOk",p.updated).on("user",function(a){j.show(),current=o.get().init(a),g.db||g.init()}).emit("isConnected")}),c},d=function(a){a.destroy();var b=setInterval(function(){a&&a.connected&&"open"===a.io.readyState&&(clearInterval(b),m=c());try{a.connect()}catch(d){}},3e3)};return c()}(io),n={add:function(){var a=this.formToJson().tag.toLowerCase(),b=µ.alls("#userTags > div").toArray(),c=_.find(b,function(b){return b.one(".libelle").html()===a});if(!c){b.push(n["new"](a,!0)),b=_.sortBy(b,function(a){return a.one(".libelle").text()});for(var d=0,e=b.length;e>d;d++)µ.one("#userTags").appendChild(b[d])}return this.reset(),!1},close:function(){return new Promise(function(a){µ.one("#cloud").isVisible()?n.show().then(a):(q.over(!1),a())})},destroy:function(){µ.alls("#cloud span").removeAll()},generate:function(){var a=µ.one("#cloud"),c=function(){n.show(),b.bytags(this.text()),q.toggle(!1)},d=~~(a.clientHeight/2),e=~~(a.clientWidth/2),f=e/d,g=3,h=[],i=function(a,b){for(var c=function(a,b){return Math.abs(2*a.offsetLeft+a.offsetWidth-2*b.offsetLeft-b.offsetWidth)<a.offsetWidth+b.offsetWidth&&Math.abs(2*a.offsetTop+a.offsetHeight-2*b.offsetTop-b.offsetHeight)<a.offsetHeight+b.offsetHeight},d=0,e=b.length;e>d;d++)if(c(a,b[d]))return!0;return!1};n.destroy();for(var j=0,k=n.cloud.length;k>j;j++){var l=n.cloud[j],m=a.newElement("span",{"class":"tag tag"+Math.min(~~(l.weight/5)+1,10)}).html(l.text),o=d-m.clientHeight/2,p=e-m.clientWidth/2,r=0,s=6.28*Math.random();for(m.css({top:o,left:p});i(m,h);)r+=g,s+=(j%2===0?1:-1)*g,o=d+r*Math.sin(s)-m.clientHeight/2,p=e-m.clientWidth/2+r*Math.cos(s)*f,m.css({top:o,left:p});h.push(m)}a.alls("span").setEvents("click",c)},init:function(){var a=_.countBy(_.flatten(_.compact(_.pluck(o.get().collection,"book.tags")),!0).sort());if(n.cloud=[],n.destroy(),a){var b="";_.forEach(a,function(a,c){n.cloud.push({text:c,weight:a}),b+="<option>"+c+"</option>"}),µ.one("#tagsList").html(b),n.cloud=_.sortBy(n.cloud,"weight").reverse(),µ.one("#collection").hasClass("active")&&µ.one("#tags").toggle(!_.isEmpty(a))}},list:function(){µ.one("@tag").setAttributes({list:this.value?"tagsList":"none"})},"new":function(a,c){var d=µ.one("#tempTag").cloneNode(!0);return d.removeAttribute("id"),d.setEvents("click",function(a){a.target.hasClass("libelle")?r.close().then(b.bytags(a.target.text())):this.fade(!1).then(function(){d.removeAll(),µ.one("#detailWindow [autofocus]").focus()})}),d.one(".libelle").html(a).toggleClass("new",!!c),d},show:function(){var a=µ.one("#cloud"),b=a.isVisible();return new Promise(function(c){µ.one("#wa").isVisible()||!µ.one("#collection").hasClass("active")?c():r.close().then(function(){µ.one("html").toggleClass("overflown",!b),b?a.fade(!1).then(c):a.fade(.9).then(function(){a.alls("span").length||n.generate(),c()})})})}},o=function(){var b,c=function(){};return c.prototype.init=function(a){return _.assign(this,a),this.collection=[],this.picture&&this.link&&(µ.one("#picture").setEvents("click",function(){window.open(b.link)}).toggle(!0).newElement("img",{src:this.picture,title:"Google+"}),µ.one("#picture").newElement("span").html(this.name),µ.one("#picture").newElement("hr")),µ.alls(".gSignIn").toggle(!!this.googleSignIn),µ.alls(".noSignIn").toggle(!this.googleSignIn),µ.one(".noSignIn input").setAttributes("required",!this.googleSignIn),this.connex||r.help(!0),this},c.prototype.addbook=function(b){var c=new a(b);return this.collection.push(c),c.cell.one(".add").toggle(!1),c.cell.one(".remove").toggle(!0),µ.one("#nbBooks").text(this.collection.length),c},c.prototype.bookcell=function(a){return _.find(this.collection,_.matchesProperty("book.id",a))},c.prototype.book=function(a){var b=this.bookcell(a);return b&&b.book?b.book:null},c.prototype.bookindex=function(a){return _.findIndex(this.collection,_.matchesProperty("book.id",a))},c.prototype.removebook=function(a){_.remove(this.collection,_.matchesProperty("id",a)),µ.one("#nbBooks").text(this.collection.length)},c.prototype.updated=function(a){this.name=a.name,this.googleSync=a.googleSync,r.close()},c.prototype.updatebook=function(a){_.assign(a,a.update),delete a.update;var b=this.bookcell(a.id);_.assign(b.book,a),a.title&&b.cell.one("header").text(a.title),a.authors&&b.cell.one("figcaption").text(a.authors.join(", ")),a.alternative&&(b.cell.one(".cover").src=a.alternative)},{get:function(){return b||(b=new c),b},destroy:function(){b=!1}}}(),p={addbook:function(a){return o.get().addbook(a)},collection:function(a){return new Promise(function(c){if(r.close(),µ.one("@filtre").value=µ.one("@last").value="",µ.one("#collection").hasClass("active"))window.scroll(0,0),µ.alls(".bookcell").toggleClass("tofilter tohide",!1),
µ.one("#sort [by]").trigger("click"),c();else{var d=µ.one(".sortBy");d&&h.blur.call(d.toggleClass("sortBy",!1)),h.hover.call(µ.one("#sort div")).toggleClass("sortBy",!0),b.destroy(),q.anim(!0),q.toggle(!0,!0).then(function(){µ.one("#nvb").toggleClass("inactive",!0),h.active.call(µ.one("#collection")),o.get().collection&&o.get().collection.length?(b.cells=o.get().collection,b.display(!1,!1,!0).then(function(a){l.endRequest(a),c()})):a&&a.length?b.show(a).then(function(a){b.cells.length&&(o.get().collection=b.cells),µ.one("#nbBooks").text(a),l.endRequest(a),c()}):(l.endRequest(),c())})}})},"delete":function(){return µ.one("#errPwd").toggle(!1),µ.one("@pwd").reportValidity()?(r.confirm("warning",µ.one("#delete").getAttribute("confirm")).then(function(){m.emit("deleteUser",µ.one("@pwd").value)}),!1):void 0},nokdated:function(){return µ.one("#errPwd").toggle(!0),!1},update:function(){return µ.one("#errPwd").fade(!1),m.emit("updateUser",this.formToJson()),!1}},q={anim:function(a){µ.one("#wa").fade(a)},over:function(a){µ.one("#w").toggleClass("over",a)},toggle:function(a,b){return q.p=new Promise(function(c){var d=µ.one("#w");d.one("img").toggle(!!b),d.isVisible()===a||r.on||q.on?c():(q.on=!0,µ.alls(".description").removeAll(),a?(µ.one("html").toggleClass("overflown",!0),d.fade(.5).then(c)):d.fade(!1).then(function(){µ.one("html").toggleClass("overflown",!1),q.over(!1),q.connection(!1),c()}))}),q.p.then(function(){delete q.on}),q.p},connection:function(a){var b=µ.one("#noConnect"),c=function(a){b.css({top:b.clientHeight+a.clientY>window.innerHeight?a.clientY-b.clientHeight:a.clientY,left:b.clientWidth+a.clientX>window.innerWidth?a.clientX-b.clientWidth:a.clientX})};a?µ.setEvents({mousemove:c}):µ.removeEventListener("mousemove",c),b.toggle(a)}},r={close:function(a){return new Promise(function(b){var c,d=µ.alls("form:not(#formFilter)");if(µ.one("#recommandWindow:not(.notdisplayed)")?(c=µ.one("#recommandWindow:not(.notdisplayed)"),a=!0):c=µ.alls(".window:not(.notdisplayed)"),q.over(!1),c){for(var e=0,f=d.length;f>e;e++)d[e].reset();c.fade(!1).then(function(){delete r.on,a===!0?b():q.toggle().then(b)})}else b()})},confirm:function(a,b){return new Promise(function(c,d){q.over(),µ.one("#confirmWindow header span").text(µ.one("#confirmWindow header span").getAttribute(a)),µ.one("#confirmWindow #confirm").text(b),µ.one("#confirmWindow .valid").setEvents("click",function(){c()}),µ.one("#confirmWindow .cancel").toggle("warning"===a).setEvents("click",function(){d()}),q.toggle(!0).then(function(){µ.one("#confirmWindow").css({top:s().top+10,left:"25%"}).fade(!0),µ.setEvents({"keyup keydown":Window.esc})})})},open:function(){var a=this;return new Promise(function(b,c){var d="string"==typeof a?a:a.getAttribute("window"),e=µ.one("#"+d);r.on&&r.on===d?r.close().then(b):n.close().then(function(){µ.one("#wa").isVisible()&&b(),_.includes(["previewWindow","recommandWindow"],d)?q.over(!0):µ.alls(".window:not(.notdisplayed)").fade(!1),"profileWindow"===d&&(µ.one("@mail").value=o.get().id,µ.one("@name").value=o.get().name,o.get().googleSignIn?(µ.one("@googleSignIn").setAttribute("checked",!0),o.get().googleSync&&µ.one("@googleSync").setAttribute("checked",!0)):µ.one("@pwd").setAttribute("required",!0),µ.one(".changePwd.notdisplayed")||r.togglePwd()),q.toggle(!0).then(function(){r.on=d,e.one("[autofocus]")&&e.one("[autofocus]").focus(),e.css({top:s().top}).fade(!0).then(b)}),µ.alls(".errMsg").toggle(!1)})})},togglePwd:function(){µ.alls(".changePwd").fade().then(function(a){for(var b=0,c=a.length;c>b;b++)a[b].alls("[type=password]").setAttributes({required:a[b].isVisible()})})}},s=function(){return{top:window.scrollY||µ.documentElement.scrollTop,left:window.scrollX||µ.documentElement.scrollLeft}};a.prototype.active=function(){if(!this.actived){var a=function(){var a=this.classList;k.cell.alls("button").fade(),_.includes(a,"add")&&m.emit("addBook",k.id),_.includes(a,"remove")&&(µ.one("#collection").hasClass("active")&&k.cell.fade().then(function(){k.cell.removeAll(),b.loadcovers()}),m.emit("removeBook",k.id),o.get().removebook(k.id),k.book.tags&&k.book.tags.length&&n.init())},c=function(a){if(a.relatedTarget&&!a.relatedTarget.hasClass("description")&&µ.alls(".description").removeAll(),"mouseenter"===a.type&&k.book.description){var b=k.book.description.indexOf(" ",500),c=function(){this.removeAll()},d={"max-height":window.innerHeight,left:Math.min(this.xposition()+this.clientWidth/3,window.innerWidth-1.333*this.clientWidth).toFixed(0)},e=(this.offsetTop+this.clientHeight/3).toFixed(0),f=µ.body.newElement("div",{width:this.clientWidth,bookid:k.id,"class":"description notdisplayed"}).css({width:this.clientWidth}).setEvents("click",c).html("<span>"+k.book.title+"</span><BR>"+k.book.description.substr(0,Math.max(b,500))+(-1!==b?"...":""));e+f.clientHeight>µ.clientHeight?d.bottom=.333*this.clientHeight:d.top=e,f.css(d),setTimeout(function(){f.setEvents("mouseleave",c).fade(.9)},1e3)}},d=function(){return-1!==o.get().bookindex(k.id)||k.opened?(e.data=k,e.show(-1!==o.get().bookindex(k.id))):g.getDetail(k.id).then(function(a){a?(e.data.book=a,e.show(!1)):(q.toggle(!0,!0),m.emit("searchDetail",k.id))}),!1},f=function(a){this.toggleClass("isDrag",!0),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("text",JSON.stringify(i))},h=function(){this.toggleClass("isDrag",!1)},i=this.id,j=function(){if(k.cell.hasClass("toshow")){var a=k.cell.one(".cover");a&&window.innerHeight+s().top>k.cell.offsetTop&&(k.cell.toggleClass("toshow",!1),k.cell.setEvents({"touchmove touchstart":f,touchend:h}),(k.book.alternative||k.book.base64)&&(a.src=k.book.alternative||k.book.base64),k.cell.one("footer").css({bottom:k.cell.one("figcaption").clientHeight+5}))}},k=this;this.cell.alls("header, figure").setEvents("click",d),this.cell.alls("button").setEvents("click",a),this.cell.setEvents({"mouseenter mouseleave":c,"touchmove touchstart":f,touchend:h}),this.cell.one("footer").css({bottom:this.cell.one("figcaption").clientHeight+5}),this.actived=!0,this.loadcover=j}},a.prototype.returned=function(a){this.book=a,this.opened=!0,e.data=this,e.show(),g.setDetail(a)},µ.setEvents({scroll:b.loadcovers}),µ.alls("input").setEvents("input propertychange",c),µ.one("#logout").setEvents("click",i),µ.alls("#h button, #help").setEvents({click:r.help}),µ.one("#formSearch").setEvents("submit",l.books),µ.one("#formProfil").setEvents("submit",p.update),µ.one("#formRecommand").setEvents("submit",e.sendNotif),µ.one("#formTag").setEvents("submit",n.add),µ.alls("form").setEvents("submit",function(a){a.preventDefault()}),µ.alls("#formNew button").setEvents("click",e.modify),µ.one("#changePwd").setEvents("click",r.togglePwd),µ.one("#delete").setEvents("click",p["delete"]),µ.one("#tris").setEvents("click",j.sort),µ.one("#notifications").setEvents("click",j.notif),µ.alls("#sort > div").setEvents("click",b.sort),µ.alls("[actclick]").setEvents("click",e.action),µ.alls(".closeWindow").setEvents("click",r.close),µ.one("#footer").setEvents("click",j.top),µ.alls("#uploadHidden [type=file]").setEvents("change",e.uploadCover),µ.alls("#userNote > img").setEvents({mouseenter:e.mouseNote,mouseleave:e.userNote,click:e.clickNote}),function(a){for(var b=0,c=a.length;c>b;b++)h.blur.call(a[b])}(µ.alls("[blur]")),µ.alls("img").setAttributes({draggable:!1}),µ.one("#collection").setEvents("click",p.collection),µ.alls("#tags, #cloud > img").setEvents("click",n.show),µ.alls("#recherche, #profil, #contact").setEvents("click",r.open),µ.one("#newbook").setEvents("click",e["new"]),µ.alls(".tnv, .action").setEvents("click",j.toggle),µ.alls("[url]").setEvents("click",j.link),µ.alls("[mail]").setEvents("click",j.mail),µ.one("#recommand4u").setEvents("click",l.recommand),µ.alls("#importNow, #exportNow").setEvents("click",l.gtrans),µ.alls("@tag").setEvents("input propertychange",n.list),window.setEvents({resize:f.resize,click:j.close}),µ.alls("[nav]").setEvents("click",j.nav),function(a){a?µ.one("@filtre").setEvents("search",b.filter):µ.one("#formFilter").setEvents("submit",function(a){return b.filter.call(µ.one("@filtre")),!1})}("onsearch"in µ.createElement("input"))})}else alert(document.body.getAttribute("error"));
