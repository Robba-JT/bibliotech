Array.prototype.assign=function(a){return this.push.apply(this,Array.isArray(a)?a:[a]),this},Array.prototype.noSpace=function(){for(var a=0,b=this.length;b>a;a++)"string"==typeof this[a]&&(this[a]=this[a].noSpace());return this},HTMLElement.prototype.closest=function(a){for(var b=this;b&&b.tagName&&"body"!==b.tagName.toLowerCase();){if(b.hasClass(a))return b;b=b.parentNode}return null},HTMLElement.prototype.css=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){_.includes(["width","max-width","height","max-height","top","left","bottom","padding-top"],c)&&-1===a.toString().indexOf("%")&&(a+="px"),b.style[c]=a}),this},HTMLElement.prototype.fade=function(a){a="undefined"==typeof a?!b.isVisible():a;var b=this,c=a?"fadein":"fadeout";return new Promise(function(d){a&&b.toggleClass("notdisplayed",!1),b.setEvents({animationend:function e(f){b.removeEvent("animationend",e).toggleClass(c,!1),a||b.toggleClass("notdisplayed",!0),d(b)}}).toggleClass(c,!0)})},HTMLElement.prototype.formToJson=function(){var a={};return this.querySelectorAll("input, textarea").forEach(function(){(_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.checked||!_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.name)&&(a[this.name]=this.value)}),a},HTMLElement.prototype.hasClass=function(a){return this.classList.contains(a)},HTMLElement.prototype.html=function(a){return"undefined"==typeof a?this.innerHTML:(this.innerHTML=a,this)},HTMLElement.prototype.index=function(){for(var a=this.parentNode.childNodes,b=0,c=a.length;c>b;b++)if(a[b]===this)return b;return-1},HTMLElement.prototype.isVisible=function(){return this.offsetWidth>0&&this.offsetHeight>0},HTMLElement.prototype.newElement=function(a,b){var c=document.createElement(a);return _.isPlainObject(b)&&c.setAttributes(b),this.appendChild(c),c},StyleSheetList.prototype.removeAll=HTMLElement.prototype.removeAll=function(){return this.remove?this.remove():this.parentNode.removeChild(this),this},HTMLElement.prototype.removeAttributes=function(a){var b=this;return"string"==typeof a&&(a=[a]),_.isArray(a)&&a.forEach(function(a){b.removeAttribute(a)}),this},HTMLElement.prototype.removeEvent=function(a,b){return this.removeEventListener(a,b),this},HTMLElement.prototype.setAttributes=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){b.setAttribute(c,a)}),this},Window.prototype.setEvents=HTMLDocument.prototype.setEvents=HTMLElement.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(d.addEventListener(a,b,c),d)},HTMLElement.prototype.setValue=function(a){return this.value=a,this},HTMLElement.prototype.siblings=function(a){return this.parentNode.alls(a)},HTMLElement.prototype.text=function(a){return"undefined"==typeof a?this.textContent:(this.textContent=a,this)},HTMLElement.prototype.toLeft=function(a){var b=this,c="undefined"==typeof a?b.offsetLeft<0:a,d=b.clientWidth,e=~~(d/20);return b.scrollTop=0,new Promise(function(a){var f=setInterval(function(){c?b.offsetLeft>=0?(clearInterval(f),a(b)):b.css({left:b.offsetLeft+e}):b.offsetLeft<=-d?(clearInterval(f),a(b)):b.css({left:b.offsetLeft-e})},5)})},HTMLElement.prototype.toggle=function(a){return("undefined"==typeof a||null===a)&&(a=!this.isVisible()),this.toggleClass("notdisplayed",!a),this},HTMLElement.prototype.toggleClass=function(a,b){var c=this;a=a.split(" ");var d="toggle";return"undefined"!=typeof b&&(d=b?"add":"remove"),a.forEach(function(a){c.classList[d](a)}),this},HTMLElement.prototype.trigger=function(a){var b;try{b=new Event(a)}catch(c){b=document.createEvent(_.includes(["click","mouseenter","mouseleave","mouseup","mousedown"],a)?"MouseEvents":"HTMLEvents"),b.initEvent(a,!0,!0)}return this.dispatchEvent(b),this},HTMLElement.prototype.xposition=function(){return this.parentNode&&this.parentNode.tagName?this.parentNode.offsetLeft:this.offsetLeft},HTMLDocument.prototype.alls=HTMLCollection.prototype.alls=HTMLElement.prototype.alls=NodeList.prototype.alls=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return[];if(d.multiSelect())a=this.querySelectorAll(b);else switch(c){case"#":a=[document.getElementById(d)];break;case"@":a=document.getElementsByName(d);break;case".":a=this.getElementsByClassName(d);break;default:a=this.getElementsByTagName(b)}return a},HTMLCollection.prototype.css=NodeList.prototype.css=function(a){return this.forEach(function(){this.css(this)}),this},HTMLCollection.prototype.fade=NodeList.prototype.fade=function(a){var b=[];return this.forEach(function(){b.push(this.fade(a))}),Promise.all(b)},HTMLCollection.prototype.forEach=NodeList.prototype.forEach=function(a){return[].forEach.call(this,function(b){a.call(b)}),this},HTMLCollection.prototype.html=NodeList.prototype.html=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.html(a)}),this)},HTMLDocument.prototype.one=HTMLCollection.prototype.one=HTMLElement.prototype.one=NodeList.prototype.one=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return null;if(d.multiSelect())a=this.querySelector(b);else switch(c){case"#":a=document.getElementById(d);break;case"@":a=document.getElementsByName(d)[0];break;case".":a=this.getElementsByClassName(d)[0];break;default:a=this.getElementsByTagName(b)[0]}return a},HTMLCollection.prototype.removeAll=NodeList.prototype.removeAll=function(){return this.forEach(function(){this.removeAll()}),this},HTMLCollection.prototype.removeAttributes=NodeList.prototype.removeAttributes=function(a){return"string"==typeof attrs&&(a=[a]),this.forEach(function(){this.removeAttributes(a)}),this},HTMLCollection.prototype.removeEvent=NodeList.prototype.removeEvent=function(a,b){return this.forEach(function(){this.removeEvent(a,b)}),this},HTMLCollection.prototype.setAttributes=NodeList.prototype.setAttributes=function(a){return this.forEach(function(){this.setAttributes(a)}),this},HTMLCollection.prototype.setEvents=NodeList.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(a=a.split(" "),d.forEach(function(){var d=this;a.forEach(function(a){d.addEventListener(a,b,c)})}),d)},HTMLCollection.prototype.setValue=NodeList.prototype.setValue=function(a){return this.forEach(function(){this.setValue(a)}),this},HTMLCollection.prototype.text=NodeList.prototype.text=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.text(a)}),this)},HTMLCollection.prototype.toArray=NodeList.prototype.toArray=function(){return[].slice.call(this)},HTMLCollection.prototype.toggle=NodeList.prototype.toggle=function(a,b){return this.forEach(function(){this.toggle(a,b)}),this},HTMLCollection.prototype.toggleClass=NodeList.prototype.toggleClass=function(a,b){return this.forEach(function(){this.toggleClass(a,b)}),this},HTMLCollection.prototype.trigger=NodeList.prototype.trigger=function(a){return this.forEach(function(){this.trigger(a)}),this},String.prototype.fd=function(){var a=this.substr(0,10).split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),a},String.prototype.multiSelect=function(){return-1!==this.indexOf(" ")||-1!==this.indexOf(",")||-1!==this.indexOf(".")||-1!==this.indexOf("#")||-1!==this.indexOf(":")||-1!==this.indexOf("]")},String.prototype.noSpace=function(){return this.replace(/^\s+/g,"").replace(/\s+$/g,"").replace(/\s{2,}/g," ")},window.FileReader&&window.Promise&&"formNoValidate"in document.createElement("input")?document.setEvents("DOMContentLoaded",function(){"use strict";var a=document,b=new Date,c=function(b,c){var e=d.cells.length+("undefined"==typeof c?1:c),f=a.one("#collection").hasClass("active")||-1!==q.get().bookindex(b.id);return this.id=b.id,this.book=b,this.cell=a.one("#tempCell").cloneNode(!0).removeAttributes("id").toggleClass("bookcell",!0),this.cell.one("header").text(b.title),this.cell.one("figcaption").text(b.authors?b.authors.join(", "):""),this.cell.one(".previewable").toggle(!!b.access&&"NONE"!==b.access),this.cell.one(".recommanded").toggle(!!b.from),this.cell.one(".personnal").toggle(_.isEqual(b.id.user,q.get().id)),this.cell.one(".add").toggle(!f),this.cell.one(".remove").toggle(!!f),this.cell.col=e%h.nbcols,this.cell.row=Math.floor(e/h.nbcols),(b.alternative||b.base64)&&(this.cell.one(".cover").src=b.alternative||b.base64),this.active(),this},d={books:[],bytags:function(b){if(a.one("#collection").hasClass("active")){window.scroll(0,0),a.one("#formFilter").reset(),a.alls(".bookcell").toggleClass("tofilter",!1);for(var c=0,e=d.cells.length;e>c;c++){var f=d.cells[c];f.cell.toggleClass("tohide",!_.includes(f.book.tags,b))}d.display()}},cells:[],destroy:function(){if(h.remove(),d.books=[],!a.one("#collection").hasClass("active"))for(var b=0,c=d.cells.length;c>b;b++)d.cells[b].destroy();d.cells=[]},display:function(b,c,e){var f=[c,e];return new Promise(function(g){if(!b&&a.one(".sortBy"))g(d.sort.call(a.one(".sortBy"),f));else{b=b||_.sortBy(d.cells,function(a){return[a.row,a.col]});for(var i=0,j=h.get(),k=0,l=b.length;l>k;k++){var m=(b[k],b[k].cell);e&&m.toggleClass("tohide tofilter",!1),m.hasClass("tohide")||m.hasClass("tofilter")?h.get().one("section.notdisplayed").appendChild(m):(m.toggleClass("toshow",!0),j.one('[colid="'+(c?m.col:i%h.nbcols)+'"]').appendChild(m),i++)}s.toggle(!1),d.loadcovers(),g(d.cells.length)}})},filter:function(){var b=this.value.toLowerCase(),c=a.one("@last");if(a.one(".tnv").trigger("click"),this.checkValidity()&&b!==c.value){c.value=b;for(var e=0,f=d.cells.length;f>e;e++){var g=d.cells[e],h=g.book.title.toLowerCase(),i=g.book.subtitle?g.book.subtitle.toLowerCase():"",j=g.book.authors?g.book.authors.join(", ").toLowerCase():"",k=g.book.description.toLowerCase();g.cell.toggleClass("tofilter",-1===h.indexOf(b)&&-1===i.indexOf(b)&&-1===j.indexOf(b)&&-1===k.indexOf(b))}d.display()}},generate:function(b){return new Promise(function(e){for(var f=[],g=0,h=b.length;h>g;g++)d.one(b[g].id)||-1!==_.findIndex(f,_.matchesProperty("id",b[g].id))||f.push(new c(q.get().book(b[g].id)||b[g],g));d.cells.assign(f),!a.one("#collection").hasClass("active")&&n.last&&(d.books.push(b),d.books=_.flatten(d.books)),e(f)})},loadcovers:function(){for(var a=0,b=d.cells.length;b>a;a++)d.cells[a].loadcover();l.toggleFooter()},one:function(a){return _.find(d.cells,_.matchesProperty("id",a))},returned:function(a){d.one(a.id).returned(a)},show:function(a){for(var b,c=_.chunk(a,40),e=function(a){return new Promise(function(b){d.generate(a).then(function(a){d.display(a,!0)}).then(b)})},f=0,g=c.length;g>f;f++)b=b?b.then(e(c[f])):b=e(c[f]);return b},sort:function(){var b=arguments[0]||[];if(window.scroll(0,0),!this.hasClass("active")){var c=this;a.one(".sortBy")&&j.blur.call(a.one(".sortBy").toggleClass("sortBy",!1)),j.hover.call(this).toggleClass("sortBy",!0),d.display(_.sortByOrder(d.cells,["book."+[c.getAttribute("by")]],"desc"!==c.getAttribute("sort")),b[0]||!1,b[1]||!1)}}},e=function(){var b;switch(this.setCustomValidity(""),this.name){case"confirmPwd":b=this.value!==a.one("@newPwd").value;break;case"filtre":b=!!this.value.length&&this.value.length<3;break;case"name":b=this.value.length<4;break;case"newPwd":b=this.value.length<4||this.value.length>12;break;case"pwd":b=this.value.length<4||this.value.length>12;break;case"recommand":b=this.value.toLowerCase()===q.get().id;break;case"searchinput":b=this.value.length<3;break;case"title":b=this.value.length<6}b&&this.setCustomValidity(this.getAttribute("error"))},f=new ColorThief,g={action:function(){var b=g.data.book.id,c=q.get().book(b),d=this.getAttribute("actclick");this.add=function(){if(b)o.emit("addDetail"),a.alls('[actclick="upload"]').toggle(!g.data.book.cover),g.newCell();else{for(var c,d=a.one("#formNew").formToJson(),e=a.alls("#formNew input, #formNew textarea"),f=0,h=e.length;h>f;f++)if(!e[f].reportValidity()){c=!0;break}if(d.authors=d.authors?d.authors.split(","):[],d.authors.noSpace(),c)return!1;s.over(),o.emit("newbook",d)}},this.associated=function(){n.associated(b)},this.close=function(){this.closest("window").fade(!1).then(function(a){delete t.on,s.over(!1),a.one("iframe")&&window.frames.iPreview&&window.frames.iPreview.document.getElementById("viewer")&&(window.frames.iPreview.document.getElementById("viewer").innerHTML="")})},this.google=function(){window.open(this.getAttribute("link"))},this.preview=function(){a.one("@previewid").value=b,s.over(),t.open.call("previewWindow").then(function(b){a.one("#preview").submit()})},this.recommand=function(){s.over(),t.open.call("recommandWindow")},this.update=function(){var d=!1,e={id:b},f=_.map(a.alls("#userTags > div").toArray(),function(a){return a.one(".libelle").text()}),g=a.one("#userNote").value,h=a.one("#userComment").value;if(_.isObject(b)&&b.user===q.get().id){var i=a.one("#formNew").formToJson();i.authors=i.authors.split(",")||[],_.forEach(i,function(a,b){a=a.noSpace(),_.isEqual(c[b],a)||(d=!0,e.update||(e.update={}),e.update[b]=a)})}(g||c.userNote)&&g!==c.userNote&&(d=!0,e.userNote=g),(h||c.userComment)&&h!==c.userComment&&(d=!0,e.userComment=h),(f.length||c.tags&&c.tags.length)&&!_.isEqual(f,c.tags)&&(d="tags",e.tags=f),d&&(e.userDate=(new Date).toJSON(),o.emit("updateBook",e),q.get().updatebook(e),p.init(),a.one("#tags").toggle(!!p.cloud.length&&a.one("#collection").hasClass("active"))),t.close()},this.upload=function(){a.one("#uploadHidden [type=file]").trigger("click")},this[d].call(this)},clickNote:function(){var b=a.one("#userNote"),c=this.getAttribute("note");b.value===c&&"1"===b.value?b.value=0:b.value=c,g.userNote()},data:{},links:function(){var b=this.getAttribute("searchby"),c=this.text();b&&c&&(a.one("#formSearch [type=search]","").value=c,a.alls("#formSearch [name=searchby]")[b].checked=!0,a.one("#formSearch").trigger("submit"))},mainColor:function(a){var b=f.getColor(a),c="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:c}},modify:function(){if(this.hasClass("modify")){if(this.hasClass("hide"))for(var a=this.siblings("[name]"),b=0,c=a.length;c>b;b++)a[b].value=a[b].getAttribute("oldvalue");this.toggleClass("hide"),this.siblings("[field]:not(.noValue), [name]").toggle(null);var d=this.siblings("[name]")[0];d.focus(),"textarea"===d.tagName.toLowerCase()&&(d.scrollTop=0)}},mouseNote:function(){var b=a.one("#userNote").value||0,c=this.getAttribute("note"),d=a.alls("[note]").toArray();if(b!==c)for(var e=0;e<Math.max(b,c);e++)e<Math.min(b,c)?d[e].src=images[d[e].getAttribute("select")].black:b>c?d[e].src=images[d[e].getAttribute("hoverminus")].black:d[e].src=images[d[e].getAttribute("hoverplus")].black},"new":function(){g.data.book={},g.show(!1),a.one("#formNew").reset(),a.alls("#formNew input, #formNew textarea, .volumeInfo:not(.nonEditable), .volumeInfo:not(.nonEditable) button").toggle(!0),a.alls("#formNew [field]").toggle(!1)},newCell:function(){a.alls("[actclick=add], [actclick=update], #upload, .inCollection").toggle();var b=d.one(g.data.book.id),c=q.get().addbook(g.data.book);a.one("#collection").hasClass("active")&&!b&&(d.cells.push(c),d.display()),b&&b.cell&&b.cell.alls("button").fade()},sendNotif:function(){var b=this.formToJson();return b.book=g.data.book.id,b.title=g.data.book.title,g.data.book.alt&&(b.alt=g.data.book.alt),o.emit("sendNotif",b),a.one("#recommandWindow .closeWindow").trigger("click"),!1},show:function(b){var c=g.data.book,d=a.one("#detailWindow");a.one("#formNew").reset(),a.one("#formRecommand").reset(),d.alls("#formNew input, #formNew textarea").toggle(!1),d.alls("#formNew button:not(.categories)").toggleClass("hide",!1).toggleClass("modify",!!c.id&&_.isEqual(c.id.user,q.get().id)),a.alls("#comments *").removeAll(),a.one("#userComment").value="";for(var e=0,f=a.alls("[note]").length;f>e;e++)j.blur.call(a.alls("[note]")[e]);a.one("#userNote").value=c.note,d.alls(".inCollection").toggle(!!b).css({background:"whitesmoke"}),p.list(),a.one("#background").toggle(!!c.alternative||!!c.base64),(c.alternative||c.base64)&&a.one("#background").css({"background-image":"url("+(c.alternative||c.base64).toString()+")"}),d.alls(".direct").text(""),d.alls("#userTags > div").removeAll(),a.alls("[actclick=add]").toggle(!b),a.alls("[actclick=update], [actclick=recommand]").toggle(!!b),a.alls("[actclick=associated]").toggle(!!c.id&&!_.isObject(c.id)),a.alls("[actclick=preview]").toggle(!!c.access&&"NONE"!==c.access),a.alls("[actclick=google]").setAttributes({link:c.link}).toggle(!!c.link),a.alls("[actclick=upload]").toggle(!c.base64&&!c.cover&&!!b),d.alls(".comments").toggle(!!c.comments&&!!c.comments.length),d.alls("#detailWindow [field]").toggleClass("noValue",!1),d.alls("[field=authors] span").removeAll(),d.alls(".volumeInfo.nonEditable").toggle(!1),d.alls(".volumeInfo:not(.nonEditable)").toggle(!!c.id&&_.isEqual(c.id.user,q.get().id)),g.userNote(),d.hasClass("notdisplayed")&&t.open.call("detailWindow").then(function(){a.one("#detailContent").css({height:d.clientHeight-d.one("header").clientHeight}),a.one(".detailBook").scrollTop=0,a.alls(".new").toggleClass("new",!1)}),_.forEach(c,function(b,e){var f=d.one("[field="+e+"]"),h=d.one("input[name="+e+"], textarea[name="+e+"]");switch(f&&"subtitle"!==e&&(f.closest("volumeInfo").toggle(!!b||_.isEqual(c.id.user,q.get().id)),f.toggle(!!b).toggleClass("noValue",!b)),e){case"authors":for(var i=0,j=b.length;j>i;i++)f.newElement("span",{"class":"link",searchby:3}).text(b[i]);h.value=b.join(", "),h.setAttribute("oldvalue",b.join(", ")),f.parentNode.alls("button").toggle(!!b.length);break;case"tags":for(var k=a.one("#userTags"),l=0,m=b.length;m>l;l++)k.appendChild(p["new"](b[l]));break;case"userNote":b&&g.clickNote.call(a.one('[note="'+b+'"]'));break;case"userComment":a.one("#userComment").value=b;break;case"comments":var n,o=0;b.length||d.one(".comments").toggle(!1);for(var r=0,s=b.length;s>r;r++){if(b[r].comment){var t=a.one("#tempComment").cloneNode(!0);t.removeAttribute("id"),t.one(".commentAuthor").text(b[r].name),t.one(".commentDate").text(b[r].date.fd()),t.one(".commentNote").text(b[r].note),t.one(".commentComment").html(b[r].comment),a.one("#comments").appendChild(t)}b[r].note&&(n=(n||0)+parseInt(b[r].note,10),o++)}"undefined"!=typeof n&&o&&(n=(n/o).toFixed(2),a.one(".subtitle").toggle(!0),a.one("#mNote").text(n));break;default:if(!f)break;_.isArray(b)&&(b=b.join(", ")),h&&(h.setAttribute("oldvalue",b),h.value=b,h.scrollTop=0),"time"===f.tagName.toLowerCase()&&(f.setAttribute("datetime",new Date(b)),b=b.fd()),"description"===e?f.html(b):f.text(b)}}),a.alls(".link").setEvents("click",g.links,!1)},uploadCover:function(){var b=this.files;if(b[0]){if(!b[0].type.match(/image.*/)||b[0].size>5e5)return t.confirm("error",'Veuillez sélectionner un fichier de type "image" inférieure à 500KB.'),!1;var c=new FileReader;c.onload=function(b){return function(c){b.onload=function(){var b=g.mainColor(this);this.toggleClass("new",!0).setAttribute("mainColor",b.hex),a.one("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+b.hex+")")},b.src=c.target.result}}(a.one("#detailCover")),c.readAsDataURL(this.files[0])}},userNote:function(){for(var b=a.alls("[note]").toArray(),c=a.one("#userNote").value,d=0;d<b.length;d++)c>d?b[d].src=images[b[d].getAttribute("select")].black:b[d].src=images[b[d].getAttribute("source")].black}},h={get:function(){var b,c=a.one("#d");if(c||(c=a.body.newElement("section",{id:"d",role:"main"}),c.newElement("section",{"class":"notdisplayed"})),b=(c.clientWidth/h.nbcols).toFixed(0),c.alls(".col").length!==h.nbcols){c.alls(".col").removeAll();for(var e=0;e<h.nbcols;e++)c.newElement("div",{"class":"col",colid:e}).css({width:b,"max-width":b});a.alls(".col").setEvents({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(b){b.preventDefault();var c=d.one(JSON.parse(b.dataTransfer.getData("text"))).cell,e=b.target.closest("bookcell");return e?c!==e&&(e.closest("col").insertBefore(c,e),d.loadcovers(),a.one(".sortBy")&&j.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))):(this.appendChild(c),a.one(".sortBy")&&j.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))),!1}})}return c},nbcols:~~(window.innerWidth/192),remove:function(){a.one("#d")&&(a.one("#d").removeAll(),window.scroll(0,0))},resize:function(){h.nbcols!==~~(window.innerWidth/192)?(p.close().then(p.destroy),a.alls(".deroulant").fade(!1),h.nbcols=~~(window.innerWidth/192),h.remove(),d.display()):a.alls(".col").css({width:~~(window.innerWidth/h.nbcols),"max-width":~~(window.innerWidth/h.nbcols)}),a.one("#detailWindow").isVisible()&&(a.one("#detailWindow").css({height:window.innerHeight,top:0}),a.one("#detailContent").css({height:window.innerHeight-a.one("#detailWindow header").clientHeight}))}},i={deleteDetail:function(a){i.db&&i.db.transaction(["details"],"readwrite").objectStore("details")["delete"](a)},deleteQuery:function(a){i.db&&i.db.transaction(["queries"],"readwrite").objectStore("queries")["delete"](a)},getDetail:function(a){return new Promise(function(b){i.db||b();var c=i.db.transaction(["details"],"readwrite").objectStore("details").index("by_id").get(a);c.onsuccess=function(){this.result?b(this.result):b()},c.onerror=function(){b()}})},getQuery:function(a){return new Promise(function(b,c){i.db||c();var d=i.db.transaction(["queries"],"readwrite").objectStore("queries").index("by_query").get(JSON.stringify(a));d.onsuccess=function(){this.result&&this.result.books&&this.result.books.length?b(this.result.books):c()},d.onerror=c})},init:function(){return i.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,new Promise(function(a,b){if(i.indexedDB){var c=indexedDB.open(q.get().session,1);c.onerror=function(){b()},c.onsuccess=function(){i.db=this.result,a()},c.onupgradeneeded=function(){var a=this.result;a.createObjectStore("queries",{keyPath:"query"}).createIndex("by_query","query",{unique:!0}),a.createObjectStore("details",{keyPath:"id"}).createIndex("by_id","id",{unique:!0})}}})},setDetail:function(a){if(i.db){i.db.transaction(["details"],"readwrite").objectStore("details").put(a)}},setQuery:function(a,b){if(i.db){i.db.transaction(["queries"],"readwrite").objectStore("queries").put({query:JSON.stringify(a),books:b})}}},j={active:function(){var b=a.one(".active"),c=this.one("img");return b&&(b.toggleClass("active",!1),j.blur.call(b)),this.toggleClass("active",!0),a.one("#tags").toggle("collection"===this.id&&!!p.cloud&&!!p.cloud.length),c&&(c.src=images[c.getAttribute("source")][c.getAttribute("active")]),this},blur:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("blur")],a.isVisible()||a.hasClass("nsv")||a.css({visibility:"visible"})),this)},hover:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("hover")]),this)}},k=function(){return s.toggle(!0),q.destroy(),i.indexedDB&&i.indexedDB.deleteDatabase(q.get().session),o.destroy(),location.assign("/logout"),!1},l={close:function(b){var c=b.target.closest("action");(c||b.target&&b.target.getAttribute("by"))&&(!c||_.includes(["notifications","tris"],c.getAttribute("id")))||a.alls(".deroulant").fade(!1)},link:function(){window.open(this.getAttribute("url"))},mail:function(){a.location.href="mailto:"+this.getAttribute("mail")},notif:function(b){var c=a.one("#notifs");c.isVisible()?c.fade(!1):c.fade(.95)},selectstart:function(a){return a.preventDefault(),a.target.tagName&&!_.includes(["input","textarea"],a.target.tagName.toLowerCase())?!1:void 0},show:function(){j.hover.call(a.one("#sort img")),a.alls("#tags, #notifications").toggle(!1)},sort:function(b){var c=a.one("#sort");c.isVisible()?c.fade(!1):c.fade(.95)},toggle:function(){a.one("#nvb").toLeft(a.one(".nvb:not(#nvb)").isVisible()),a.one(".nvb:not(#nvb)").fade()},toggleFooter:function(){a.one("#footer").toggle(!!u().top)},top:function(){var a=setInterval(function(){var b=(u().top/2-.1).toFixed(1);window.scroll(0,b),.1>=b&&(window.scroll(0,0),clearInterval(a))},100)}},m={click:function(){var b=JSON.parse(this.getAttribute("notif"));b._id.book;_.remove(m.list,b),m.last=b,a.one("#notifs").toggle(),this.removeAll(),a.alls("#notifications, #notifNumber").toggle(!!m.list.length),a.one("#notifNumber").text(m.list.length),s.toggle(!0,!0),o.emit("readNotif",b)},show:function(b){b&&(m.list=b),a.alls("#notifications, #notifNumber").toggle(!!m.list.length),a.one("#notifNumber").text(m.list.length);for(var c=0,d=m.list.length;d>c;c++){var e=m.list[c],f=a.one("#tempNotif").cloneNode(!0);f.setAttributes({notif:JSON.stringify(e)}).removeAttribute("id"),f.one(".notifName").html(e.from),f.one(".notifTitle").text(e.title),f.setEvents("click",m.click),a.one("#notifs").appendChild(f)}}},n={associated:function(b){n.clear(),n.last={associated:b},t.close(!0).then(function(){s.toggle(!0,!0).then(function(){i.getQuery(n.last).then(d.show,function(){a.one("#nvb").toggleClass("inactive",!0),s.anim(!0),o.emit("associated",b)})["catch"](function(a){})})})},books:function(){var b=this.formToJson();return n.last={q:b.searchby+b.searchinput,langRestrict:b.langage},a.one("@filtre").value=a.one("@last").value="",n.clear(),t.close(!0).then(function(){s.toggle(!0,!0).then(function(){i.getQuery(n.last).then(d.show)["catch"](function(){a.one("#nvb").toggleClass("inactive",!0),s.anim(!0),o.emit("searchBooks",n.last)})})}),!1},clear:function(){d.destroy(),h.remove(),j.active.call(a.one("#recherche")),a.one("#formFilter").reset(),a.one(".sortBy")&&j.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))},endRequest:function(b){a.one("#nvb").toggleClass("inactive",!1),s.anim(!1),b||s.toggle(!1),!a.one("#collection").hasClass("active")&&n.last&&i.setQuery(n.last,d.books)},gtrans:function(){var b=this.id;t.confirm("warning","Cette opération va importer/exporter vos EBooks depuis/vers votre bibliothèque Google.<BR>Etes vous sur de vouloir continuer?").then(function(){return"exportNow"===b?o.emit("exportNow"):(d.destroy(),j.active.call(a.one("#collection")),a.one("#nvb").toggleClass("inactive",!0),s.anim(!0),void t.close(!0).then(function(){s.toggle(!0,!0),o.emit("importNow")}))})},recommand:function(){n.clear(),n.last={recommand:q.get().id},t.close(!0).then(function(){s.toggle(!0,!0).then(function(){i.getQuery(n.last).then(d.show)["catch"](function(){a.one("#nvb").toggleClass("inactive",!0),s.anim(!0),o.emit("recommanded")})})})}},o=function(c){var e=function(){var e=c.connect("/",{secure:!0,multiplex:!1});return e.once("connect",function(){b=new Date,this.once("disconnect",function(b){f(this),q.destroy(),t.close().then(function(){s.toggle(!0,!0),s.connection(!0),a.alls(".deroulant").toggle(!1),a.one("#picture *")&&a.alls("#picture *").removeAll(),a.alls("#notifications, #tags").toggle(!1),j.blur.call(a.one(".active").toggleClass("active",!1));for(var b=a.alls("form"),c=0,e=b.length;e>c;c++)b[c].reset();d.destroy()})}).on("books",d.show).on("initCollect",function(a){q.get().collection.assign(a),r.initCollect(a)}).on("endCollect",function(b){q.get().collection.assign(b.books),r.initCollect(b.books).then(function(){q.get().collection=d.cells,p.init(),m.show(b.notifs),n.endRequest(d.cells.length),a.one("#nbBooks").text(q.get().collection.length)})}).on("covers",function(b){for(var c=0,d=b.length;d>c;c++)if(b[c]&&b[c].id&&b[c].base64){var e=b[c],f=q.get().bookcell(e.id),h=f.book;if(h.base64=e.base64,f&&f.cell){var i=f.cell;i.hasClass("toshow")||(i.one(".cover").src=e.base64),g.data.book&&g.data.book.id===h.id&&a.one("#background").css({"background-image":"url("+e.base64.toString()+")"}).toggle(!0)}}}).on("endRequest",n.endRequest).on("error",function(a){}).on("logout",k).on("newbook",function(a){g.bookid=a.id,g.data={book:a},g.newCell(),g.show(!0),s.over(!1)}).on("returnAdd",r.addbook).on("returnDetail",d.returned).on("returnNotif",function(a){g.bookid=a.id,g.data={book:a},g.show(-1!==q.get().bookindex(a.id))}).on("updateNok",r.nokdated).on("updateOk",r.updated).on("user",function(a){l.show(),q.get().init(a),i.db||i.init()}).emit("isConnected")}),e},f=function(a){a.destroy();var b=setInterval(function(){a&&a.connected&&"open"===a.io.readyState&&(clearInterval(b),o=e());try{a.connect()}catch(c){}},3e3)};return e()}(io),p={add:function(){var b=this.formToJson().tag.toLowerCase(),c=a.alls("#userTags > div").toArray(),d=_.find(c,function(a){return a.one(".libelle").html()===b});if(!d){c.push(p["new"](b,!0)),c=_.sortBy(c,function(a){return a.one(".libelle").text()});for(var e=0,f=c.length;f>e;e++)a.one("#userTags").appendChild(c[e])}return this.reset(),!1},close:function(){return new Promise(function(b){a.one("#cloud").isVisible()?p.show().then(b):(s.over(!1),b())})},destroy:function(){a.alls("#cloud span").removeAll()},generate:function(){var b=a.one("#cloud"),c=function(){p.show(),d.bytags(this.text()),s.toggle(!1)},e=~~(b.clientHeight/2),f=~~(b.clientWidth/2),g=f/e,h=3,i=[],j=function(a,b){for(var c=function(a,b){return Math.abs(2*a.offsetLeft+a.offsetWidth-2*b.offsetLeft-b.offsetWidth)<a.offsetWidth+b.offsetWidth&&Math.abs(2*a.offsetTop+a.offsetHeight-2*b.offsetTop-b.offsetHeight)<a.offsetHeight+b.offsetHeight},d=0,e=b.length;e>d;d++)if(c(a,b[d]))return!0;return!1};p.destroy();for(var k=0,l=p.cloud.length;l>k;k++){var m=p.cloud[k],n=b.newElement("span",{"class":"tag tag"+Math.min(~~(m.weight/5)+1,10)}).html(m.text),o=e-n.clientHeight/2,q=f-n.clientWidth/2,r=0,t=6.28*Math.random();for(n.css({top:o,left:q});j(n,i);)r+=h,t+=(k%2===0?1:-1)*h,o=e+r*Math.sin(t)-n.clientHeight/2,q=f-n.clientWidth/2+r*Math.cos(t)*g,n.css({top:o,left:q});i.push(n)}b.alls("span").setEvents("click",c)},init:function(){var b=_.countBy(_.flatten(_.compact(_.pluck(q.get().collection,"book.tags")),!0).sort());if(p.cloud=[],p.destroy(),b){var c="";_.forEach(b,function(a,b){p.cloud.push({text:b,weight:a}),c+="<option>"+b+"</option>"}),a.one("#tagsList").html(c),p.cloud=_.sortBy(p.cloud,"weight").reverse(),a.one("#collection").hasClass("active")&&a.one("#tags").toggle(!_.isEmpty(b))}},list:function(){a.one("@tag").setAttributes({list:this.value?"tagsList":"none"})},"new":function(b,c){var e=a.one("#tempTag").cloneNode(!0);return e.removeAttribute("id"),e.setEvents("click",function(b){b.target.hasClass("libelle")?t.close().then(d.bytags(b.target.text())):this.fade(!1).then(function(){e.removeAll(),a.one("#detailWindow [autofocus]").focus()})}),e.one(".libelle").html(b).toggleClass("new",!!c),e},show:function(){var b=a.one("#cloud"),c=b.isVisible();return new Promise(function(d){a.one("#wa").isVisible()||!a.one("#collection").hasClass("active")?d():t.close().then(function(){a.alls("html, body").toggleClass("overflown",!c),c?b.fade(!1).then(d):b.fade(.9).then(function(){b.alls("span").length||p.generate(),d()})})})}},q=function(){var b,d=function(){};return d.prototype.init=function(c){return _.assign(this,c),this.collection=[],this.picture&&this.link&&(a.one("#picture").setEvents("click",function(){window.open(b.link)}).toggle(!0).newElement("img",{src:this.picture,title:"Google+"}),a.one("#picture").newElement("span").html(this.name),a.one("#picture").newElement("hr")),a.alls(".gSignIn").toggle(!!this.googleSignIn),a.alls(".noSignIn").toggle(!this.googleSignIn),a.one(".noSignIn input").setAttributes("required",!this.googleSignIn),this.connex||t.help(!0),this},d.prototype.addbook=function(b){var d=new c(b);return this.collection.push(d),d.cell.one(".add").toggle(!1),d.cell.one(".remove").toggle(!0),a.one("#nbBooks").text(this.collection.length),d},d.prototype.bookcell=function(a){return _.find(this.collection,_.matchesProperty("book.id",a))},d.prototype.book=function(a){var b=this.bookcell(a);return b&&b.book?b.book:null},d.prototype.bookindex=function(a){return _.findIndex(this.collection,_.matchesProperty("id",a))},d.prototype.removebook=function(b){_.remove(this.collection,_.matchesProperty("id",b)),
a.one("#nbBooks").text(this.collection.length)},d.prototype.updated=function(a){this.name=a.name,this.googleSync=a.googleSync,t.close()},d.prototype.updatebook=function(a){_.assign(a,a.update),delete a.update;var b=this.bookcell(a.id);_.assign(b.book,a),a.title&&b.cell.one("header").text(a.title),a.authors&&b.cell.one("figcaption").text(a.authors.join(", ")),a.alternative&&(b.cell.one(".cover").src=a.alternative)},{get:function(){return b||(b=new d),b},destroy:function(){b=!1}}}(),r={addbook:function(a){return q.get().addbook(a)},initCollect:function(b){return a.one("#collection").hasClass("active")||j.active.call(a.one("#collection").toggleClass("active",!0)),new Promise(function(a){s.anim(!0),d.show(b).then(a)})},collection:function(b){return new Promise(function(b){if(t.close(),a.one("@filtre").value=a.one("@last").value="",a.one("#collection").hasClass("active"))window.scroll(0,0),a.alls(".bookcell").toggleClass("tofilter tohide",!1),a.one("#sort [by]").trigger("click"),b();else{var c=a.one(".sortBy");c&&j.blur.call(c.toggleClass("sortBy",!1)),j.hover.call(a.one("#sort div")).toggleClass("sortBy",!0),d.destroy(),s.anim(!0),s.toggle(!0,!0).then(function(){a.one("#nvb").toggleClass("inactive",!0),j.active.call(a.one("#collection")),d.cells=q.get().collection,d.display(!1,!1,!0).then(function(a){n.endRequest(a),b()})})}})},"delete":function(){return a.one("#errPwd").toggle(!1),a.one("@pwd").reportValidity()?(t.confirm("warning",a.one("#delete").getAttribute("confirm")).then(function(){o.emit("deleteUser",a.one("@pwd").value)}),!1):void 0},nokdated:function(){return a.one("#errPwd").toggle(!0),!1},update:function(){return a.one("#errPwd").fade(!1),o.emit("updateUser",this.formToJson()),!1}},s={anim:function(b){a.one("#wa").isVisible!==b&&a.one("#wa").fade(b)},over:function(b){a.one("#w").toggleClass("over",b)},toggle:function(b,c){return s.p=new Promise(function(d){var e=a.one("#w");e.one("img").toggle(!!c),e.isVisible()===b||t.on||s.on?d():(s.on=!0,a.alls(".description").removeAll(),b?(a.alls("html, body").toggleClass("overflown",!0),e.fade(.5).then(d)):e.fade(!1).then(function(){a.alls("html, body").toggleClass("overflown",!1),s.over(!1),s.connection(!1),d()}))}),s.p.then(function(){delete s.on}),s.p},connection:function(b){var c=a.one("#noConnect"),d=function(a){c.css({top:c.clientHeight+a.clientY>window.innerHeight?a.clientY-c.clientHeight:a.clientY,left:c.clientWidth+a.clientX>window.innerWidth?a.clientX-c.clientWidth:a.clientX})};b?a.setEvents({mousemove:d}):a.removeEventListener("mousemove",d),c.toggle(b)}},t={close:function(b){return new Promise(function(c){var d,e=a.alls("form:not(#formFilter)");if(a.one("#recommandWindow:not(.notdisplayed)")?(d=a.one("#recommandWindow:not(.notdisplayed)"),b=!0):d=a.alls(".window:not(.notdisplayed)"),s.over(!1),d){for(var f=0,g=e.length;g>f;f++)e[f].reset();d.fade(!1).then(function(){delete t.on,b===!0?c():s.toggle().then(c)})}else c()})},confirm:function(b,c){return new Promise(function(d,e){s.over(),a.one("#confirmWindow header span").text(a.one("#confirmWindow header span").getAttribute(b)),a.one("#confirmWindow #confirm").text(c),a.one("#confirmWindow .valid").setEvents("click",function(){d()}),a.one("#confirmWindow .cancel").toggle("warning"===b).setEvents("click",function(){e()}),s.toggle(!0).then(function(){a.one("#confirmWindow").css({top:u().top+10,left:"25%"}).fade(!0),a.setEvents({"keyup keydown":Window.esc})})})},open:function(){var b=this;return new Promise(function(c,d){var e="string"==typeof b?b:b.getAttribute("window"),f=a.one("#"+e);t.on&&t.on===e?t.close().then(c):p.close().then(function(){_.includes(["previewWindow","recommandWindow"],e)?s.over(!0):a.alls(".window:not(.notdisplayed)").fade(!1),"profileWindow"===e&&(a.one("@mail").value=q.get().id,a.one("@name").value=q.get().name,q.get().googleSignIn?(a.one("@googleSignIn").setAttribute("checked",!0),q.get().googleSync&&a.one("@googleSync").setAttribute("checked",!0)):a.one("@pwd").setAttribute("required",!0),a.one(".changePwd.notdisplayed")||t.togglePwd()),a.alls(".errMsg").toggle(!1),s.toggle(!0).then(function(){t.on=e,f.css({top:u().top}).fade(!0).then(function(){f.one("[autofocus]")&&f.one("[autofocus]").focus(),c()})})})})},togglePwd:function(){a.alls(".changePwd").fade().then(function(a){for(var b=0,c=a.length;c>b;b++)a[b].alls("[type=password]").setAttributes({required:a[b].isVisible()})})}},u=function(){return{top:window.scrollY||a.documentElement.scrollTop,left:window.scrollX||a.documentElement.scrollLeft}};c.prototype.active=function(){if(!this.actived){var b=function(){var b=this.classList;m.cell.alls("button").fade(),_.includes(b,"add")&&o.emit("addBook",m.id),_.includes(b,"remove")&&(a.one("#collection").hasClass("active")&&m.cell.fade().then(function(){m.cell.removeAll(),d.loadcovers()}),o.emit("removeBook",m.id),q.get().removebook(m.id),m.book.tags&&m.book.tags.length&&p.init())},c=function(b){if(b.relatedTarget&&!b.relatedTarget.hasClass("description")&&a.alls(".description").removeAll(),"mouseenter"===b.type&&m.book.description){var c=m.book.description.indexOf(" ",500),d=function(){this.removeAll()},e={"max-height":window.innerHeight,left:Math.min(this.xposition()+this.clientWidth/3,window.innerWidth-1.333*this.clientWidth).toFixed(0)},f=(this.offsetTop+this.clientHeight/3).toFixed(0),g=a.body.newElement("div",{width:this.clientWidth,bookid:m.id,"class":"description notdisplayed"}).css({width:this.clientWidth}).setEvents("click",d).html("<span>"+m.book.title+"</span><BR>"+m.book.description.substr(0,Math.max(c,500))+(-1!==c?"...":""));f+g.clientHeight>a.clientHeight?e.bottom=.333*this.clientHeight:e.top=f,g.css(e),setTimeout(function(){g.setEvents("mouseleave",d).fade(.9)},1e3)}},e=function(){m.cell.alls("button").removeEvent("click",b),m.cell.alls("header, figure").removeEvent("click",f),m.cell.removeEvent("mouseenter mouseleave",c).removeEvent("dragstart",h).removeEvent("dragend",j).removeAll()},f=function(){return-1!==q.get().bookindex(m.id)||m.opened?(g.data=m,g.show(-1!==q.get().bookindex(m.id))):i.getDetail(m.id).then(function(a){a?(g.data.book=a,g.show(!1)):(s.toggle(!0,!0),o.emit("searchDetail",m.id))}),!1},h=function(a){this.toggleClass("isDrag",!0),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("text",JSON.stringify(k))},j=function(){this.toggleClass("isDrag",!1)},k=this.id,l=function(){if(m.cell.hasClass("toshow")){var a=m.cell.one(".cover");a&&window.innerHeight+u().top>m.cell.offsetTop&&(m.cell.toggleClass("toshow",!1),m.cell.setEvents({"touchmove touchstart":h,touchend:j}),(m.book.alternative||m.book.base64)&&(a.src=m.book.alternative||m.book.base64),m.cell.one("footer").css({bottom:m.cell.one("figcaption").clientHeight+5}))}},m=this;this.cell.alls("header, figure").setEvents("click",f),this.cell.alls("button").setEvents("click",b),this.cell.setEvents({"mouseenter mouseleave":c,"touchmove touchstart":h,touchend:j}),this.cell.one("footer").css({bottom:this.cell.one("figcaption").clientHeight+5}),this.actived=!0,this.destroy=e,this.loadcover=l}},c.prototype.returned=function(a){this.book=a,this.opened=!0,g.data=this,g.show(),i.setDetail(a)},a.setEvents({scroll:d.loadcovers}),a.alls("input").setEvents("input propertychange",e),a.one("#logout").setEvents("click",k),a.alls("#h button, #help").setEvents({click:t.help}),a.one("#formSearch").setEvents("submit",n.books),a.one("#formProfil").setEvents("submit",r.update),a.one("#formRecommand").setEvents("submit",g.sendNotif),a.one("#formTag").setEvents("submit",p.add),a.alls("form").setEvents("submit",function(a){a.preventDefault()}),a.alls("#formNew button").setEvents("click",g.modify),a.one("#changePwd").setEvents("click",t.togglePwd),a.one("#delete").setEvents("click",r["delete"]),a.one("#tris").setEvents("click",l.sort),a.one("#notifications").setEvents("click",l.notif),a.alls("#sort > div").setEvents("click",d.sort),a.alls("[actclick]").setEvents("click",g.action),a.alls(".closeWindow").setEvents("click",t.close),a.one("#footer").setEvents("click",l.top),a.alls("#uploadHidden [type=file]").setEvents("change",g.uploadCover),a.alls("#userNote > img").setEvents({mouseenter:g.mouseNote,mouseleave:g.userNote,click:g.clickNote}),function(a){for(var b=0,c=a.length;c>b;b++)j.blur.call(a[b])}(a.alls("[blur]")),a.alls("img").setAttributes({draggable:!1}),a.one("#collection").setEvents("click",r.collection),a.alls("#tags, #cloud > img").setEvents("click",p.show),a.alls("#recherche, #profil, #contact").setEvents("click",t.open),a.one("#newbook").setEvents("click",g["new"]),a.alls(".tnv, .action").setEvents("click",l.toggle),a.alls("[url]").setEvents("click",l.link),a.alls("[mail]").setEvents("click",l.mail),a.one("#recommand4u").setEvents("click",n.recommand),a.alls("#importNow, #exportNow").setEvents("click",n.gtrans),a.alls("@tag").setEvents("input propertychange",p.list),window.setEvents({resize:h.resize,click:l.close}),a.alls("[nav]").setEvents("click",l.nav),function(b){b?a.one("@filtre").setEvents("search",d.filter):a.one("#formFilter").setEvents("submit",function(b){return d.filter.call(a.one("@filtre")),!1})}("onsearch"in a.createElement("input"))}):alert(document.body.getAttribute("error"));
