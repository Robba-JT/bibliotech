Array.prototype.assign=function(a){return this.push.apply(this,Array.isArray(a)?a:[a]),this},Array.prototype.noSpace=function(){for(var a=0,b=this.length;b>a;a++)"string"==typeof this[a]&&(this[a]=this[a].noSpace());return this},HTMLElement.prototype.closest=function(a){for(var b=this;b&&b.tagName&&"body"!==b.tagName.toLowerCase();){if(b.hasClass(a))return b;b=b.parentNode}return null},HTMLElement.prototype.css=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){_.includes(["width","max-width","height","max-height","top","left","bottom","padding-top"],c)&&-1===a.toString().indexOf("%")&&(a+="px"),b.style[c]=a}),b},HTMLElement.prototype.fade=function(a){a="undefined"==typeof a?!this.isVisible():a;var b=this,c=a?"fadein":"fadeout";return new Promise(function(d){a&&b.toggleClass("notdisplayed",!1),b.setEvents({animationend:function e(f){d(b),b.removeEvent("animationend",e).toggleClass(c,!1),a||b.toggleClass("notdisplayed",!0)}}).toggleClass(c,!0)})},HTMLElement.prototype.formToJson=function(){var a={};return this.querySelectorAll("input, textarea").forEach(function(){(_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.checked||!_.includes(["checkbox","radio"],this.type.toLowerCase())&&this.name)&&(a[this.name]=this.value)}),a},HTMLElement.prototype.hasClass=function(a){return this.classList.contains(a)},HTMLElement.prototype.html=function(a){return"undefined"==typeof a?this.innerHTML:(this.innerHTML=a,this)},HTMLElement.prototype.index=function(){for(var a=this.parentNode.childNodes,b=0,c=a.length;c>b;b++)if(a[b]===this)return b;return-1},HTMLElement.prototype.isVisible=function(){return this.offsetWidth>0&&this.offsetHeight>0},HTMLElement.prototype.newElement=function(a,b){var c=document.createElement(a);return _.isPlainObject(b)&&c.setAttributes(b),this.appendChild(c),c},StyleSheetList.prototype.removeAll=HTMLElement.prototype.removeAll=function(){return this.remove?this.remove():this.parentNode.removeChild(this),this},HTMLElement.prototype.removeAttributes=function(a){var b=this;return"string"==typeof a&&(a=[a]),_.isArray(a)&&a.forEach(function(a){b.removeAttribute(a)}),b},HTMLElement.prototype.removeEvent=function(a,b){return this.removeEventListener(a,b),this},HTMLElement.prototype.setAttributes=function(a){var b=this;return _.isPlainObject(a)&&_.forEach(a,function(a,c){b.setAttribute(c,a)}),b},Window.prototype.setEvents=HTMLDocument.prototype.setEvents=HTMLElement.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(d.addEventListener(a,b,c),d)},HTMLElement.prototype.setValue=function(a){return this.value=a,this},HTMLElement.prototype.siblings=function(a){return this.parentNode.alls(a)},HTMLElement.prototype.text=function(a){return"undefined"==typeof a?this.textContent:(this.textContent=a,this)},HTMLElement.prototype.toLeft=function(a){a="undefined"==typeof a?!this.isVisible():a;var b=this,c=a?"leftin":"leftout";return new Promise(function(d){a&&b.toggleClass("notdisplayed",!1),b.setEvents({animationend:function e(f){d(b),b.removeEvent("animationend",e).toggleClass(c,!1),a||b.toggleClass("notdisplayed",!0)}}).toggleClass(c,!0)})},HTMLElement.prototype.toggle=function(a){return("undefined"==typeof a||null===a)&&(a=!this.isVisible()),this.toggleClass("notdisplayed",!a),this},HTMLElement.prototype.toggleClass=function(a,b){var c=this;a=a.split(" ");var d="toggle";return"undefined"!=typeof b&&(d=b?"add":"remove"),a.forEach(function(a){c.classList[d](a)}),c},HTMLElement.prototype.trigger=function(a){var b;try{b=new Event(a)}catch(c){b=document.createEvent(_.includes(["click","mouseenter","mouseleave","mouseup","mousedown"],a)?"MouseEvents":"HTMLEvents"),b.initEvent(a,!0,!0)}return this.dispatchEvent(b),this},HTMLElement.prototype.xposition=function(){return this.parentNode&&this.parentNode.tagName?this.parentNode.offsetLeft:this.offsetLeft},HTMLDocument.prototype.alls=HTMLCollection.prototype.alls=HTMLElement.prototype.alls=NodeList.prototype.alls=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return[];if(d.multiSelect())a=this.querySelectorAll(b);else switch(c){case"#":a=[document.getElementById(d)];break;case"@":a=document.getElementsByName(d);break;case".":a=this.getElementsByClassName(d);break;default:a=this.getElementsByTagName(b)}return a},HTMLCollection.prototype.css=NodeList.prototype.css=function(a){return this.forEach(function(){this.css(this)}),this},HTMLCollection.prototype.fade=NodeList.prototype.fade=function(a){var b=[];return this.forEach(function(){b.push(this.fade(a))}),Promise.all(b)},HTMLCollection.prototype.forEach=NodeList.prototype.forEach=function(a){return[].forEach.call(this,function(b){a.apply(b)}),this},HTMLCollection.prototype.html=NodeList.prototype.html=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.html(a)}),this)},HTMLDocument.prototype.one=HTMLCollection.prototype.one=HTMLElement.prototype.one=NodeList.prototype.one=function(){var a,b=arguments[0],c=b.substr(0,1),d=b.substr(1,b.length);if(!c||!d)return null;if(d.multiSelect())a=this.querySelector(b);else switch(c){case"#":a=document.getElementById(d);break;case"@":a=document.getElementsByName(d)[0];break;case".":a=this.getElementsByClassName(d)[0];break;default:a=this.getElementsByTagName(b)[0]}return a},HTMLCollection.prototype.removeAll=NodeList.prototype.removeAll=function(){return this.forEach(function(){this.removeAll()}),this},HTMLCollection.prototype.removeAttributes=NodeList.prototype.removeAttributes=function(a){return"string"==typeof attrs&&(a=[a]),this.forEach(function(){this.removeAttributes(a)}),this},HTMLCollection.prototype.removeEvent=NodeList.prototype.removeEvent=function(a,b){return this.forEach(function(){this.removeEvent(a,b)}),this},HTMLCollection.prototype.setAttributes=NodeList.prototype.setAttributes=function(a){return this.forEach(function(){this.setAttributes(a)}),this},HTMLCollection.prototype.setEvents=NodeList.prototype.setEvents=function(a,b,c){var d=this;return _.isPlainObject(a)?(_.forEach(a,function(a,b){d.setEvents(b,a,c)}),d):(a=a.split(" "),d.forEach(function(){var d=this;a.forEach(function(a){d.addEventListener(a,b,c)})}),d)},HTMLCollection.prototype.setValue=NodeList.prototype.setValue=function(a){return this.forEach(function(){this.setValue(a)}),this},HTMLCollection.prototype.text=NodeList.prototype.text=function(a){return"undefined"==typeof a?this:(this.forEach(function(){this.text(a)}),this)},HTMLCollection.prototype.toArray=NodeList.prototype.toArray=function(){return[].slice.apply(this)},HTMLCollection.prototype.toggle=NodeList.prototype.toggle=function(a,b){return this.forEach(function(){this.toggle(a,b)}),this},HTMLCollection.prototype.toggleClass=NodeList.prototype.toggleClass=function(a,b){var c=this;return c.forEach(function(){this.toggleClass(a,b)}),c},HTMLCollection.prototype.trigger=NodeList.prototype.trigger=function(a){return this.forEach(function(){this.trigger(a)}),this},String.prototype.fd=function(){var a=this.substr(0,10).split("-");return 3===a.length&&(a=(1===a[2].length?"0":"")+a[2]+"/"+(1===a[1].length?"0":"")+a[1]+"/"+a[0]),a},String.prototype.multiSelect=function(){return-1!==this.indexOf(" ")||-1!==this.indexOf(",")||-1!==this.indexOf(".")||-1!==this.indexOf("#")||-1!==this.indexOf(":")||-1!==this.indexOf("]")},String.prototype.noAccent=function(){for(var a=[/[\300-\306]/g,/[\340-\346]/g,/[\310-\313]/g,/[\350-\353]/g,/[\314-\317]/g,/[\354-\357]/g,/[\322-\330]/g,/[\362-\370]/g,/[\331-\334]/g,/[\371-\374]/g,/[\321]/g,/[\361]/g,/[\307]/g,/[\347]/g],b=["A","a","E","e","I","i","O","o","U","u","N","n","C","c"],c=this,d=0,e=a.length;e>d;d++)c=c.replace(a[d],b[d]);return c},String.prototype.noSpace=function(){return this.replace(/^\s+/g,"").replace(/\s+$/g,"").replace(/\s{2,}/g," ")},window.FileReader&&window.Promise&&"formNoValidate"in document.createElement("input")?document.setEvents("DOMContentLoaded",function(){"use strict";var a=document,b=new Date,c=function(a,b,c){var d=a[b];a.splice(b,1),a.splice(c,0,d)},d=function(b,c){var d=e.cells.length+("undefined"==typeof c?1:c),f=a.one("#collection").hasClass("active")||-1!==r.get().bookindex(b.id);return this.id=b.id,this.book=b,this.cell=a.one("#tempCell").cloneNode(!0).removeAttributes("id").toggleClass("bookcell",!0),this.cell.one("header").text(b.title),this.cell.one("figcaption").text(b.authors?b.authors.join(", "):""),this.cell.one(".previewable").toggle(!!b.access&&"NONE"!==b.access),this.cell.one(".recommanded").toggle(!!b.from),this.cell.one(".personnal").toggle(_.isEqual(b.id.user,r.get().id)),this.cell.one(".add").toggle(!f),this.cell.one(".remove").toggle(!!f),this.cell.col=d%i.nbcols,this.cell.row=Math.floor(d/i.nbcols),(b.alternative||b.base64)&&(this.cell.one(".cover").src=b.alternative||b.base64),this.active(),this},e={books:[],bytags:function(b){if(a.one("#collection").hasClass("active")){window.scroll(0,0),a.one("#formFilter").reset(),a.alls(".bookcell").toggleClass("tofilter",!1),e.order(b);for(var c=0,d=e.cells.length;d>c;c++){var f=e.cells[c];f.cell.toggleClass("tohide",!_.includes(f.book.tags,b))}e.display()}},cells:[],destroy:function(){if(i.remove(),e.books=[],!a.one("#collection").hasClass("active"))for(var b=0,c=e.cells.length;c>b;b++)e.cells[b].destroy();e.cells=[]},display:function(b,c,d){var f=[c,d];return new Promise(function(g){if(!b&&a.one(".sortBy"))g(e.sort.call(a.one(".sortBy"),f));else{b=b||_.sortBy(e.cells,function(a){return[a.row,a.col]});for(var h=0,j=i.get(),k=0,l=b.length;l>k;k++){var m=(b[k],b[k].cell);d&&m.toggleClass("tohide tofilter",!1),m.hasClass("tohide")||m.hasClass("tofilter")?i.get().one("section.notdisplayed").appendChild(m):(m.toggleClass("toshow",!0),j.one('[colid="'+(c?m.col:h%i.nbcols)+'"]').appendChild(m),h++)}a.one(".window:not(.notdisplayed)")||t.toggle(!1),e.loadcovers(),g(e.cells.length)}})},filter:function(){var b=this.value.toLowerCase().noAccent().noSpace().split(" ").sort(),c=b.length,d=a.one("@last");if(this.checkValidity()&&b!==d.value.split(" ").sort()){d.value=this.value;for(var f=0;c>f;f++)b[f]=b[f].replace(/\+/g," ");for(var g=0,h=e.cells.length;h>g;g++){var i,j=e.cells[g];if(j.cell.toggleClass("tofilter",!1),!_.isEqual(b,[""]))for(i=(j.book.title+" "+(j.book.subtitle?j.book.subtitle:"")+" "+(j.book.authors?j.book.authors.join(", "):"")+" "+j.book.description).toLowerCase().noAccent().noSpace(),f=0;c>f;f++)if(-1===i.indexOf(b[f])){j.cell.toggleClass("tofilter",!0);break}}e.display()}},generate:function(b){return new Promise(function(c){for(var f=[],g=0,h=b.length;h>g;g++)e.one(b[g].id)||-1!==_.findIndex(f,_.matchesProperty("id",b[g].id))||f.push(new d(r.get().book(b[g].id)||b[g],g));e.cells.assign(f),!a.one("#collection").hasClass("active")&&o.last&&(e.books.push(b),e.books=_.flatten(e.books)),c(f)})},loadcovers:function(){for(var a=0,b=e.cells.length;b>a;a++)e.cells[a].loadcover();m.toggleFooter()},one:function(a){return _.find(e.cells,_.matchesProperty("id",a))},order:function(b){var d=_.find(r.get().orders,_.matchesProperty("id",b));if(d&&d.order){a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1));for(var f=0,g=d.order.length;g>f;f++){var h=_.findIndex(e.cells,_.matchesProperty("id",d.order[f]));c(e.cells,h,f)}}return!!d},returned:function(a){e.one(a.id).returned(a)},show:function(a){for(var b,c=_.chunk(a,40),d=function(a){return new Promise(function(b){e.generate(a).then(function(a){e.display(a,!0)}).then(b)})},f=0,g=c.length;g>f;f++)b=b?b.then(d(c[f])):b=d(c[f]);return b},sort:function(){var b=arguments[0]||[];if(window.scroll(0,0),!this.hasClass("active")){var c=this;a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1)),k.hover.call(this).toggleClass("sortBy",!0),e.display(_.sortByOrder(e.cells,["book."+[c.getAttribute("by")]],"desc"!==c.getAttribute("sort")),b[0]||!1,b[1]||!1)}}},f=function(){var b;switch(this.setCustomValidity(""),this.name){case"confirmPwd":b=this.value!==a.one("@newPwd").value;break;case"filtre":b=!!this.value.length&&this.value.length<3;break;case"name":b=this.value.length<4;break;case"newPwd":b=this.value.length<4||this.value.length>12;break;case"pwd":b=this.value.length<4||this.value.length>12;break;case"recommand":b=this.value.toLowerCase()===r.get().id;break;case"searchinput":b=this.value.length<3;break;case"title":b=this.value.length<6}b&&this.setCustomValidity(this.getAttribute("error"))},g=new ColorThief,h={action:function(){var b=h.data.book.id,c=r.get().book(b),d=this.getAttribute("actclick");this.add=function(){if(b)p.emit("addDetail"),a.alls('[actclick="upload"]').toggle(!h.data.book.cover),h.newCell();else{for(var c,d=a.one("#formNew").formToJson(),e=a.alls("#formNew input, #formNew textarea"),f=0,g=e.length;g>f;f++)if(!e[f].reportValidity()){c=!0;break}if(d.authors=d.authors?d.authors.split(","):[],d.authors.noSpace(),c)return!1;t.over(),p.emit("newbook",d)}},this.associated=function(){o.associated(b)},this.close=function(){this.closest("window").fade(!1).then(function(a){delete u.on,t.over(!1),a.one("iframe")&&window.frames.iPreview&&window.frames.iPreview.document.getElementById("viewer")&&(window.frames.iPreview.document.getElementById("viewer").innerHTML="")})},this.google=function(){window.open(this.getAttribute("link"))},this.preview=function(){a.one("@previewid").value=b,t.over(),u.open.call("previewWindow").then(function(b){a.one("#preview").submit()})},this.recommand=function(){t.over(),u.open.call("recommandWindow")},this.update=function(){var d=!1,e={id:b},f=_.map(a.alls("#userTags > div").toArray(),function(a){return a.one(".libelle").text()}),g=a.one("#userNote").value,h=a.one("#userComment").value;if(_.isObject(b)&&b.user===r.get().id){var i=a.one("#formNew").formToJson();i.authors=i.authors.split(",")||[],_.forEach(i,function(a,b){a=a.noSpace(),_.isEqual(c[b],a)||(d=!0,e.update||(e.update={}),e.update[b]=a)})}(g||c.userNote)&&g!==c.userNote&&(d=!0,e.userNote=g),(h||c.userComment)&&h!==c.userComment&&(d=!0,e.userComment=h),(f.length||c.tags&&c.tags.length)&&!_.isEqual(f,c.tags)&&(d="tags",e.tags=f),d&&(e.userDate=(new Date).toJSON(),p.emit("updateBook",e),r.get().updatebook(e),q.init(),a.one("#tags").toggle(!!q.cloud.length&&a.one("#collection").hasClass("active"))),u.close()},this.upload=function(){a.one("#uploadHidden [type=file]").trigger("click")},this[d].call(this)},clickNote:function(){var b=a.one("#userNote"),c=this.getAttribute("note");b.value===c&&"1"===b.value?b.value=0:b.value=c,h.userNote()},data:{},links:function(){var b=this.getAttribute("searchby"),c=this.text();b&&c&&(a.one("#formSearch [type=search]","").value=c,a.alls("#formSearch [name=searchby]")[b].checked=!0,o.books.call(a.one("#formSearch")))},mainColor:function(a){var b=g.getColor(a),c="#"+((1<<24)+(b[0]<<16)+(b[1]<<8)+b[2]).toString(16).substr(1);return{rgb:b,hex:c}},modify:function(){if(this.hasClass("modify")){if(this.hasClass("hide"))for(var a=this.siblings("[name]"),b=0,c=a.length;c>b;b++)a[b].value=a[b].getAttribute("oldvalue");this.toggleClass("hide"),this.siblings("[field]:not(.noValue), [name]").toggle(null);var d=this.siblings("[name]")[0];"textarea"===d.tagName.toLowerCase()&&(d.scrollTop=0)}},mouseNote:function(){var b=a.one("#userNote").value||0,c=this.getAttribute("note"),d=a.alls("[note]").toArray();if(b!==c)for(var e=0;e<Math.max(b,c);e++)e<Math.min(b,c)?d[e].src=images[d[e].getAttribute("select")].black:b>c?d[e].src=images[d[e].getAttribute("hoverminus")].black:d[e].src=images[d[e].getAttribute("hoverplus")].black},"new":function(){h.data.book={},h.show(!1),a.one("#formNew").reset(),a.alls("#formNew input, #formNew textarea, .volumeInfo:not(.nonEditable), .volumeInfo:not(.nonEditable) button").toggle(!0),a.alls("#formNew [field]").toggle(!1)},newCell:function(){a.alls("[actclick=add], [actclick=update], #upload, .inCollection").toggle();var b=e.one(h.data.book.id),c=r.get().addbook(h.data.book);a.one("#collection").hasClass("active")&&!b&&(e.cells.push(c),e.display()),b&&b.cell&&b.cell.alls("button").fade()},sendNotif:function(){var b=this.formToJson();return b.book=h.data.book.id,b.title=h.data.book.title,h.data.book.alt&&(b.alt=h.data.book.alt),p.emit("sendNotif",b),a.one("#recommandWindow .closeWindow").trigger("click"),!1},show:function(b){var c=h.data.book,d=a.one("#detailWindow");a.one("#formNew").reset(),a.one("#formRecommand").reset(),d.alls("#formNew input, #formNew textarea").toggle(!1),d.alls("#formNew button:not(.categories)").toggleClass("hide",!1).toggleClass("modify",!!c.id&&_.isEqual(c.id.user,r.get().id)),a.alls("#comments *").removeAll(),a.one("#userComment").value="";for(var e=0,f=a.alls("[note]").length;f>e;e++)k.blur.call(a.alls("[note]")[e]);a.one("#userNote").value=c.note,d.alls(".inCollection").toggle(!!b).css({background:"whitesmoke"}),q.list(),a.one("#background").toggle(!!c.alternative||!!c.base64),(c.alternative||c.base64)&&a.one("#background").css({"background-image":"url("+(c.alternative||c.base64).toString()+")"}),d.alls(".direct").text(""),d.alls("#userTags > div").removeAll(),a.alls("[actclick=add]").toggle(!b),a.alls("[actclick=update], [actclick=recommand]").toggle(!!b),a.alls("[actclick=associated]").toggle(!!c.id&&!_.isObject(c.id)),a.alls("[actclick=preview]").toggle(!!c.access&&"NONE"!==c.access),a.alls("[actclick=google]").setAttributes({link:c.link}).toggle(!!c.link),a.alls("[actclick=upload]").toggle(!c.base64&&!c.cover&&!!b),d.alls(".comments").toggle(!!c.comments&&!!c.comments.length),d.alls("#detailWindow [field]").toggleClass("noValue",!1),d.alls("[field=authors] span").removeAll(),d.alls(".volumeInfo.nonEditable").toggle(!1),d.alls(".volumeInfo:not(.nonEditable)").toggle(!!c.id&&_.isEqual(c.id.user,r.get().id)),h.userNote(),d.hasClass("notdisplayed")&&u.open.call("detailWindow").then(function(){a.one("#detailContent").css({height:d.clientHeight-d.one("header").clientHeight}),a.one(".detailBook").scrollTop=0,a.alls(".new").toggleClass("new",!1)}),_.forEach(c,function(b,e){var f=d.one("[field="+e+"]"),g=d.one("input[name="+e+"], textarea[name="+e+"]");switch(f&&"subtitle"!==e&&(f.closest("volumeInfo").toggle(!!b||_.isEqual(c.id.user,r.get().id)),f.toggle(!!b).toggleClass("noValue",!b)),e){case"authors":for(var i=0,j=b.length;j>i;i++)f.newElement("span",{"class":"link",searchby:3}).text(b[i]);g.value=b.join(", "),g.setAttribute("oldvalue",b.join(", ")),f.parentNode.alls("button").toggle(!!b.length);break;case"tags":for(var k=a.one("#userTags"),l=0,m=b.length;m>l;l++)k.appendChild(q["new"](b[l]));break;case"userNote":b&&h.clickNote.call(a.one('[note="'+b+'"]'));break;case"userComment":a.one("#userComment").value=b;break;case"comments":var n,o=0;b.length||d.one(".comments").toggle(!1);for(var p=0,s=b.length;s>p;p++){if(b[p].comment){var t=a.one("#tempComment").cloneNode(!0);t.removeAttribute("id"),t.one(".commentAuthor").text(b[p].name),t.one(".commentDate").text(b[p].date.fd()),t.one(".commentNote").text(b[p].note),t.one(".commentComment").html(b[p].comment),a.one("#comments").appendChild(t)}b[p].note&&(n=(n||0)+parseInt(b[p].note,10),o++)}"undefined"!=typeof n&&o&&(n=(n/o).toFixed(2),a.one(".subtitle").toggle(!0),a.one("#mNote").text(n));break;default:if(!f)break;_.isArray(b)&&(b=b.join(", ")),g&&(g.setAttribute("oldvalue",b),g.value=b,g.scrollTop=0),"time"===f.tagName.toLowerCase()&&(f.setAttribute("datetime",new Date(b)),b=b.fd()),"description"===e?f.html(b):f.text(b)}}),a.alls(".link").setEvents("click",h.links,!1)},uploadCover:function(){var b=this.files;if(b[0]){if(!b[0].type.match(/image.*/)||b[0].size>5e5)return u.confirm("error",'Veuillez sélectionner un fichier de type "image" inférieure à 500KB.'),!1;var c=new FileReader;c.onload=function(b){return function(c){b.onload=function(){var b=h.mainColor(this);this.toggleClass("new",!0).setAttribute("mainColor",b.hex),a.one("#detailContent").css("background","radial-gradient(whitesmoke 40%, "+b.hex+")")},b.src=c.target.result}}(a.one("#detailCover")),c.readAsDataURL(this.files[0])}},userNote:function(){for(var b=a.alls("[note]").toArray(),c=a.one("#userNote").value,d=0;d<b.length;d++)c>d?b[d].src=images[b[d].getAttribute("select")].black:b[d].src=images[b[d].getAttribute("source")].black}},i={get:function(){var b,c=a.one("#d");if(c||(c=a.body.newElement("section",{id:"d",role:"main"}),c.newElement("section",{"class":"notdisplayed"})),b=(c.clientWidth/i.nbcols).toFixed(0),c.alls(".col").length!==i.nbcols){c.alls(".col").removeAll();for(var d=0;d<i.nbcols;d++)c.newElement("div",{"class":"col",colid:d}).css({width:b,"max-width":b});a.alls(".col").setEvents({dragenter:function(a){a.preventDefault()},dragover:function(a){a.preventDefault()},drop:function(b){b.preventDefault();var c=e.one(JSON.parse(b.dataTransfer.getData("text"))).cell,d=b.target.closest("bookcell");return d?c!==d&&(d.closest("col").insertBefore(c,d),e.loadcovers(),a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))):(this.appendChild(c),a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))),!1}})}return c},nbcols:~~(window.innerWidth/192),remove:function(){a.one("#d")&&(a.one("#d").removeAll(),window.scroll(0,0))},resize:function(){i.nbcols!==~~(window.innerWidth/192)?(q.close().then(q.destroy),a.alls(".deroulant").fade(!1),i.nbcols=~~(window.innerWidth/192),i.remove(),e.display()):a.alls(".col").css({width:~~(window.innerWidth/i.nbcols),"max-width":~~(window.innerWidth/i.nbcols)}),a.one("#detailWindow").isVisible()&&(a.one("#detailWindow").css({height:window.innerHeight,top:0}),a.one("#detailContent").css({height:window.innerHeight-a.one("#detailWindow header").clientHeight}))}},j={deleteDetail:function(a){j.db&&j.db.transaction(["details"],"readwrite").objectStore("details")["delete"](a)},deleteQuery:function(a){j.db&&j.db.transaction(["queries"],"readwrite").objectStore("queries")["delete"](a)},getDetail:function(a){return new Promise(function(b){j.db||b();var c=j.db.transaction(["details"],"readwrite").objectStore("details").index("by_id").get(a);c.onsuccess=function(){this.result?b(this.result):b()},c.onerror=function(){b()}})},getQuery:function(a){return new Promise(function(b,c){j.db||c();var d=j.db.transaction(["queries"],"readwrite").objectStore("queries").index("by_query").get(JSON.stringify(a));d.onsuccess=function(){this.result&&this.result.books&&this.result.books.length?b(this.result.books):c()},d.onerror=c})},init:function(){return j.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,new Promise(function(a,b){if(j.indexedDB){var c=indexedDB.open(r.get().session,1);c.onerror=function(){b()},c.onsuccess=function(){j.db=this.result,a()},c.onupgradeneeded=function(){var a=this.result;a.createObjectStore("queries",{keyPath:"query"}).createIndex("by_query","query",{unique:!0}),a.createObjectStore("details",{keyPath:"id"}).createIndex("by_id","id",{unique:!0})}}})},setDetail:function(a){if(j.db){j.db.transaction(["details"],"readwrite").objectStore("details").put(a)}},setQuery:function(a,b){if(j.db){j.db.transaction(["queries"],"readwrite").objectStore("queries").put({query:JSON.stringify(a),books:b})}}},k={active:function(){var b=a.one(".active"),c=this.one("img");return b&&(b.toggleClass("active",!1),k.blur.call(b)),this.toggleClass("active",!0),a.one("#tags").toggle("collection"===this.id&&!!q.cloud&&!!q.cloud.length),c&&(c.src=images[c.getAttribute("source")][c.getAttribute("active")]),this},blur:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("blur")],a.isVisible()||a.hasClass("nsv")||a.css({visibility:"visible"})),this)},hover:function(){var a="img"===this.tagName.toLowerCase()?this:this.one("img");return this.hasClass("active")||this.hasClass("sortBy")?!1:(a&&(a.src=images[a.getAttribute("source")][a.getAttribute("hover")]),this)}},l=function(){return t.toggle(!0),r.destroy(),j.indexedDB&&j.indexedDB.deleteDatabase(r.get().session),p.destroy(),location.assign("/logout"),!1},m={close:function(b){var c=b.target.closest("action");(c||b.target&&b.target.getAttribute("by"))&&(!c||_.includes(["notifications","tris"],c.getAttribute("id")))||a.alls(".deroulant").fade(!1)},link:function(){window.open(this.getAttribute("url"))},mail:function(){a.location.href="mailto:"+this.getAttribute("mail")},notif:function(b){var c=a.one("#notifs");c.fade(!c.isVisible())},selectstart:function(a){return a.preventDefault(),a.target.tagName&&!_.includes(["input","textarea"],a.target.tagName.toLowerCase())?!1:void 0},show:function(){k.hover.call(a.one("#sort img")),a.alls("#tags, #notifications").toggle(!1)},sort:function(b){var c=a.one("#sort");c.fade(!c.isVisible())},toggle:function(){a.one("#nvb").toLeft(a.one(".nvb:not(#nvb)").isVisible()),a.one(".nvb:not(#nvb)").fade()},toggleFooter:function(){a.one("#footer").toggle(!!v().top)},top:function(){var a=setInterval(function(){var b=(v().top/2-.1).toFixed(1);window.scroll(0,b),.1>=b&&(window.scroll(0,0),clearInterval(a))},100)}},n={click:function(){var b=JSON.parse(this.getAttribute("notif"));b._id.book;_.remove(n.list,b),n.last=b,a.one("#notifs").toggle(),this.removeAll(),a.alls("#notifications, #notifNumber").toggle(!!n.list.length),a.one("#notifNumber").text(n.list.length),t.toggle(!0,!0),p.emit("readNotif",b)},show:function(b){b&&(n.list=b),a.alls("#notifications, #notifNumber").toggle(!!n.list.length),a.one("#notifNumber").text(n.list.length);for(var c=0,d=n.list.length;d>c;c++){var e=n.list[c],f=a.one("#tempNotif").cloneNode(!0);f.setAttributes({notif:JSON.stringify(e)}).removeAttribute("id"),f.one(".notifName").html(e.from),f.one(".notifTitle").text(e.title),f.setEvents("click",n.click),a.one("#notifs").appendChild(f)}}},o={associated:function(b){o.clear(),o.last={associated:b},u.close(!0).then(function(){t.toggle(!0,!0),j.getQuery(o.last).then(e.show,function(){a.one("#nvb").toggleClass("inactive",!0),t.anim(!0),p.emit("associated",b)})["catch"](function(a){})})},books:function(){var b=this.formToJson();return o.last={q:b.searchby+b.searchinput,langRestrict:b.langage},a.one("@filtre").value=a.one("@last").value="",o.clear(),u.close(!0).then(function(){t.toggle(!0,!0),j.getQuery(o.last).then(e.show)["catch"](function(){a.one("#nvb").toggleClass("inactive",!0),t.anim(!0),p.emit("searchBooks",o.last)})}),!1},clear:function(){e.destroy(),i.remove(),k.active.call(a.one("#recherche")),a.one("#formFilter").reset(),a.one(".sortBy")&&k.blur.call(a.one(".sortBy").toggleClass("sortBy",!1))},endRequest:function(b){a.one("#nvb").toggleClass("inactive",!1),t.anim(!1),b||t.toggle(!1),!a.one("#collection").hasClass("active")&&o.last&&j.setQuery(o.last,e.books)},gtrans:function(){var b=this.id;u.confirm("warning","Cette opération va importer/exporter vos EBooks depuis/vers votre bibliothèque Google.<BR>Etes vous sur de vouloir continuer?").then(function(){return"exportNow"===b?p.emit("exportNow"):(e.destroy(),k.active.call(a.one("#collection")),a.one("#nvb").toggleClass("inactive",!0),t.anim(!0),void u.close(!0).then(function(){t.toggle(!0,!0),p.emit("importNow")}))})},recommand:function(){o.clear(),o.last={recommand:r.get().id},u.close(!0).then(function(){t.toggle(!0,!0),j.getQuery(o.last).then(e.show)["catch"](function(){a.one("#nvb").toggleClass("inactive",!0),t.anim(!0),p.emit("recommanded")})})}},p=function(c){var d=function(){var d=c.connect("/",{secure:!0,multiplex:!1});return d.once("connect",function(){b=new Date,this.once("disconnect",function(b){f(this),r.destroy(),u.close().then(function(){t.toggle(!0,!0),t.connection(!0),a.alls(".deroulant").toggle(!1),a.one("#picture *")&&a.alls("#picture *").removeAll(),a.alls("#notifications, #tags").toggle(!1),k.blur.call(a.one(".active").toggleClass("active",!1));for(var b=a.alls("form"),c=0,d=b.length;d>c;c++)b[c].reset();e.destroy()})}).on("books",e.show).on("initCollect",function(a){r.get().collection.assign(a),s.initCollect(a)}).on("endCollect",function(b){r.get().collection.assign(b.books),s.initCollect(b.books).then(function(){r.get().collection=e.cells,q.init(),n.show(b.notifs),o.endRequest(e.cells.length),a.one("#nbBooks").text(r.get().collection.length)})}).on("covers",function(b){for(var c=0,d=b.length;d>c;c++)if(b[c]&&b[c].id&&(b[c].base64||b[c].alternative)){var e=b[c],f=r.get().bookcell(e.id);f&&(f.book?(e.base64&&(f.book.base64=e.base64),e.alternative&&(f.book.alternative=e.alternative),f.cell&&(f.cell.hasClass("toshow")||(f.cell.one(".cover").src=e.base64||e.alternative),h.data.book&&h.data.book.id===e.id&&a.one("#background").toggle().css({"background-image":"url("+(e.base64||e.alternative).toString()+")"}))):(e.base64&&(f.base64=e.base64),e.alternative&&(f.alternative=e.alternative)))}}).on("endRequest",o.endRequest).on("error",function(a){}).on("logout",l).on("newbook",function(a){h.bookid=a.id,h.data={book:a},h.newCell(),h.show(!0),t.over(!1)}).on("returnAdd",s.addbook).on("returnDetail",e.returned).on("returnNotif",function(a){h.bookid=a.id,h.data={book:a},h.show(-1!==r.get().bookindex(a.id))}).on("updateNok",s.nokdated).on("updateOk",s.updated).on("user",function(a){m.show(),r.get().init(a),j.db||j.init(),t.toggle(!1)}).emit("isConnected")}),d},f=function(a){a.destroy();var b=setInterval(function(){a&&a.connected&&"open"===a.io.readyState&&(clearInterval(b),p=d());try{a.connect()}catch(c){}},3e3)};return d()}(io),q={add:function(){var b=this.formToJson().tag.toLowerCase(),c=a.alls("#userTags > div").toArray(),d=_.find(c,function(a){return a.one(".libelle").html()===b});if(!d){c.push(q["new"](b,!0)),c=_.sortBy(c,function(a){return a.one(".libelle").text()});for(var e=0,f=c.length;f>e;e++)a.one("#userTags").appendChild(c[e])}return this.reset(),!1},close:function(){return new Promise(function(b){a.one("#cloud").isVisible()?q.show().then(b):(t.over(!1),b())})},destroy:function(){a.alls("#cloud span").removeAll()},generate:function(){var b=a.one("#cloud"),c=function(){q.show(),e.bytags(this.text()),t.toggle(!1)},d=~~(b.clientHeight/2),f=~~(b.clientWidth/2),g=f/d,h=3,i=[],j=function(a,b){for(var c=function(a,b){return Math.abs(2*a.offsetLeft+a.offsetWidth-2*b.offsetLeft-b.offsetWidth)<a.offsetWidth+b.offsetWidth&&Math.abs(2*a.offsetTop+a.offsetHeight-2*b.offsetTop-b.offsetHeight)<a.offsetHeight+b.offsetHeight},d=0,e=b.length;e>d;d++)if(c(a,b[d]))return!0;return!1};q.destroy();for(var k=0,l=q.cloud.length;l>k;k++){var m=q.cloud[k],n=b.newElement("span",{"class":"tag tag"+Math.min(~~(m.weight/5)+1,10)}).html(m.text),o=d-n.clientHeight/2,p=f-n.clientWidth/2,r=0,s=6.28*Math.random();for(n.css({top:o,left:p});j(n,i);)r+=h,s+=(k%2===0?1:-1)*h,o=d+r*Math.sin(s)-n.clientHeight/2,p=f-n.clientWidth/2+r*Math.cos(s)*g,n.css({top:o,left:p});i.push(n)}b.alls("span").setEvents("click",c)},init:function(){var b=_.countBy(_.flatten(_.compact(_.pluck(r.get().collection,"book.tags")),!0).sort());if(q.cloud=[],q.destroy(),b){var c="";_.forEach(b,function(a,b){q.cloud.push({text:b,weight:a}),c+="<option>"+b+"</option>"}),a.one("#tagsList").html(c),q.cloud=_.sortBy(q.cloud,"weight").reverse(),a.one("#collection").hasClass("active")&&a.one("#tags").toggle(!_.isEmpty(b))}},list:function(){a.one("@tag").setAttributes({list:this.value?"tagsList":"none"})},"new":function(b,c){var d=a.one("#tempTag").cloneNode(!0);return d.removeAttribute("id"),d.setEvents("click",function(a){a.target.hasClass("libelle")?u.close().then(e.bytags(a.target.text())):this.fade(!1).then(function(){d.removeAll()})}),d.one(".libelle").html(b).toggleClass("new",!!c),d},show:function(){var b=a.one("#cloud"),c=b.isVisible();return new Promise(function(d){a.one("#wa").isVisible()||!a.one("#collection").hasClass("active")?d():u.close().then(function(){a.alls("html, body").toggleClass("overflown",!c),c?b.fade(!1).then(d):b.fade(!0).then(function(){b.alls("span").length||q.generate(),d()})})})}},r=function(){var b,c=function(){};return c.prototype.init=function(c){return _.assign(this,c),this.collection=[],this.picture&&this.link&&(a.one("#picture").setEvents("click",function(){
window.open(b.link)}).toggle(!0).newElement("img",{src:this.picture,title:"Google+"}),a.one("#picture").newElement("span").html(this.name),a.one("#picture").newElement("hr")),a.alls(".gSignIn").toggle(!!this.googleSignIn),a.alls(".noSignIn").toggle(!this.googleSignIn),a.one(".noSignIn input").setAttributes("required",!this.googleSignIn),this.connex||u.help(!0),this},c.prototype.addbook=function(b){var c=e.one(b.id)||new d(b);return this.collection.push(c),c.cell.one(".add").toggle(!1),c.cell.one(".remove").toggle(!0),a.one("#nbBooks").text(this.collection.length),c.cell.isVisible()&&(c.book=b,b.base64&&(c.cell.one(".cover").src=b.base64)),c},c.prototype.bookcell=function(a){return _.find(this.collection,_.matchesProperty("book.id",a))},c.prototype.book=function(a){var b=this.bookcell(a);return b&&b.book?b.book:null},c.prototype.bookindex=function(a){return _.findIndex(this.collection,_.matchesProperty("id",a))},c.prototype.removebook=function(b){_.remove(this.collection,_.matchesProperty("id",b)),a.one("#nbBooks").text(this.collection.length)},c.prototype.updated=function(a){this.name=a.name,this.googleSync=a.googleSync,u.close()},c.prototype.updatebook=function(a){_.assign(a,a.update),delete a.update;var b=this.bookcell(a.id);_.assign(b.book,a),a.title&&b.cell.one("header").text(a.title),a.authors&&b.cell.one("figcaption").text(a.authors.join(", ")),a.alternative&&(b.cell.one(".cover").src=a.alternative)},{get:function(){return b||(b=new c),b},destroy:function(){b=!1}}}(),s={addbook:function(a){return r.get().addbook(a)},initCollect:function(b){return a.one("#collection").hasClass("active")||k.active.call(a.one("#collection").toggleClass("active",!0)),new Promise(function(a){t.anim(!0),e.show(b).then(a)})},collection:function(b){return new Promise(function(b){if(u.close(),a.one("@filtre").value=a.one("@last").value="",a.one("#collection").hasClass("active"))window.scroll(0,0),a.alls(".bookcell").toggleClass("tofilter tohide",!1),a.one("#sort [by]").trigger("click"),b();else{var c=a.one(".sortBy");c&&k.blur.call(c.toggleClass("sortBy",!1)),k.hover.call(a.one("#sort div")).toggleClass("sortBy",!0),e.destroy(),t.anim(!0),t.toggle(!0,!0),a.one("#nvb").toggleClass("inactive",!0),k.active.call(a.one("#collection")),e.cells=r.get().collection,e.display(!1,!1,!0).then(function(a){o.endRequest(a),b()})}})},"delete":function(){return a.one("#errPwd").toggle(!1),a.one("@pwd").reportValidity()?(u.confirm("warning",a.one("#delete").getAttribute("confirm")).then(function(){p.emit("deleteUser",a.one("@pwd").value)}),!1):void 0},nokdated:function(){return a.one("#errPwd").toggle(!0),!1},update:function(){return a.one("#errPwd").fade(!1),p.emit("updateUser",this.formToJson()),!1}},t={anim:function(b){a.one("#wa").isVisible!==b&&a.one("#wa").fade(b)},over:function(b){a.one("#w").toggleClass("over",b)},toggle:function(b,c){var d=a.one("#w");d.one("img").toggle(!!c),d.isVisible()!==b&&(b?(a.one("html").toggleClass("overflown",!0),d.toggle(!0)):(d.toggle(!1),a.one("html").toggleClass("overflown",!1),t.over(!1),t.connection(!1)))},connection:function(b){var c=a.one("#noConnect"),d=function(a){c.css({top:c.clientHeight+a.clientY>window.innerHeight?a.clientY-c.clientHeight:a.clientY,left:c.clientWidth+a.clientX>window.innerWidth?a.clientX-c.clientWidth:a.clientX})};b?a.setEvents({mousemove:d}):a.removeEventListener("mousemove",d),c.toggle(b)}},u={close:function(b){return new Promise(function(c){var d,e=a.alls("form:not(#formFilter)");if(a.one("#recommandWindow:not(.notdisplayed)")?(d=a.one("#recommandWindow:not(.notdisplayed)"),b=!0):d=a.alls(".window:not(.notdisplayed)"),t.over(!1),d){d.fade(!1).then(function(){delete u.on,c()});for(var f=0,g=e.length;g>f;f++)e[f].reset();b!==!0&&t.toggle()}else c()})},confirm:function(b,c){return new Promise(function(d,e){t.over(),a.one("#confirmWindow header span").text(a.one("#confirmWindow header span").getAttribute(b)),a.one("#confirmWindow #confirm").text(c),a.one("#confirmWindow .valid").setEvents("click",function(){d()}),a.one("#confirmWindow .cancel").toggle("warning"===b).setEvents("click",function(){e()}),t.toggle(!0),a.one("#confirmWindow").css({top:v().top+10,left:"25%"}).fade(!0),a.setEvents({"keyup keydown":Window.esc})})},open:function(){var b=this;return new Promise(function(c,d){var e="string"==typeof b?b:b.getAttribute("window"),f=a.one("#"+e);u.on&&u.on===e?u.close().then(c):q.close().then(function(){_.includes(["previewWindow","recommandWindow"],e)?t.over(!0):a.alls(".window:not(.notdisplayed)").fade(!1),"profileWindow"===e&&(a.one("@mail").value=r.get().id,a.one("@name").value=r.get().name,r.get().googleSignIn?(a.one("@googleSignIn").setAttribute("checked",!0),r.get().googleSync&&a.one("@googleSync").setAttribute("checked",!0)):a.one("@pwd").setAttribute("required",!0),a.one(".changePwd.notdisplayed")||u.togglePwd()),a.alls(".errMsg").toggle(!1),t.toggle(!0),u.on=e,f.css({top:v().top}).fade(!0).then(function(){c()})})})},togglePwd:function(){a.alls(".changePwd").fade().then(function(a){for(var b=0,c=a.length;c>b;b++)a[b].alls("[type=password]").setAttributes({required:a[b].isVisible()})})}},v=function(){return{top:window.scrollY||a.documentElement.scrollTop,left:window.scrollX||a.documentElement.scrollLeft}};d.prototype.active=function(){if(!this.actived){var b=function(){var b=this.classList;l.cell.alls("button").fade(),_.includes(b,"add")&&p.emit("addBook",l.id),_.includes(b,"remove")&&(a.one("#collection").hasClass("active")&&l.cell.fade().then(function(){l.cell.removeAll(),e.loadcovers()}),p.emit("removeBook",l.id),r.get().removebook(l.id),l.book.tags&&l.book.tags.length&&q.init())},c=function(){l.cell.alls("button").removeEvent("click",b),l.cell.alls("header, figure").removeEvent("click",d),l.cell.removeEvent("dragstart",f).removeEvent("dragend",g).removeAll()},d=function(){return-1!==r.get().bookindex(l.id)||l.opened?(h.data=l,h.show(-1!==r.get().bookindex(l.id))):j.getDetail(l.id).then(function(a){a?(h.data.book=a,h.show(!1)):(t.toggle(!0,!0),p.emit("searchDetail",l.id))}),!1},f=function(a){this.toggleClass("isDrag",!0),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",a.dataTransfer.setData("text",JSON.stringify(i))},g=function(){this.toggleClass("isDrag",!1)},i=this.id,k=function(){if(l.cell.hasClass("toshow")){var a=l.cell.one(".cover");a&&window.innerHeight+v().top>l.cell.offsetTop&&(l.cell.toggleClass("toshow",!1),l.cell.setEvents({"touchmove touchstart":f,touchend:g}),(l.book.alternative||l.book.base64)&&(a.src=l.book.alternative||l.book.base64),l.cell.one("footer").css({bottom:l.cell.one("figcaption").clientHeight+5}))}},l=this;this.cell.alls("header, figure").setEvents("click",d),this.cell.alls("button").setEvents("click",b),this.cell.setEvents({"touchmove touchstart":f,touchend:g}),this.cell.one("footer").css({bottom:this.cell.one("figcaption").clientHeight+5}),this.actived=!0,this.destroy=c,this.loadcover=k}},d.prototype.returned=function(a){this.book=a,this.opened=!0,h.data=this,h.show(),j.setDetail(a)},a.setEvents({scroll:e.loadcovers}),a.alls("input").setEvents("input propertychange",f),a.one("#logout").setEvents("click",l),a.alls("#h button, #help").setEvents({click:u.help}),a.one("#formSearch").setEvents("submit",o.books),a.one("#formProfil").setEvents("submit",s.update),a.one("#formRecommand").setEvents("submit",h.sendNotif),a.one("#formTag").setEvents("submit",q.add),a.alls("form").setEvents("submit",function(a){a.preventDefault()}),a.alls("#formNew button").setEvents("click",h.modify),a.one("#changePwd").setEvents("click",u.togglePwd),a.one("#delete").setEvents("click",s["delete"]),a.one("#tris").setEvents("click",m.sort),a.one("#notifications").setEvents("click",m.notif),a.alls("#sort > div").setEvents("click",e.sort),a.alls("[actclick]").setEvents("click",h.action),a.alls(".closeWindow").setEvents("click",u.close),a.one("#footer").setEvents("click",m.top),a.alls("#uploadHidden [type=file]").setEvents("change",h.uploadCover),a.alls("#userNote > img").setEvents({mouseenter:h.mouseNote,mouseleave:h.userNote,click:h.clickNote}),function(a){for(var b=0,c=a.length;c>b;b++)k.blur.call(a[b])}(a.alls("[blur]")),a.alls("img").setAttributes({draggable:!1}),a.one("#collection").setEvents("click",s.collection),a.alls("#tags, #cloud > img").setEvents("click",q.show),a.alls("#recherche, #profil, #contact").setEvents("click",u.open),a.one("#newbook").setEvents("click",h["new"]),a.alls(".tnv, .action").setEvents("click",m.toggle),a.alls("[url]").setEvents("click",m.link),a.alls("[mail]").setEvents("click",m.mail),a.one("#recommand4u").setEvents("click",o.recommand),a.alls("#importNow, #exportNow").setEvents("click",o.gtrans),a.alls("@tag").setEvents("input propertychange",q.list),window.setEvents({resize:i.resize,click:m.close}),a.alls("[nav]").setEvents("click",m.nav),function(b){b?a.one("@filtre").setEvents("search",e.filter):a.one("#formFilter").setEvents("submit",function(b){return e.filter.call(a.one("@filtre")),!1})}("onsearch"in a.createElement("input"))}):alert(document.body.getAttribute("error"));
